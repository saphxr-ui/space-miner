<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Space Miner â€“ Idle Clicker</title>
  <style>
    :root{
      --bg:#070a14; --txt:#eaf0ff; --muted:#9fb0d7;
      --acc:#66a3ff; --acc2:#7c5cff; --good:#32d583; --warn:#ffcc66; --danger:#ff5a6f;
      --panelA: rgba(255,255,255,.07);
      --panelB: rgba(255,255,255,.03);
      --line: rgba(255,255,255,.10);
      --soft: rgba(255,255,255,.06);
      --soft2: rgba(0,0,0,.18);
      --glow: rgba(102,163,255,.18);
      --glow2: rgba(124,92,255,.14);
    }

    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;}
    body{
      margin:0; color:var(--txt);
      background:
        radial-gradient(1200px 800px at 50% -240px, rgba(102,163,255,.24) 0%, rgba(124,92,255,.12) 35%, rgba(0,0,0,0) 60%),
        radial-gradient(900px 500px at 80% 10%, rgba(50,213,131,.10) 0%, rgba(0,0,0,0) 60%),
        var(--bg);
      overflow-x:hidden;
    }
    body:before{
      content:""; position:fixed; inset:0; pointer-events:none; opacity:.25; filter: blur(.2px);
      background-image:
        radial-gradient(circle at 20% 15%, rgba(255,255,255,.9) 0 1px, transparent 2px),
        radial-gradient(circle at 70% 25%, rgba(255,255,255,.7) 0 1px, transparent 2px),
        radial-gradient(circle at 35% 55%, rgba(255,255,255,.6) 0 1px, transparent 2px),
        radial-gradient(circle at 85% 70%, rgba(255,255,255,.8) 0 1px, transparent 2px),
        radial-gradient(circle at 10% 80%, rgba(255,255,255,.6) 0 1px, transparent 2px);
    }

    .wrap{max-width:1100px;margin:0 auto;padding:16px;}
    .top{display:flex;gap:12px;flex-wrap:wrap;align-items:stretch;}
    .card{
      background:linear-gradient(180deg, var(--panelA), var(--panelB));
      border:1px solid var(--line);
      border-radius:16px; padding:14px;
      box-shadow:0 16px 44px rgba(0,0,0,.35);
      position:relative; overflow:hidden;
    }
    .card:after{content:"";position:absolute;inset:-1px;pointer-events:none;
      background:radial-gradient(420px 240px at 20% 0%, var(--glow) 0%, transparent 55%);
    }
    .stats{flex:1;min-width:320px;}
    .shop{flex:1.25;min-width:380px;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .big{font-size:34px;font-weight:900;letter-spacing:.2px;}
    .muted{color:var(--muted);font-size:13px;}
    .pill{
      display:inline-flex;gap:8px;align-items:center;
      padding:6px 10px;border-radius:999px;
      background:rgba(102,163,255,.12);
      border:1px solid rgba(102,163,255,.22);
      font-size:12px;
    }
    .bar{height:10px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden;border:1px solid rgba(255,255,255,.06);}
    .bar>div{height:100%;width:0;background:linear-gradient(90deg, var(--acc), #2bd4ff, var(--acc2));transition:width .18s;filter:saturate(1.1);}

    .btn{
      cursor:pointer;user-select:none;border:0;border-radius:14px;
      padding:12px 14px;font-weight:900;color:white;
      background:linear-gradient(180deg, var(--acc2), #4d7bff);
      box-shadow:0 12px 26px rgba(102,163,255,.22);
      transition:transform .05s, filter .15s, opacity .15s;
    }
    .btn:active{transform:translateY(1px) scale(.99);filter:brightness(.95);}
    .btn.secondary{background:rgba(255,255,255,.08);box-shadow:none;border:1px solid rgba(255,255,255,.12);font-weight:800;}
    .btn.good{background:linear-gradient(180deg, var(--good), #17b26a);box-shadow:0 12px 26px rgba(50,213,131,.18);color:#052012;}
    .btn.warn{background:linear-gradient(180deg, var(--warn), #ff9f1a);box-shadow:0 12px 26px rgba(255,204,102,.16);color:#1f1600;}
    .btn:disabled{opacity:.45; cursor:not-allowed; transform:none !important; box-shadow:none;}

    .panel{margin-top:10px;background:rgba(0,0,0,.14);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:10px;}

    .clickArea{
      margin-top:12px; display:flex;align-items:center;justify-content:center;
      height:244px;border-radius:16px;
      background:
        radial-gradient(220px 170px at 52% 46%, rgba(102,163,255,.26), rgba(255,255,255,.03)),
        radial-gradient(380px 220px at 70% 10%, rgba(124,92,255,.14), transparent 60%);
      border:1px solid rgba(255,255,255,.10);
      position:relative;overflow:hidden;
    }
    .scanlines{position:absolute;inset:0;background:linear-gradient(180deg, rgba(255,255,255,.04), transparent 60%);opacity:.22;mix-blend-mode:screen;pointer-events:none;}

    .asteroidStage{position:relative;width:220px;height:220px;display:flex;align-items:center;justify-content:center;}
    .asteroidWrap{position:relative;width:140px;height:140px;}
    .asteroid{
      width:140px;height:140px;border-radius:50%;
      background:
        radial-gradient(circle at 30% 28%, rgba(255,255,255,.95) 0 8px, transparent 10px),
        radial-gradient(circle at 40% 35%, #b9c7dd 0%, #7f93b2 18%, #4a5a74 52%, #2a3143 78%, #141a28 100%);
      box-shadow:0 0 0 10px rgba(102,163,255,.08), 0 34px 70px rgba(0,0,0,.42);
      transition:transform .06s, filter .18s;
      position:relative;overflow:hidden;will-change: transform, filter;
    }
    .cracks{position:absolute;inset:0;border-radius:50%;
      background:
        radial-gradient(60px 40px at 65% 42%, rgba(102,163,255,.24) 0%, transparent 70%),
        radial-gradient(70px 50px at 35% 65%, rgba(255,204,102,.18) 0%, transparent 72%);
      opacity:.9;pointer-events:none;transition: filter .18s;
    }
    .ring{position:absolute;inset:-18px;border-radius:50%;border:2px solid rgba(102,163,255,.16);
      filter:drop-shadow(0 0 14px rgba(102,163,255,.10));animation:ring 5.5s linear infinite;pointer-events:none;}
    @keyframes ring { from{transform:rotate(0deg);} to{transform:rotate(360deg);} }
    .orbitRing{position:absolute;inset:0;border-radius:50%;border:1px solid rgba(255,255,255,.10);opacity:.55;pointer-events:none;filter:drop-shadow(0 0 12px rgba(102,163,255,.08));}
    .orbitRing.r2{inset:18px;opacity:.40;}
    .orbitRing.r3{inset:36px;opacity:.30;}

    .shake{animation:shake .18s ease-in-out 0s 1;}
    @keyframes shake{
      0%{transform:translate(0,0) rotate(0deg);}
      20%{transform:translate(-2px,1px) rotate(-.7deg);}
      50%{transform:translate(2px,-1px) rotate(.7deg);}
      80%{transform:translate(-1px,-1px) rotate(-.4deg);}
      100%{transform:translate(0,0) rotate(0deg);}
    }

    .laser{position:absolute;width:200px;height:2px;background:linear-gradient(90deg, transparent, rgba(43,212,255,.9), transparent);
      opacity:0;transform-origin:left center;filter:drop-shadow(0 0 10px rgba(43,212,255,.45));pointer-events:none;}
    .laser.fire{animation:laser 220ms ease-out forwards;}
    @keyframes laser{
      0%{opacity:0;transform:translate(-130px,0) rotate(0deg) scaleX(.6);}
      30%{opacity:1;}
      100%{opacity:0;transform:translate(130px,0) rotate(0deg) scaleX(1.15);}
    }

    .particle{position:absolute;width:6px;height:6px;border-radius:50%;pointer-events:none;opacity:0;
      filter:drop-shadow(0 0 12px rgba(255,204,102,.18));animation:particle 520ms ease-out forwards;}
    @keyframes particle{
      0%{opacity:0;transform:translate(0,0) scale(.9);}
      12%{opacity:1;}
      100%{opacity:0;transform:translate(var(--dx), var(--dy)) scale(.6);}
    }

    /* Click pop (big) */
    .pop{
      position:absolute;font-weight:900;pointer-events:none;opacity:0;transform:translate(-50%,-50%) scale(.95);
      animation:pop 900ms ease-out forwards;text-shadow:0 8px 20px rgba(0,0,0,.55);
      letter-spacing:.2px;white-space:nowrap;
      display:inline-flex;align-items:center;gap:8px;
      padding:0;
    }
    .pop .miniIcon{width:20px;height:20px;display:inline-block;filter:drop-shadow(0 0 16px rgba(255,255,255,.18));opacity:.98;}
    .pop .miniIcon svg{width:100%;height:100%;}
    @keyframes pop{
      0%{opacity:0;transform:translate(-50%,-50%) scale(.95);}
      15%{opacity:1;transform:translate(-50%,-64%) scale(1);}
      100%{opacity:0;transform:translate(-50%,-120%) scale(1.05);}
    }

    /* ---------- Drone System ---------- */
    #droneLayer{position:absolute; inset:0; pointer-events:none;}

    .droneOrbit{
      position:absolute; inset:0;
      transform: rotate(var(--start, 0deg));
      animation: orbit var(--dur, 10s) linear infinite;
      animation-direction: var(--dir, normal);
      pointer-events:none;
    }
    @keyframes orbit { from{transform:rotate(var(--start,0deg));} to{transform:rotate(calc(var(--start,0deg) + 360deg));} }

    .drone{
      position:absolute;
      left:50%;
      top:50%;
      transform: translate(calc(var(--radius, 84px) * 1), -50%) translate(-50%, -50%);
      width:30px;height:30px;
      opacity:1;
      pointer-events:none;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.35));
    }

    /* ===== Drone skin variables (default) ===== */
    .drone{
      --dA: rgba(255,255,255,.92);
      --dB: rgba(102,163,255,.45);
      --dC: rgba(43,212,255,.78);
      --dD: rgba(124,92,255,.24);
      --dBorder: rgba(255,255,255,.18);
      --dGlow: rgba(102,163,255,.20);
      --thrA: rgba(255,255,255,.95);
      --thrB: rgba(43,212,255,.55);
      --thrGlow: rgba(43,212,255,.35);
    }

    /* === Skin 1: Stealth Carbon (dark + green) === */
    .drone.skin-carbon{
      --dA: rgba(255,255,255,.86);
      --dB: rgba(70,80,105,.55);
      --dC: rgba(50,213,131,.85);
      --dD: rgba(50,213,131,.18);
      --dBorder: rgba(255,255,255,.16);
      --dGlow: rgba(50,213,131,.16);
      --thrA: rgba(255,255,255,.92);
      --thrB: rgba(50,213,131,.55);
      --thrGlow: rgba(50,213,131,.35);
    }

    /* === Skin 2: Neon Pulse (cyan + violet) === */
    .drone.skin-neon{
      --dA: rgba(255,255,255,.94);
      --dB: rgba(43,212,255,.50);
      --dC: rgba(43,212,255,.92);
      --dD: rgba(124,92,255,.30);
      --dBorder: rgba(255,255,255,.20);
      --dGlow: rgba(43,212,255,.22);
      --thrA: rgba(255,255,255,.95);
      --thrB: rgba(43,212,255,.62);
      --thrGlow: rgba(43,212,255,.38);
    }

    /* === Skin 3: Solar Alloy (gold + white) === */
    .drone.skin-solar{
      --dA: rgba(255,255,255,.95);
      --dB: rgba(255,204,102,.45);
      --dC: rgba(255,204,102,.90);
      --dD: rgba(255,159,26,.22);
      --dBorder: rgba(255,255,255,.20);
      --dGlow: rgba(255,204,102,.18);
      --thrA: rgba(255,255,255,.95);
      --thrB: rgba(255,204,102,.60);
      --thrGlow: rgba(255,204,102,.38);
    }

    .droneInner{
      position:absolute; inset:0;
      border-radius:12px;
      background:linear-gradient(180deg, var(--dA), var(--dB));
      border:1px solid var(--dBorder);
      box-shadow:0 10px 24px rgba(0,0,0,.30), 0 0 22px var(--dGlow);
      overflow:hidden;
      transform-origin:center;
      will-change: transform, filter;
      animation: droneHover 1.6s ease-in-out infinite;
    }

    .droneInner::before{
      content:""; position:absolute; inset:6px 6px;
      border-radius:10px;
      background:linear-gradient(90deg, var(--dC), var(--dD));
      opacity:.88;
      animation: droneBlink 1.1s steps(2,end) infinite;
    }

    .thruster{
      position:absolute; left:50%; bottom:-10px;
      width:10px;height:18px; transform:translateX(-50%);
      border-radius:999px;
      background: radial-gradient(circle at 50% 20%, var(--thrA), var(--thrB) 45%, rgba(0,0,0,0) 75%);
      opacity:.65;
      filter: drop-shadow(0 0 14px var(--thrGlow));
      animation: thruster 240ms ease-in-out infinite;
    }
    @keyframes thruster{
      0%{transform:translateX(-50%) scaleY(.85); opacity:.55;}
      50%{transform:translateX(-50%) scaleY(1.12); opacity:.80;}
      100%{transform:translateX(-50%) scaleY(.88); opacity:.60;}
    }

    @keyframes droneHover{
      0%   { transform: translateY(0px) scale(1.0); filter:brightness(1); }
      50%  { transform: translateY(-2px) scale(1.03); filter:brightness(1.10); }
      100% { transform: translateY(0px) scale(1.0); filter:brightness(1); }
    }
    @keyframes droneBlink{
      0%,60%{ opacity:.9; }
      61%,100%{ opacity:.55; }
    }

    .drone.aim .droneInner{
      animation-play-state:paused;
      filter:brightness(1.22) saturate(1.2);
      transform: translateY(-1px) scale(1.04);
    }
    .drone.fire .droneInner{
      animation-play-state:paused;
      filter:brightness(1.30) saturate(1.25);
      animation: recoil 180ms ease-out forwards;
    }
    @keyframes recoil{
      0%{ transform: translateY(-1px) scale(1.04); }
      40%{ transform: translateY(1px)  scale(.97); }
      100%{transform: translateY(0px)  scale(1.00); }
    }

    .muzzle{
      position:absolute;
      right:-8px;
      top:50%;
      width:14px;height:14px;
      transform:translateY(-50%);
      border-radius:50%;
      background:radial-gradient(circle, rgba(255,255,255,.95), var(--dC), rgba(0,0,0,0) 70%);
      opacity:0;
      filter: drop-shadow(0 0 18px var(--dGlow));
      pointer-events:none;
    }
    .blastRing{
      position:absolute; inset:-8px;
      border-radius:16px;
      border:2px solid rgba(0,0,0,0);
      opacity:0; pointer-events:none;
    }
    .drone.fire .muzzle{ animation:muzzleFlash 170ms ease-out forwards; }
    .drone.fire .blastRing{ animation: ringBlast 260ms ease-out forwards; }
    @keyframes muzzleFlash{
      0%{opacity:0; transform:translateY(-50%) scale(.6);}
      35%{opacity:1; transform:translateY(-50%) scale(1.2);}
      100%{opacity:0; transform:translateY(-50%) scale(1.7);}
    }
    @keyframes ringBlast{
      0%{opacity:0; transform:scale(.92); border-color:rgba(0,0,0,0);}
      20%{opacity:1; border-color:rgba(255,255,255,.24);}
      100%{opacity:0; transform:scale(1.10); border-color:rgba(0,0,0,0);}
    }

    .chargeTrack{
      position:absolute; left:4px; right:4px; bottom:4px;
      height:4px; border-radius:999px;
      background:rgba(0,0,0,.30);
      border:1px solid rgba(255,255,255,.14);
      overflow:hidden;
      pointer-events:none;
    }
    .chargeFill{
      height:100%;
      width:0%;
      background:linear-gradient(90deg, var(--dC), rgba(255,255,255,.78), var(--dD));
      filter:drop-shadow(0 0 14px var(--dGlow));
      transition:width .08s linear;
    }

    /* Drone beam element is created in JS, but base styling here */
    .droneBeam{
      position:absolute;
      height:6px;
      border-radius:999px;
      filter:drop-shadow(0 0 20px rgba(43,212,255,.60));
      opacity:0;
      pointer-events:none;
      transform-origin:left center;
      mix-blend-mode:screen;
    }
    .droneBeam.fire{ animation: droneBeam2 280ms ease-out forwards; }
    @keyframes droneBeam2{
      0%{ opacity:0; transform:scaleX(.65) scaleY(.8); filter:drop-shadow(0 0 8px rgba(43,212,255,.25)); }
      18%{ opacity:1; transform:scaleX(1) scaleY(1.05); }
      60%{ opacity:.95; filter:drop-shadow(0 0 28px rgba(43,212,255,.70)); }
      100%{opacity:0; transform:scaleX(1.22) scaleY(.9); }
    }

    .impactGlow{
      position:absolute;
      width:46px;height:46px;border-radius:50%;
      background:radial-gradient(circle, rgba(255,255,255,.95), rgba(43,212,255,.55), rgba(43,212,255,0) 72%);
      filter: drop-shadow(0 0 28px rgba(43,212,255,.55));
      pointer-events:none;
      opacity:0;
      animation: impact 320ms ease-out forwards;
      mix-blend-mode:screen;
    }
    @keyframes impact{
      0%{opacity:0; transform:scale(.55);}
      20%{opacity:1; transform:scale(1);}
      100%{opacity:0; transform:scale(1.55);}
    }

    .oreShard{
      position:absolute;
      width:10px;height:10px;border-radius:3px;
      background:linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,204,102,.65));
      filter: drop-shadow(0 0 14px rgba(255,204,102,.28));
      pointer-events:none;
      opacity:0;
      animation: shardFly 420ms cubic-bezier(.2,.8,.2,1) forwards;
    }
    .oreShard.rare{
      background:linear-gradient(180deg, rgba(255,255,255,.95), rgba(124,92,255,.70));
      filter: drop-shadow(0 0 16px rgba(124,92,255,.38));
    }
    @keyframes shardFly{
      0%{ opacity:0; transform:translate(0,0) scale(.85) rotate(0deg);}
      12%{opacity:1;}
      100%{opacity:0; transform:translate(var(--dx), var(--dy)) scale(.65) rotate(220deg);}
    }

    .dronePop{
      position:absolute;
      padding:6px 10px;
      border-radius:999px;
      font-weight:950;
      font-size:12px;
      letter-spacing:.15px;
      white-space:nowrap;
      pointer-events:none;
      opacity:0;
      transform: translate(-50%,-50%) scale(.96);
      background:rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(6px);
      box-shadow:0 14px 30px rgba(0,0,0,.35);
      text-shadow:0 10px 24px rgba(0,0,0,.55);
      animation: dronePopAnim 1050ms ease-out forwards;
      display:inline-flex; align-items:center; gap:7px;
    }
    .dronePop .ico{width:14px;height:14px;display:inline-block;filter: drop-shadow(0 0 12px rgba(255,255,255,.15));}
    .dronePop .ico svg{width:100%;height:100%;}
    .dronePop.credit{border-color:rgba(43,212,255,.22);background:rgba(43,212,255,.10);}
    .dronePop.ore{border-color:rgba(255,204,102,.22);background:rgba(255,204,102,.10);}
    .dronePop.rare{border-color:rgba(124,92,255,.28);background:rgba(124,92,255,.12);}
    @keyframes dronePopAnim{
      0%{opacity:0; transform:translate(-50%,-50%) scale(.96);}
      15%{opacity:1; transform:translate(-50%,-68%) scale(1.0);}
      100%{opacity:0; transform:translate(calc(-50% + var(--dx, 0px)), calc(-120% + var(--dy, -10px))) scale(1.04);}
    }

    .drone.spawn .droneInner{
      animation: droneSpawnIn 520ms cubic-bezier(.16,.9,.2,1) forwards;
      filter: brightness(1.35) saturate(1.3) drop-shadow(0 0 24px rgba(43,212,255,.35));
    }
    .drone.spawn .thruster{ animation: thrusterSpawn 180ms ease-in-out 7; opacity:.95; }
    @keyframes droneSpawnIn{
      0%{opacity:0; transform: scale(.35) rotate(-18deg); filter: blur(1px) brightness(1.6);}
      55%{opacity:1; transform: scale(1.08) rotate(6deg); filter: blur(0) brightness(1.25);}
      100%{opacity:1; transform: scale(1) rotate(0deg); filter: blur(0) brightness(1.05);}
    }
    @keyframes thrusterSpawn{
      0%{transform:translateX(-50%) scaleY(1.6); opacity:1;}
      50%{transform:translateX(-50%) scaleY(2.0); opacity:1;}
      100%{transform:translateX(-50%) scaleY(1.3); opacity:.75;}
    }

    .spawnRingFX{
      position:absolute;
      width:16px;height:16px;border-radius:50%;
      border:2px solid rgba(43,212,255,.0);
      pointer-events:none;
      opacity:0;
      filter: drop-shadow(0 0 22px rgba(43,212,255,.40));
      mix-blend-mode:screen;
      animation: spawnRing 520ms ease-out forwards;
    }
    @keyframes spawnRing{
      0%{opacity:0; transform:scale(.6); border-color:rgba(43,212,255,0);}
      15%{opacity:1; border-color:rgba(43,212,255,.65);}
      100%{opacity:0; transform:scale(6.2); border-color:rgba(43,212,255,0);}
    }
    .spawnSpark{
      position:absolute; width:6px;height:6px;border-radius:50%;
      background:rgba(255,255,255,.95);
      opacity:0; pointer-events:none;
      filter: drop-shadow(0 0 14px rgba(43,212,255,.35));
      animation: spawnSpark 520ms ease-out forwards;
    }
    @keyframes spawnSpark{
      0%{opacity:0; transform:translate(0,0) scale(.9);}
      15%{opacity:1;}
      100%{opacity:0; transform:translate(var(--dx), var(--dy)) scale(.55);}
    }

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px;}
    @media (max-width:920px){ .grid{grid-template-columns:1fr;} }

    .upgradeHeader{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      margin-top:10px;padding:10px 10px;
      background:rgba(0,0,0,.14);border:1px solid rgba(255,255,255,.08);border-radius:14px;
    }
    .tabs{display:flex;gap:8px;flex-wrap:wrap;}
    .tab{
      cursor:pointer;padding:7px 10px;border-radius:999px;
      background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);
      color:var(--muted);font-weight:800;font-size:12px;user-select:none;
    }
    .tab.active{color:var(--txt);border-color:rgba(102,163,255,.35);background:rgba(102,163,255,.12);box-shadow:0 10px 18px rgba(102,163,255,.10);}

    .upgradeList{display:grid;gap:10px;margin-top:10px;}
    .uCard{
      position:relative;padding:12px;border-radius:16px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.18));
      border:1px solid rgba(255,255,255,.10);overflow:hidden;
      transition:transform .08s, border-color .12s, box-shadow .12s, filter .12s;
    }
    .uCard:hover{transform:translateY(-1px);}
    .uCard:before{content:"";position:absolute;inset:-1px;background:radial-gradient(520px 220px at 0% 0%, rgba(102,163,255,.14), transparent 55%);pointer-events:none;}
    .uCard.affordable{border-color:rgba(50,213,131,.28);box-shadow:0 18px 36px rgba(50,213,131,.10);}
    .uCard.affordable:before{background:radial-gradient(520px 220px at 0% 0%, rgba(50,213,131,.12), transparent 55%);}

    .uTop{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;}
    .uLeft{display:flex;align-items:flex-start;gap:10px;min-width:0;}
    .uIcon{
      width:44px;height:44px;border-radius:14px;
      background:linear-gradient(180deg, rgba(102,163,255,.20), rgba(124,92,255,.12));
      border:1px solid rgba(255,255,255,.14);
      box-shadow:0 14px 26px rgba(0,0,0,.22);
      display:flex;align-items:center;justify-content:center;flex:0 0 auto;
    }
    .uIcon svg{width:24px;height:24px;opacity:.95;filter:drop-shadow(0 0 12px rgba(43,212,255,.12));}
    .uName{font-weight:950;letter-spacing:.2px;}
    .uDesc{color:var(--muted);font-size:12px;line-height:1.35;margin-top:2px;max-width:460px;}
    .uMeta{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;}
    .chip{
      font-size:11px;padding:4px 8px;border-radius:999px;
      background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);
      color:var(--muted);white-space:nowrap;
      display:inline-flex; align-items:center; gap:6px;
    }
    .chip strong{color:var(--txt);}
    .chip.good{border-color:rgba(50,213,131,.25);background:rgba(50,213,131,.09);}
    .chip.warn{border-color:rgba(255,204,102,.25);background:rgba(255,204,102,.08);color:rgba(255,240,210,.95);}
    .chip.bad{border-color:rgba(255,90,111,.28);background:rgba(255,90,111,.10);color:rgba(255,220,230,.95);}

    .ico{width:16px;height:16px;display:inline-block;opacity:.98;filter:drop-shadow(0 0 12px rgba(255,255,255,.10));}
    .ico svg{width:100%;height:100%;}

    .uRight{display:flex;flex-direction:column;align-items:flex-end;gap:8px;flex:0 0 auto;}
    .uCost{font-weight:900;color:rgba(255,255,255,.9);text-align:right;font-size:12px;}
    .uCost span{color:var(--muted);font-weight:800;}
    .uBuy{padding:10px 12px;border-radius:14px;font-weight:950;min-width:120px;}
    .uBuy.aff{background:linear-gradient(180deg, var(--good), #17b26a);box-shadow:0 12px 26px rgba(50,213,131,.16);color:#052012;}

    .uPing{position:absolute; inset:-2px;border-radius:18px;border:2px solid rgba(50,213,131,.0);pointer-events:none;}
    .uCard.purchased .uPing{animation:ping 520ms ease-out forwards;}
    @keyframes ping{
      0%{border-color:rgba(50,213,131,.0); transform:scale(.98); opacity:0;}
      20%{border-color:rgba(50,213,131,.55); opacity:1;}
      100%{border-color:rgba(50,213,131,.0); transform:scale(1.02); opacity:0;}
    }

    .body{margin-top:10px;}

    /* Cargo Feature Module UI */
    .cargoTop{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;}
    .toggle{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);
      font-size:12px;color:var(--muted);user-select:none;cursor:pointer;
    }
    .toggle.on{border-color:rgba(50,213,131,.25);background:rgba(50,213,131,.08);color:rgba(235,255,245,.95);}
    .toggle.off{border-color:rgba(255,90,111,.18);background:rgba(255,90,111,.06);}
    .cargoRow{
      display:grid;
      grid-template-columns: 1.05fr 1.15fr .9fr;
      gap:10px;
      align-items:center;
      padding:10px 0;
      border-bottom:1px solid rgba(255,255,255,.06);
      position:relative;
    }
    .cargoRow:last-child{border-bottom:0;}
    .cargoRow.newUnlock{border-bottom:1px solid rgba(102,163,255,.14);}
    .cargoRow.newUnlock:before{
      content:"";
      position:absolute; inset:-8px -10px;
      border-radius:16px;
      background:radial-gradient(520px 110px at 10% 50%, rgba(43,212,255,.14), transparent 55%);
      border:1px solid rgba(43,212,255,.20);
      opacity:0;
      animation: unlockGlow 1.35s ease-out forwards;
      pointer-events:none;
    }
    @keyframes unlockGlow{
      0%{opacity:0; transform:scale(.99);}
      18%{opacity:1; transform:scale(1.00);}
      100%{opacity:0; transform:scale(1.01);}
    }

    .oreHead{display:flex;align-items:center;gap:10px;}
    .oreIcon{
      width:34px;height:34px;border-radius:13px;
      background:
        radial-gradient(18px 16px at 30% 25%, rgba(255,255,255,.16), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.07), rgba(0,0,0,.16));
      border:1px solid rgba(255,255,255,.14);
      display:flex;align-items:center;justify-content:center;
      box-shadow:0 16px 28px rgba(0,0,0,.22);
      position:relative; overflow:hidden;
    }
    .oreIcon:after{
      content:""; position:absolute; inset:-10px;
      background: radial-gradient(60px 40px at 20% 10%, rgba(255,255,255,.10), transparent 60%);
      pointer-events:none; opacity:.85;
    }
    .oreIcon svg{width:22px;height:22px;opacity:.98;filter:drop-shadow(0 0 18px rgba(255,255,255,.10));}

    .oreName{font-weight:950;display:flex;align-items:center;gap:8px;}
    .oreMeta{color:var(--muted);font-size:12px;margin-top:2px;}

    .badge{
      font-size:10px;padding:3px 7px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      color:rgba(220,235,255,.9);
    }
    .badge.good{border-color:rgba(50,213,131,.25); background:rgba(50,213,131,.08);}
    .badge.warn{border-color:rgba(255,204,102,.25); background:rgba(255,204,102,.08);}
    .badge.bad{border-color:rgba(255,90,111,.25); background:rgba(255,90,111,.08);}

    .miniControls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
    .miniBtn{
      padding:7px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);color:var(--txt);font-weight:900;cursor:pointer;font-size:12px;
    }
    .miniBtn.good{background:rgba(50,213,131,.12);border-color:rgba(50,213,131,.22);color:rgba(230,255,245,.95);}
    .miniBtn.warn{background:rgba(255,204,102,.10);border-color:rgba(255,204,102,.22);color:rgba(255,245,220,.95);}
    .miniBtn.bad{background:rgba(255,90,111,.10);border-color:rgba(255,90,111,.22);color:rgba(255,230,235,.95);}

    .modeHint{
      width:100%;
      color:rgba(180,200,240,.9);
      font-size:12px;
      margin-top:2px;
      opacity:.9;
    }
    .modeHint b{color:rgba(235,245,255,.95);}

    .stepper{display:flex;gap:6px;align-items:center;}
    .stepper button{
      width:30px;height:30px;border-radius:10px;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);color:var(--txt);font-weight:950;cursor:pointer;
    }
    .stepper input{
      width:60px;height:30px;border-radius:10px;border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.22);color:var(--txt);text-align:center;font-weight:950;
    }
    .selectRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
    .trade{
      display:flex;justify-content:space-between;align-items:center;gap:10px;
      padding:10px;border-radius:14px;
      background:rgba(0,0,0,.14);
      border:1px solid rgba(255,255,255,.08);
      margin-top:8px;
    }

    .toast{
      position:fixed;top:14px;left:50%;transform:translateX(-50%);
      background:rgba(0,0,0,.58);
      border:1px solid rgba(255,255,255,.14);
      padding:10px 12px;border-radius:999px;
      color:var(--txt);font-weight:800;font-size:13px;
      opacity:0;transition:opacity .2s;
      pointer-events:none;z-index:50;
    }
    .toast.show{opacity:1;}

    /* -------- Codex modal -------- */
    .modalBackdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:80;
    }
    .modalBackdrop.show{display:flex;}
    .modal{
      width:min(760px, 100%);
      border-radius:18px;
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,.35));
      border:1px solid rgba(255,255,255,.12);
      box-shadow:0 30px 90px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modalHeader{
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
    }
    .modalTitle{font-weight:950; letter-spacing:.2px;}
    .modalBody{padding:12px 14px;}
    .codexGrid{display:grid; gap:10px;}
    .codexItem{
      padding:10px 12px;border-radius:16px;
      background:rgba(0,0,0,.16);
      border:1px solid rgba(255,255,255,.08);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .codexLeft{display:flex; align-items:center; gap:10px;}
    .codexIcon{
      width:34px;height:34px;border-radius:14px;
      background:
        radial-gradient(18px 16px at 30% 25%, rgba(255,255,255,.16), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.18));
      border:1px solid rgba(255,255,255,.14);
      display:flex; align-items:center; justify-content:center;
      box-shadow:0 16px 28px rgba(0,0,0,.22);
      overflow:hidden;
      position:relative;
    }
    .codexIcon:after{
      content:""; position:absolute; inset:-10px;
      background: radial-gradient(60px 40px at 20% 10%, rgba(255,255,255,.10), transparent 60%);
      opacity:.85; pointer-events:none;
    }
    .codexIcon svg{width:22px;height:22px;filter:drop-shadow(0 0 18px rgba(255,255,255,.10));}
    .codexName{font-weight:950;}
    .codexMeta{font-size:12px;color:var(--muted);margin-top:2px;}
    .codexRight{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;}

    /* ===== Planet Switcher ===== */
    .planetBar{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
      margin-top:10px; padding:10px;
      background:rgba(0,0,0,.18); border:1px solid rgba(255,255,255,.08); border-radius:14px;
    }
    .planetBtn{
      cursor:pointer; user-select:none; border:0; border-radius:12px;
      padding:8px 14px; font-weight:900; font-size:12px;
      background:rgba(255,255,255,.07); border:1px solid rgba(255,255,255,.12);
      color:var(--muted);
      transition: transform .08s, background .14s, border-color .14s, color .14s, box-shadow .14s;
      display:inline-flex; align-items:center; gap:8px;
    }
    .planetBtn:hover{ transform:translateY(-1px); }
    .planetBtn.active-iron{
      background:rgba(102,163,255,.14); border-color:rgba(102,163,255,.35);
      color:var(--txt); box-shadow:0 8px 18px rgba(102,163,255,.14);
    }
    .planetBtn.active-vulcan{
      background:rgba(255,90,50,.16); border-color:rgba(255,130,60,.40);
      color:#ffd0b0; box-shadow:0 8px 18px rgba(255,90,50,.18);
    }
    .planetBtn:disabled{ opacity:.42; cursor:not-allowed; transform:none !important; box-shadow:none; }
    .planetDot{
      width:10px; height:10px; border-radius:50%; flex-shrink:0;
    }
    .planetDot.iron{ background:radial-gradient(circle at 35% 30%, #a8ccff, #3a5a9c); }
    .planetDot.vulcan{ background:radial-gradient(circle at 35% 30%, #ffb060, #c93a10); }

    /* ===== Vulcan Planet skin for the click area ===== */
    .clickArea.planet-vulcan{
      background:
        radial-gradient(220px 170px at 52% 46%, rgba(255,100,30,.28), rgba(255,60,0,.04)),
        radial-gradient(380px 220px at 70% 10%, rgba(200,60,0,.18), transparent 60%);
      border-color: rgba(255,100,30,.18);
    }
    /* scanlines warm tint */
    .clickArea.planet-vulcan .scanlines{
      background:linear-gradient(180deg, rgba(255,100,30,.07), transparent 60%);
    }

    /* Vulcan asteroid look */
    .asteroid.planet-vulcan{
      background:
        radial-gradient(circle at 30% 28%, rgba(255,255,255,.9) 0 7px, transparent 9px),
        radial-gradient(circle at 40% 35%, #ff9060 0%, #c05028 20%, #7a2210 50%, #3a0e06 78%, #180602 100%);
      box-shadow:0 0 0 10px rgba(255,80,20,.10), 0 34px 70px rgba(0,0,0,.42), 0 0 60px rgba(255,70,10,.12);
    }
    .asteroid.planet-vulcan .cracks{
      background:
        radial-gradient(60px 40px at 65% 42%, rgba(255,140,30,.32) 0%, transparent 70%),
        radial-gradient(80px 60px at 35% 65%, rgba(255,60,0,.24) 0%, transparent 72%),
        radial-gradient(40px 30px at 50% 50%, rgba(255,200,80,.18) 0%, transparent 65%);
      opacity:1;
    }
    .ring.planet-vulcan{
      border-color:rgba(255,100,30,.22);
      filter:drop-shadow(0 0 14px rgba(255,80,20,.14));
    }

    /* ===== Miner Rank Roadmap Modal ===== */
    #roadmapBackdrop{ z-index:85; }

    .roadmapScroll{
      max-height: min(72vh, 600px);
      overflow-y: auto;
      padding: 4px 14px 14px;
      scrollbar-width: thin;
      scrollbar-color: rgba(102,163,255,.25) transparent;
    }
    .roadmapScroll::-webkit-scrollbar{ width:4px; }
    .roadmapScroll::-webkit-scrollbar-thumb{ background:rgba(102,163,255,.22); border-radius:999px; }

    .roadmap{
      position:relative;
      padding-left: 36px;
    }
    /* vertical spine */
    .roadmap::before{
      content:"";
      position:absolute;
      left:11px; top:8px; bottom:8px;
      width:2px;
      background: linear-gradient(180deg,
        rgba(102,163,255,.55) 0%,
        rgba(124,92,255,.40) 50%,
        rgba(255,90,50,.30) 100%);
      border-radius:999px;
    }

    .rmItem{
      position:relative;
      margin-bottom: 10px;
      padding: 12px 12px 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.14));
      transition: border-color .15s, box-shadow .15s, background .15s;
    }
    .rmItem.done{
      background: linear-gradient(180deg, rgba(50,213,131,.07), rgba(0,0,0,.12));
      border-color: rgba(50,213,131,.20);
    }
    .rmItem.current{
      background: linear-gradient(180deg, rgba(102,163,255,.12), rgba(124,92,255,.06));
      border-color: rgba(102,163,255,.38);
      box-shadow: 0 0 0 1px rgba(102,163,255,.12), 0 12px 32px rgba(102,163,255,.12);
    }
    .rmItem.locked{
      opacity:.55;
    }
    /* BIG unlock items (planet / major milestone) */
    .rmItem.major{
      background: linear-gradient(135deg, rgba(255,90,50,.12), rgba(124,92,255,.10), rgba(0,0,0,.18));
      border-color: rgba(255,130,60,.35);
      box-shadow: 0 0 0 1px rgba(255,90,50,.10), 0 12px 32px rgba(255,80,20,.10);
    }
    .rmItem.major.done{
      background: linear-gradient(135deg, rgba(50,213,131,.10), rgba(102,163,255,.07));
      border-color: rgba(50,213,131,.28);
      box-shadow: 0 0 0 1px rgba(50,213,131,.10), 0 10px 28px rgba(50,213,131,.08);
    }
    .rmItem.major.current{
      border-color: rgba(255,130,60,.55);
      box-shadow: 0 0 0 1px rgba(255,90,50,.16), 0 14px 36px rgba(255,80,20,.16);
    }

    /* dot on spine */
    .rmDot{
      position:absolute;
      left: -29px; top: 50%; transform: translateY(-50%);
      width:14px; height:14px; border-radius:50%;
      border:2px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      flex-shrink:0;
      transition: background .15s, border-color .15s, box-shadow .15s;
    }
    .rmItem.done   .rmDot{ background:var(--good); border-color:rgba(50,213,131,.55); box-shadow:0 0 10px rgba(50,213,131,.35); }
    .rmItem.current .rmDot{ background:var(--acc); border-color:rgba(102,163,255,.65); box-shadow:0 0 14px rgba(102,163,255,.45); animation:dotPulse 1.6s ease-in-out infinite; }
    .rmItem.major:not(.done):not(.current) .rmDot{ background:rgba(255,100,40,.18); border-color:rgba(255,100,40,.38); }
    .rmItem.major.done .rmDot{ background:var(--good); border-color:rgba(50,213,131,.55); box-shadow:0 0 12px rgba(50,213,131,.40); }
    @keyframes dotPulse{
      0%,100%{ box-shadow:0 0 8px rgba(102,163,255,.35); }
      50%{ box-shadow:0 0 18px rgba(102,163,255,.65); }
    }

    .rmHeader{ display:flex; align-items:center; gap:10px; justify-content:space-between; }
    .rmLeft{ display:flex; align-items:center; gap:10px; min-width:0; }
    .rmRank{
      font-size:11px; font-weight:900; color:var(--muted);
      background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10);
      border-radius:999px; padding:3px 8px; flex-shrink:0; white-space:nowrap;
    }
    .rmItem.done .rmRank{ color:var(--good); border-color:rgba(50,213,131,.25); background:rgba(50,213,131,.08); }
    .rmItem.current .rmRank{ color:var(--acc); border-color:rgba(102,163,255,.30); background:rgba(102,163,255,.10); }
    .rmItem.major .rmRank{ color:#ffb060; border-color:rgba(255,130,60,.30); background:rgba(255,100,30,.10); }
    .rmItem.major.done .rmRank{ color:var(--good); border-color:rgba(50,213,131,.25); background:rgba(50,213,131,.08); }

    .rmTitle{ font-weight:900; letter-spacing:.1px; font-size:13px; }
    .rmItem.major .rmTitle{ font-size:14px; }

    .rmRewards{ display:flex; gap:6px; flex-wrap:wrap; margin-top:8px; }
    .rmReward{
      display:inline-flex; align-items:center; gap:6px;
      padding:5px 9px; border-radius:999px; font-size:11px; font-weight:800;
      background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.09);
      color:rgba(220,235,255,.9);
    }
    .rmReward.ore{ border-color:rgba(255,204,102,.22); background:rgba(255,204,102,.08); color:rgba(255,240,210,.95); }
    .rmReward.planet{ border-color:rgba(255,100,40,.30); background:rgba(255,90,30,.12); color:#ffd0a8; font-size:12px; }
    .rmReward.planet.unlocked{ border-color:rgba(50,213,131,.28); background:rgba(50,213,131,.09); color:rgba(220,255,235,.95); }
    .rmReward.perk{ border-color:rgba(124,92,255,.28); background:rgba(124,92,255,.10); color:#d4c0ff; }
    .rmReward.perk.unlocked{ border-color:rgba(50,213,131,.28); background:rgba(50,213,131,.09); color:rgba(220,255,235,.95); }
    .rmReward.trade{ border-color:rgba(43,212,255,.22); background:rgba(43,212,255,.08); color:rgba(200,245,255,.95); }

    .rmStatusTag{
      font-size:10px; font-weight:900; padding:3px 8px; border-radius:999px; flex-shrink:0; white-space:nowrap;
    }
    .rmStatusTag.done{ background:rgba(50,213,131,.14); border:1px solid rgba(50,213,131,.25); color:var(--good); }
    .rmStatusTag.current{ background:rgba(102,163,255,.12); border:1px solid rgba(102,163,255,.28); color:var(--acc); }
    .rmStatusTag.locked{ background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.09); color:var(--muted); }

    /* XP mini-bar inside current item */
    .rmXpBar{ height:4px; border-radius:999px; background:rgba(255,255,255,.07); margin-top:8px; overflow:hidden; }
    .rmXpFill{ height:100%; border-radius:999px; background:linear-gradient(90deg, var(--acc), #2bd4ff); transition:width .3s; }

    /* progress summary bar at top */
    .rmProgress{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      padding:10px 14px; border-bottom:1px solid rgba(255,255,255,.07);
      background:rgba(0,0,0,.12);
    }
    .rmProgressBar{ flex:1; min-width:120px; height:6px; border-radius:999px; background:rgba(255,255,255,.07); overflow:hidden; }
    .rmProgressFill{ height:100%; border-radius:999px; background:linear-gradient(90deg, var(--good), var(--acc)); transition:width .3s; }
    /* ===== Daily Quests ===== */
    .questCard{
      padding:12px; border-radius:16px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.14));
      border:1px solid rgba(255,255,255,.09);
      position:relative; overflow:hidden;
    }
    .questCard.complete{
      background:linear-gradient(180deg, rgba(50,213,131,.08), rgba(0,0,0,.12));
      border-color:rgba(50,213,131,.25);
    }
    .questCard.claimed{
      opacity:.55;
      background:rgba(0,0,0,.10);
      border-color:rgba(255,255,255,.06);
    }
    .questTop{ display:flex; justify-content:space-between; align-items:flex-start; gap:10px; }
    .questLeft{ min-width:0; }
    .questTitle{ font-weight:900; font-size:13px; }
    .questDesc{ color:var(--muted); font-size:12px; margin-top:2px; }
    .questRewards{ display:flex; gap:6px; flex-wrap:wrap; margin-top:8px; }
    .questReward{
      display:inline-flex; align-items:center; gap:5px;
      padding:4px 8px; border-radius:999px; font-size:11px; font-weight:800;
      background:rgba(50,213,131,.10); border:1px solid rgba(50,213,131,.22); color:rgba(210,255,235,.95);
    }
    .questDiff{
      font-size:10px; font-weight:900; padding:3px 8px; border-radius:999px; flex-shrink:0;
    }
    .questDiff.easy{ background:rgba(50,213,131,.12); border:1px solid rgba(50,213,131,.22); color:var(--good); }
    .questDiff.medium{ background:rgba(255,204,102,.10); border:1px solid rgba(255,204,102,.22); color:var(--warn); }
    .questDiff.hard{ background:rgba(255,90,111,.10); border:1px solid rgba(255,90,111,.22); color:var(--danger); }
    .questProgressBar{ height:5px; border-radius:999px; background:rgba(255,255,255,.07); margin-top:10px; overflow:hidden; }
    .questProgressFill{ height:100%; border-radius:999px; background:linear-gradient(90deg, var(--good), #2bd4ff); transition:width .3s; }
    .questProgressLabel{ font-size:11px; color:var(--muted); margin-top:4px; }

    /* quest strip preview in HUD */
    .questStrip{
      display:flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:12px;
      background:rgba(0,0,0,.14); border:1px solid rgba(255,255,255,.07);
      font-size:12px; cursor:pointer;
      transition: border-color .14s, background .14s;
    }
    .questStrip:hover{ border-color:rgba(102,163,255,.25); background:rgba(102,163,255,.07); }
    .questStripDot{ width:8px; height:8px; border-radius:50%; flex-shrink:0; }
    .questStripDot.done{ background:var(--good); }
    .questStripDot.active{ background:var(--warn); }
    .questStripDot.locked{ background:rgba(255,255,255,.18); }

    /* ===== Skill Tree ===== */
    .skillBranch{
      display:flex; flex-direction:column; gap:8px;
    }
    .skillBranchHeader{
      padding:8px 10px; border-radius:12px; text-align:center; font-weight:900; font-size:12px;
      margin-bottom:2px;
    }
    .skillBranch.mining .skillBranchHeader{ background:rgba(43,212,255,.10); border:1px solid rgba(43,212,255,.20); color:rgba(180,245,255,.95); }
    .skillBranch.economy .skillBranchHeader{ background:rgba(255,204,102,.10); border:1px solid rgba(255,204,102,.20); color:rgba(255,245,200,.95); }
    .skillBranch.exploration .skillBranchHeader{ background:rgba(255,90,50,.10); border:1px solid rgba(255,100,50,.20); color:rgba(255,210,180,.95); }

    .skillConnector{
      width:2px; height:10px; border-radius:999px;
      background:rgba(255,255,255,.12); margin:0 auto;
    }
    .skillBranch.mining .skillConnector{ background:rgba(43,212,255,.25); }
    .skillBranch.economy .skillConnector{ background:rgba(255,204,102,.22); }
    .skillBranch.exploration .skillConnector{ background:rgba(255,100,50,.22); }

    .skillNode{
      padding:10px; border-radius:14px;
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.16));
      border:1px solid rgba(255,255,255,.08);
      cursor:pointer;
      transition: transform .08s, border-color .14s, box-shadow .14s, opacity .14s;
      position:relative; overflow:hidden;
    }
    .skillNode:hover:not(.locked-node){ transform:translateY(-1px); }
    .skillNode.owned{
      background:linear-gradient(180deg, rgba(50,213,131,.09), rgba(0,0,0,.14));
      border-color:rgba(50,213,131,.28);
    }
    .skillNode.locked-node{ opacity:.42; cursor:not-allowed; }
    .skillNode.affordable{ border-color:rgba(50,213,131,.28); box-shadow:0 8px 22px rgba(50,213,131,.10); }

    .skillBranch.mining .skillNode.affordable{ border-color:rgba(43,212,255,.35); box-shadow:0 8px 22px rgba(43,212,255,.12); }
    .skillBranch.economy .skillNode.affordable{ border-color:rgba(255,204,102,.32); box-shadow:0 8px 22px rgba(255,204,102,.10); }
    .skillBranch.exploration .skillNode.affordable{ border-color:rgba(255,100,50,.35); box-shadow:0 8px 22px rgba(255,100,50,.10); }

    .skillNodeName{ font-weight:900; font-size:12px; margin-bottom:3px; }
    .skillNodeDesc{ font-size:11px; color:var(--muted); line-height:1.35; }
    .skillNodeCost{ display:flex; gap:5px; flex-wrap:wrap; margin-top:7px; }
    .skillCostChip{
      font-size:10px; font-weight:800; padding:3px 7px; border-radius:999px;
      background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10); color:var(--muted);
      display:inline-flex; align-items:center; gap:4px;
    }
    .skillCostChip.met{ border-color:rgba(50,213,131,.25); background:rgba(50,213,131,.08); color:rgba(210,255,235,.9); }
    .skillOwnedBadge{
      position:absolute; top:6px; right:6px;
      font-size:9px; font-weight:900; padding:2px 6px; border-radius:999px;
      background:rgba(50,213,131,.14); border:1px solid rgba(50,213,131,.25); color:var(--good);
    }
    /* ===== Planet Overview Cards ===== */
    .planetCard{
      border-radius:20px;
      border:1px solid rgba(255,255,255,.09);
      overflow:hidden;
      position:relative;
    }
    .planetCard.active-card{
      border-color:rgba(102,163,255,.35);
      box-shadow:0 0 0 1px rgba(102,163,255,.12), 0 12px 32px rgba(102,163,255,.10);
    }
    .planetCard.vulcan-card{
      border-color:rgba(255,100,40,.22);
    }
    .planetCard.vulcan-card.active-card{
      border-color:rgba(255,130,60,.45);
      box-shadow:0 0 0 1px rgba(255,90,40,.14), 0 12px 32px rgba(255,80,20,.12);
    }
    .planetCard.locked-card{
      opacity:.72;
    }
    .planetCard.future-card{
      opacity:.45;
      border-style:dashed;
    }

    .planetCardBanner{
      height:90px;
      position:relative;
      display:flex;
      align-items:center;
      padding:0 20px;
      gap:16px;
    }
    .planetCardBanner.iron-banner{
      background:linear-gradient(135deg,
        rgba(30,50,100,.85) 0%,
        rgba(20,35,80,.70) 50%,
        rgba(10,20,55,.80) 100%);
    }
    .planetCardBanner.vulcan-banner{
      background:linear-gradient(135deg,
        rgba(120,30,10,.80) 0%,
        rgba(80,20,5,.70) 40%,
        rgba(40,10,3,.80) 100%);
    }
    .planetCardBanner.future-banner{
      background:linear-gradient(135deg,
        rgba(50,20,80,.70),
        rgba(20,10,40,.80));
    }

    /* animated stars inside banner */
    .planetCardBanner::before{
      content:"";
      position:absolute; inset:0;
      background-image:
        radial-gradient(1px 1px at 15% 30%, rgba(255,255,255,.55), transparent),
        radial-gradient(1px 1px at 70% 20%, rgba(255,255,255,.40), transparent),
        radial-gradient(1px 1px at 45% 70%, rgba(255,255,255,.35), transparent),
        radial-gradient(1px 1px at 85% 55%, rgba(255,255,255,.50), transparent),
        radial-gradient(1px 1px at 25% 80%, rgba(255,255,255,.30), transparent);
      pointer-events:none;
    }

    .planetOrb{
      width:60px; height:60px; border-radius:50%; flex-shrink:0;
      position:relative; z-index:1;
      box-shadow:0 8px 24px rgba(0,0,0,.40);
    }
    .planetOrb.iron-orb{
      background:radial-gradient(circle at 35% 30%,
        #a8d4ff 0%, #4a7ac0 25%, #2a4a8a 55%, #0e1f55 85%, #050e2e 100%);
      box-shadow:0 0 0 2px rgba(100,160,255,.20), 0 8px 24px rgba(0,0,0,.40), 0 0 30px rgba(60,120,255,.15);
    }
    .planetOrb.vulcan-orb{
      background:radial-gradient(circle at 35% 30%,
        #ff9060 0%, #c05028 25%, #7a2210 55%, #3a0e06 85%, #180602 100%);
      box-shadow:0 0 0 2px rgba(255,100,40,.22), 0 8px 24px rgba(0,0,0,.40), 0 0 30px rgba(255,70,10,.18);
    }
    .planetOrb.future-orb{
      background:radial-gradient(circle at 35% 30%,
        rgba(180,130,255,.6), rgba(80,40,160,.5), rgba(20,10,60,.8));
      box-shadow:0 0 0 2px rgba(150,100,255,.15), 0 8px 24px rgba(0,0,0,.50);
    }
    .planetOrb.iron-orb::after{
      content:"";
      position:absolute; inset:0; border-radius:50%;
      background:radial-gradient(circle at 30% 25%, rgba(255,255,255,.30) 0 18%, transparent 45%);
    }
    .planetOrb.vulcan-orb::after{
      content:"";
      position:absolute; inset:0; border-radius:50%;
      background:
        radial-gradient(circle at 30% 25%, rgba(255,220,180,.25) 0 18%, transparent 45%),
        radial-gradient(ellipse at 60% 65%, rgba(255,80,10,.18), transparent 55%);
    }

    .planetBannerInfo{ z-index:1; min-width:0; }
    .planetBannerName{ font-size:18px; font-weight:950; letter-spacing:.2px; }
    .planetBannerSub{ font-size:12px; color:rgba(255,255,255,.55); margin-top:2px; }

    .planetBannerBadge{
      margin-left:auto; z-index:1; flex-shrink:0;
      font-size:11px; font-weight:900; padding:5px 10px; border-radius:999px;
    }
    .planetBannerBadge.current{ background:rgba(102,163,255,.20); border:1px solid rgba(102,163,255,.35); color:var(--acc); }
    .planetBannerBadge.owned{ background:rgba(50,213,131,.14); border:1px solid rgba(50,213,131,.28); color:var(--good); }
    .planetBannerBadge.locked{ background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); color:var(--muted); }
    .planetBannerBadge.unlockable{ background:rgba(255,204,102,.12); border:1px solid rgba(255,204,102,.28); color:var(--warn); }

    .planetCardBody{
      padding:14px 16px 16px;
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.16));
      display:grid; grid-template-columns:1fr auto; gap:12px; align-items:start;
    }

    .planetStats{ display:flex; flex-wrap:wrap; gap:6px; }
    .planetStat{
      display:inline-flex; align-items:center; gap:5px;
      padding:5px 9px; border-radius:999px; font-size:11px; font-weight:800;
      background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.09);
      color:rgba(220,235,255,.85);
    }
    .planetStat.good{ border-color:rgba(50,213,131,.22); background:rgba(50,213,131,.08); color:rgba(210,255,235,.95); }
    .planetStat.warn{ border-color:rgba(255,204,102,.22); background:rgba(255,204,102,.08); color:rgba(255,245,200,.95); }
    .planetStat.ore{ border-color:rgba(255,160,60,.22); background:rgba(255,140,40,.08); color:rgba(255,230,180,.95); }

    .planetOres{ margin-top:8px; display:flex; gap:5px; flex-wrap:wrap; align-items:center; }
    .planetOreLabel{ font-size:10px; font-weight:800; color:var(--muted); }

    .planetCardActions{ display:flex; flex-direction:column; gap:6px; align-items:flex-end; justify-content:center; }
    .planetBuyInfo{ font-size:11px; color:var(--muted); text-align:right; line-height:1.4; }
    .planetBuyInfo.can-afford{ color:var(--good); }
    .planetBuyInfo.locked-mr{ color:var(--danger); }

    /* Active planet glow ring on orb */
    .planetOrb.active-glow.iron-orb{ box-shadow:0 0 0 3px rgba(102,163,255,.45), 0 0 0 6px rgba(102,163,255,.12), 0 8px 24px rgba(0,0,0,.40); }
    .planetOrb.active-glow.vulcan-orb{ box-shadow:0 0 0 3px rgba(255,120,50,.50), 0 0 0 6px rgba(255,90,20,.14), 0 8px 24px rgba(0,0,0,.40); }
    /* ===== Leaderboard ===== */
    .lbRow{
      display:grid;
      grid-template-columns: 32px 1fr auto auto;
      align-items:center; gap:10px;
      padding:10px 12px; border-radius:14px;
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.14));
      border:1px solid rgba(255,255,255,.08);
      transition: border-color .14s;
    }
    .lbRow.me{
      background:linear-gradient(180deg, rgba(102,163,255,.10), rgba(0,0,0,.12));
      border-color:rgba(102,163,255,.30);
    }
    .lbRow.top1{ border-color:rgba(255,204,102,.35); background:linear-gradient(180deg,rgba(255,204,102,.09),rgba(0,0,0,.14)); }
    .lbRow.top2{ border-color:rgba(210,230,255,.25); background:linear-gradient(180deg,rgba(210,230,255,.07),rgba(0,0,0,.14)); }
    .lbRow.top3{ border-color:rgba(255,140,60,.28); background:linear-gradient(180deg,rgba(255,140,60,.08),rgba(0,0,0,.14)); }
    .lbRank{ font-size:14px; font-weight:950; text-align:center; color:var(--muted); }
    .lbRank.gold{ color:rgba(255,204,102,.95); }
    .lbRank.silver{ color:rgba(210,230,255,.90); }
    .lbRank.bronze{ color:rgba(255,140,60,.90); }
    .lbName{ font-weight:900; font-size:13px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .lbMR{ font-size:11px; font-weight:800; color:var(--acc); white-space:nowrap; }
    .lbScore{ font-size:11px; font-weight:800; color:var(--muted); white-space:nowrap; }
    #lbUsernameInput::placeholder{ color:rgba(255,255,255,.28); }
    #lbUsernameInput:focus{ border-color:rgba(102,163,255,.45); background:rgba(0,0,0,.35); }

    /* Prevent ALL double-tap zoom globally */
    * { touch-action: manipulation; }

    /* But allow scrolling inside modals */
    .modalBackdrop, .roadmapScroll { touch-action: pan-y; }

    /* Prevent text selection on rapid taps (asteroid, buttons) */
    .asteroid, .btn, .tab, .planetBtn, .uBuy, .miniBtn {
      -webkit-user-select: none;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    @media (max-width: 640px) {
      .wrap { padding: 10px 10px 24px; }

      /* Stack the two main cards vertically (they already do, but tighten gaps) */
      .top { gap: 10px; }
      .card { padding: 12px; }

      /* Asteroid stage a bit smaller */
      .clickArea { height: 210px; }
      .asteroidStage { width: 185px; height: 185px; }
      .asteroid { width: 118px; height: 118px; }
      .asteroidWrap { width: 118px; height: 118px; }
      .ring { inset: -15px; }      /* Planet bar wraps nicely */
      .planetBar { flex-wrap: wrap; gap: 6px; }
      .planetBar .btn { margin-left: 0 !important; width: 100%; justify-content: center; }

      /* Quest strip text doesn't overflow */
      .questStrip span { font-size: 11px; }

      /* Shop tabs scrollable on tiny screens */
      .tabs { overflow-x: auto; -webkit-overflow-scrolling: touch; flex-wrap: nowrap; padding-bottom: 2px; }
      .tab  { flex-shrink: 0; }

      /* Upgrade cards full width */
      .upgradeList { grid-template-columns: 1fr; }

      /* Modals full screen on mobile */
      .modal {
        width: 100% !important;
        max-height: 92dvh;
        border-radius: 20px 20px 0 0;
        margin-top: auto;
      }
      .modalBackdrop {
        align-items: flex-end;
      }

      /* Planet overview cards: orb + info side by side, actions below */
      .planetCardBody {
        grid-template-columns: 1fr;
        gap: 8px;
      }
      .planetCardActions {
        flex-direction: row;
        align-items: center;
        flex-wrap: wrap;
      }
      .planetCardBanner { height: 75px; }
      .planetOrb { width: 48px; height: 48px; }
      .planetBannerName { font-size: 15px; }

      /* Skill tree: single column on mobile */
      #skillTreeEl { grid-template-columns: 1fr !important; }

      /* Grid buttons (Daily Quests / Reset) */
      .grid { grid-template-columns: 1fr 1fr; gap: 8px; }
    }

    @media (max-width: 380px) {
      .clickArea { height: 185px; }
      .asteroidStage { width: 165px; height: 165px; }
      .asteroid { width: 105px; height: 105px; }
      .asteroidWrap { width: 105px; height: 105px; }
      .big { font-size: 26px; }
    }

    /* ===== Void Expanse Planet ===== */
    .planetDot.void{
      background:radial-gradient(circle, #c084fc, #7c3aed);
      box-shadow:0 0 6px rgba(192,132,252,.6);
    }
    .planetBtn.active-void{
      background:rgba(124,58,237,.18);
      border-color:rgba(192,132,252,.35);
      color:#e9d5ff;
    }
    .clickArea.planet-void{
      background:
        radial-gradient(200px 160px at 50% 44%, rgba(124,58,237,.32), rgba(88,28,135,.06)),
        radial-gradient(360px 200px at 75% 8%, rgba(168,85,247,.18), transparent 60%);
      border-color: rgba(167,139,250,.22);
    }
    .clickArea.planet-void::after{
      background:repeating-linear-gradient(
        0deg, transparent, transparent 3px,
        rgba(167,139,250,.025) 3px, rgba(167,139,250,.025) 4px
      );
    }
    .asteroid.planet-void{
      background:radial-gradient(circle at 38% 32%,
        #e9d5ff 0%, #a855f7 18%, #6d28d9 42%, #3b0764 72%, #1a0533 100%);
      box-shadow:0 0 0 2px rgba(167,139,250,.18),
                 0 8px 32px rgba(0,0,0,.55),
                 0 0 50px rgba(124,58,237,.28),
                 inset 0 0 30px rgba(88,28,135,.35);
    }
    .void-banner{
      background:linear-gradient(135deg,
        rgba(60,20,100,.85) 0%,
        rgba(40,10,80,.70) 40%,
        rgba(15,5,40,.85) 100%);
    }
    .planetOrb.void-orb{
      background:radial-gradient(circle at 35% 30%,
        #e9d5ff 0%, #a855f7 20%, #6d28d9 50%, #2e1065 80%, #0f0520 100%);
      box-shadow:0 0 0 2px rgba(167,139,250,.25),
                 0 8px 24px rgba(0,0,0,.45),
                 0 0 35px rgba(124,58,237,.30);
      animation: voidOrbPulse 3s ease-in-out infinite;
    }
    @keyframes voidOrbPulse{
      0%,100%{ box-shadow:0 0 0 2px rgba(167,139,250,.25),0 8px 24px rgba(0,0,0,.45),0 0 35px rgba(124,58,237,.30); }
      50%{     box-shadow:0 0 0 3px rgba(167,139,250,.45),0 8px 24px rgba(0,0,0,.45),0 0 60px rgba(124,58,237,.55); }
    }
    @keyframes voidSurgeAnim{
      0%{   filter:brightness(1)   drop-shadow(0 0 0px rgba(192,132,252,0)); }
      25%{  filter:brightness(1.4) drop-shadow(0 0 22px rgba(192,132,252,.9)); }
      100%{ filter:brightness(1)   drop-shadow(0 0 0px rgba(192,132,252,0)); }
    }
    .asteroid.void-surge{ animation: voidSurgeAnim 0.55s ease-out forwards; }
    #musicToggleBtn{ opacity:.7; transition:opacity .2s; }
    #musicToggleBtn.playing{ opacity:1; color:#a5f3fc; border-color:rgba(165,243,252,.3); }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="card stats">
        <div class="row" style="justify-content:space-between;">
          <div>
            <div class="muted">Credits (Wallet)</div>
            <div class="big" id="credits">0</div>
          </div>
          <div style="text-align:right;">
            <div class="muted" style="margin-top:2px;">
              Regolith/s: <b id="rps">0</b> Â· Laser: <b id="laserPower">1</b>
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="row" style="justify-content:space-between;">
            <div>
              <div class="muted">Miner Rank</div>
              <div style="font-weight:950;font-size:18px;">MR <span id="minerRank">1</span></div>
            </div>
            <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;">
              <div style="display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end;">
                <button class="btn secondary" id="openRoadmapBtn" style="padding:6px 12px;font-size:12px;border-radius:10px;">ðŸ—º Rank Road</button>
                <button class="btn secondary" id="openLeaderboardBtn" style="padding:6px 12px;font-size:12px;border-radius:10px;">ðŸ† Board</button>
                <button class="btn secondary" id="openPrestigeBtn" style="padding:6px 12px;font-size:12px;border-radius:10px;">âœ¨ Prestige</button>
                <button class="btn secondary" id="musicToggleBtn" style="padding:6px 10px;font-size:14px;border-radius:10px;" title="Toggle Music">ðŸ”‡</button>
              </div>
              <div class="muted" style="font-size:12px;text-align:right;"><span id="xpNow">0</span>/<span id="xpNeed">60</span> XP Â· âœ¨ <span id="stellarDustHud">0</span></div>
            </div>
          </div>
          <div class="bar" style="margin-top:8px;"><div id="xpBar"></div></div>
          <div class="muted" style="margin-top:8px;font-size:12px;" id="rankPerkText">Bonus: â€”</div>
          <div class="muted" style="margin-top:6px;font-size:12px;" id="nextUnlockText">Next unlock: â€”</div>
        </div>

        <div class="clickArea" id="clickArea" role="button" aria-label="Fire mining laser">
          <div class="scanlines"></div>

          <div class="asteroidStage" id="stage">
            <div class="orbitRing"></div>
            <div class="orbitRing r2"></div>
            <div class="orbitRing r3"></div>

            <div id="droneLayer"></div>

            <div class="asteroidWrap" id="asteroidWrap">
              <div class="ring"></div>
              <div class="asteroid" id="asteroid"><div class="cracks" id="cracks"></div></div>
            </div>
          </div>

          <div class="laser" id="laser1"></div>
          <div class="laser" id="laser2"></div>
        </div>

        <div class="grid">
          <button class="btn good" id="openQuestsBtn">ðŸ“‹ Daily Quests</button>
          <button class="btn secondary" id="reset">Reset</button>
        </div>

        <div class="planetBar">
          <span style="font-size:12px;font-weight:800;color:var(--muted);flex:0 0 auto;">Zone:</span>
          <button class="planetBtn active-iron" id="btnPlanetIron" data-planet="iron">
            <span class="planetDot iron"></span>Iron Belt
          </button>
          <button class="planetBtn" id="btnPlanetVulcan" data-planet="vulcan">
            <span class="planetDot vulcan"></span>Vulcan Core
          </button>
          <button class="planetBtn" id="btnPlanetVoid" data-planet="void">
            <span class="planetDot void"></span>Void Expanse
          </button>
          <button class="btn secondary" id="openPlanetsBtn" style="margin-left:auto;padding:5px 10px;font-size:11px;border-radius:10px;flex-shrink:0;">ðŸª Explore</button>
        </div>

        <!-- Daily Quest preview strip -->
        <div id="questStrip" style="margin-top:10px;display:flex;flex-direction:column;gap:5px;"></div>
      </div>

      <div class="card shop">
        <div class="row" style="justify-content:space-between;">
          <div>
            <b>Dock Shop</b>
            <div class="muted">Upgrades, Cargo Features, Trading.</div>
          </div>
        </div>

        <div class="upgradeHeader">
          <div>
            <b>Modules</b>
            <div class="muted">Drones werden per Upgrade gespawnt (Start: 0).</div>
          </div>
          <div class="tabs" role="tablist" aria-label="Shop tabs">
            <div class="tab active" id="tabCore" role="tab" aria-selected="true">Core</div>
            <div class="tab" id="tabCargo" role="tab" aria-selected="false">Cargo/Trade</div>
            <div class="tab" id="tabSkill" role="tab" aria-selected="false">âš¡ Skills</div>
            <div class="tab" id="tabCos" role="tab" aria-selected="false">Cosmetic</div>
          </div>
        </div>

        <div id="upgradesList" class="upgradeList"></div>

        <div class="panel" style="margin-top:12px;">
          <div class="row" style="justify-content:space-between;">
            <div>
              <b>Offline Haul</b>
              <div class="muted">Credits + Cargo werden offline simuliert.</div>
            </div>
            <button class="btn secondary" id="toggleOffline">Show</button>
          </div>
          <div class="muted" style="margin-top:8px;display:none;" id="offlineText"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <div class="modalBackdrop" id="codexBackdrop" role="dialog" aria-modal="true" aria-label="Ore Codex">
    <div class="modal">
      <div class="modalHeader">
        <div>
          <div class="modalTitle">Ore Codex</div>
          <div class="muted" style="font-size:12px;" id="codexSub">â€”</div>
        </div>
        <button class="btn secondary" id="closeCodex">Close</button>
      </div>
      <div class="modalBody">
        <div class="codexGrid" id="codexGrid"></div>
      </div>
    </div>
  </div>

  <!-- ===== Leaderboard Modal ===== -->
  <div class="modalBackdrop" id="lbBackdrop" role="dialog" aria-modal="true" aria-label="Leaderboard">
    <div class="modal" style="width:min(540px,100%);">
      <div class="modalHeader">
        <div>
          <div class="modalTitle">ðŸ† Leaderboard</div>
          <div class="muted" style="font-size:12px;" id="lbSubLabel">Top Miners</div>
        </div>
        <button class="btn secondary" id="closeLb">Close</button>
      </div>
      <div class="modalBody" style="padding:10px 14px 16px;">

        <!-- Submit score section -->
        <div id="lbSubmitSection" style="margin-bottom:14px;padding:12px;border-radius:16px;background:rgba(102,163,255,.07);border:1px solid rgba(102,163,255,.18);">
          <div style="font-weight:900;font-size:13px;margin-bottom:8px;">ðŸ“¡ Submit Your Score</div>
          <div style="display:flex;gap:8px;align-items:center;">
            <input id="lbUsernameInput" type="text" maxlength="20" placeholder="Miner nameâ€¦"
              style="flex:1;padding:9px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.14);
              background:rgba(0,0,0,.25);color:var(--txt);font-size:13px;font-weight:800;outline:none;
              -webkit-appearance:none;" />
            <input id="lbPinInput" type="password" maxlength="20" placeholder="PINâ€¦"
              style="width:80px;padding:9px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.14);
              background:rgba(0,0,0,.25);color:var(--txt);font-size:13px;font-weight:800;outline:none;
              -webkit-appearance:none;" />
            <button class="btn good" id="lbSubmitBtn" style="padding:9px 16px;flex-shrink:0;">Submit</button>
          </div>
          <div id="lbSubmitStatus" style="font-size:11px;color:var(--muted);margin-top:6px;min-height:16px;">Erster Submit = PIN wird registriert Â· danach schÃ¼tzt er deinen Namen</div>
        </div>

        <!-- Top list -->
        <div id="lbList" style="display:flex;flex-direction:column;gap:6px;">
          <div class="muted" style="text-align:center;padding:20px;">Loadingâ€¦</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Prestige Modal ===== -->
  <div class="modalBackdrop" id="prestigeBackdrop" role="dialog" aria-modal="true">
    <div class="modal" style="width:min(700px,100%);">
      <div class="modalHeader">
        <div>
          <div class="modalTitle">âœ¨ Stellar Prestige</div>
          <div class="muted" style="font-size:12px;" id="prestigeSubLabel">Prestige planets for Stellar Dust</div>
        </div>
        <button class="btn secondary" id="closePrestige">Close</button>
      </div>
      <div class="modalBody" style="padding:10px 14px 16px;max-height:72dvh;overflow-y:auto;" id="prestigeBody"></div>
    </div>
  </div>

  <!-- ===== Planet Overview Modal ===== -->
  <div class="modalBackdrop" id="planetsBackdrop" role="dialog" aria-modal="true" aria-label="Planet Overview">
    <div class="modal" style="width:min(700px,100%);">
      <div class="modalHeader">
        <div>
          <div class="modalTitle">ðŸª Planet Overview</div>
          <div class="muted" style="font-size:12px;" id="planetsSubLabel">Explore and colonize new worlds</div>
        </div>
        <button class="btn secondary" id="closePlanets">Close</button>
      </div>
      <div class="modalBody" style="padding:12px 14px 14px;">
        <div id="planetCardsEl" style="display:flex;flex-direction:column;gap:12px;"></div>
      </div>
    </div>
  </div>

  <!-- ===== Daily Quest Modal ===== -->
  <div class="modalBackdrop" id="questBackdrop" role="dialog" aria-modal="true" aria-label="Daily Quests">
    <div class="modal" style="width:min(560px,100%);">
      <div class="modalHeader">
        <div>
          <div class="modalTitle">ðŸ“‹ Daily Quests</div>
          <div class="muted" style="font-size:12px;" id="questResetLabel">Resets at midnight</div>
        </div>
        <button class="btn secondary" id="closeQuests">Close</button>
      </div>
      <div class="modalBody">
        <div id="questList" style="display:flex;flex-direction:column;gap:10px;"></div>
      </div>
    </div>
  </div>

  <!-- ===== Skill Tree Modal ===== -->
  <div class="modalBackdrop" id="skillBackdrop" role="dialog" aria-modal="true" aria-label="Skill Tree">
    <div class="modal" style="width:min(680px,100%);">
      <div class="modalHeader">
        <div>
          <div class="modalTitle">âš¡ Skill Tree</div>
          <div class="muted" style="font-size:12px;" id="skillSubLabel">Permanent upgrades across all planets</div>
        </div>
        <button class="btn secondary" id="closeSkill">Close</button>
      </div>
      <div class="modalBody" style="padding:10px 14px 14px;">
        <div id="skillTreeEl" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;"></div>
      </div>
    </div>
  </div>
  <div class="modalBackdrop" id="roadmapBackdrop" role="dialog" aria-modal="true" aria-label="Miner Rank Roadmap">
    <div class="modal" style="width:min(600px,100%);">
      <div class="modalHeader">
        <div>
          <div class="modalTitle">ðŸ—º Rank Road</div>
          <div class="muted" style="font-size:12px;" id="roadmapSub">Mining Progression</div>
        </div>
        <button class="btn secondary" id="closeRoadmap">Close</button>
      </div>
      <div class="rmProgress">
        <div style="font-size:12px;font-weight:800;color:var(--muted);white-space:nowrap;" id="rmProgressLabel">MR 1</div>
        <div class="rmProgressBar"><div class="rmProgressFill" id="rmProgressFill"></div></div>
        <div style="font-size:12px;font-weight:800;color:var(--muted);white-space:nowrap;" id="rmProgressRight">0% unlocked</div>
      </div>
      <div class="roadmapScroll">
        <div class="roadmap" id="roadmapList"></div>
      </div>
    </div>
  </div>

<script>
(() => {
  const KEY_NEW = "space_miner_save_v20_quests_skilltree";
  const OLD_KEYS = [
    "space_miner_save_v18_vulcan_planet",
    "space_miner_save_v17_drone_cosmetics_only",
    "space_miner_save_v16_premium_ore_icons_dark_skin",
    "space_miner_save_v15_miner_rank_ore_icons",
    "space_miner_save_v14_spawn_anim_trade_once",
    "space_miner_save_v13", "space_miner_save_v12"
  ];

  const now = () => Date.now();

  const ICONS = {
    laser: `
      <svg viewBox="0 0 24 24" fill="none">
        <path d="M3 16.5h6" stroke="rgba(255,255,255,.9)" stroke-width="2" stroke-linecap="round"/>
        <path d="M3 12h10" stroke="rgba(43,212,255,.9)" stroke-width="2" stroke-linecap="round"/>
        <path d="M3 7.5h7" stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round"/>
        <path d="M14 5l7 7-7 7" stroke="rgba(124,92,255,.9)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>`,
    drones: `
      <svg viewBox="0 0 24 24" fill="none">
        <path d="M12 3v4" stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round"/>
        <path d="M12 17v4" stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round"/>
        <path d="M3 12h4" stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round"/>
        <path d="M17 12h4" stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round"/>
        <rect x="8" y="8" width="8" height="8" rx="2" stroke="rgba(43,212,255,.9)" stroke-width="2"/>
        <path d="M9 9l6 6" stroke="rgba(124,92,255,.8)" stroke-width="2" stroke-linecap="round"/>
      </svg>`,
    ai: `
      <svg viewBox="0 0 24 24" fill="none">
        <path d="M8 8h8v8H8V8Z" stroke="rgba(43,212,255,.9)" stroke-width="2" stroke-linejoin="round"/>
        <path d="M9 12h6" stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round"/>
        <path d="M12 9v6" stroke="rgba(124,92,255,.85)" stroke-width="2" stroke-linecap="round"/>
        <path d="M4 12h3M17 12h3M12 4v3M12 17v3" stroke="rgba(255,255,255,.65)" stroke-width="2" stroke-linecap="round"/>
      </svg>`,
    cargo: `
      <svg viewBox="0 0 24 24" fill="none">
        <path d="M4 8h16v10H4V8Z" stroke="rgba(255,255,255,.9)" stroke-width="2" stroke-linejoin="round"/>
        <path d="M9 8V6h6v2" stroke="rgba(43,212,255,.9)" stroke-width="2" stroke-linecap="round"/>
        <path d="M4 12h16" stroke="rgba(124,92,255,.7)" stroke-width="2" stroke-linecap="round"/>
      </svg>`,
    trade: `
      <svg viewBox="0 0 24 24" fill="none">
        <path d="M7 7h10l-2-2" stroke="rgba(255,255,255,.9)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M17 17H7l2 2" stroke="rgba(43,212,255,.9)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M7 7v6" stroke="rgba(124,92,255,.8)" stroke-width="2" stroke-linecap="round"/>
        <path d="M17 11v6" stroke="rgba(124,92,255,.8)" stroke-width="2" stroke-linecap="round"/>
      </svg>`,
    prospect: `
      <svg viewBox="0 0 24 24" fill="none">
        <path d="M12 3l2.5 6H21l-5 3.6 2 6.4-6-4.1-6 4.1 2-6.4-5-3.6h6.5L12 3z"
          stroke="rgba(43,212,255,.9)" stroke-width="2" stroke-linejoin="round"/>
      </svg>`,
    coin: `
      <svg viewBox="0 0 24 24" fill="none">
        <path d="M12 3c4.4 0 8 2.2 8 5s-3.6 5-8 5-8-2.2-8-5 3.6-5 8-5Z" stroke="rgba(255,255,255,.9)" stroke-width="2"/>
        <path d="M4 8v8c0 2.8 3.6 5 8 5s8-2.2 8-5V8" stroke="rgba(43,212,255,.9)" stroke-width="2" stroke-linecap="round"/>
        <path d="M9.5 6.8h5" stroke="rgba(124,92,255,.85)" stroke-width="2" stroke-linecap="round"/>
      </svg>`,
    skin: `
      <svg viewBox="0 0 24 24" fill="none">
        <path d="M6 7h12v10H6V7Z" stroke="rgba(255,255,255,.9)" stroke-width="2" stroke-linejoin="round"/>
        <path d="M8 9h8" stroke="rgba(43,212,255,.9)" stroke-width="2" stroke-linecap="round"/>
        <path d="M8 12h6" stroke="rgba(124,92,255,.85)" stroke-width="2" stroke-linecap="round"/>
        <path d="M8 15h8" stroke="rgba(255,255,255,.75)" stroke-width="2" stroke-linecap="round"/>
      </svg>`
  };

  /* ===== Premium Ore Icons ===== */
  let ORE_ICON_UID = 0;
  function oreSvgFactory(kind, uid){
    const g = `url(#g_${kind}_${uid})`;
    const f = `url(#f_${kind}_${uid})`;
    const defs = (stops)=>`
      <defs>
        <linearGradient id="g_${kind}_${uid}" x1="0" y1="0" x2="1" y2="1">${stops}</linearGradient>
        <filter id="f_${kind}_${uid}" x="-50%" y="-50%" width="200%" height="200%">
          <feDropShadow dx="0" dy="0" stdDeviation="1.2" flood-color="rgba(255,255,255,.12)"/>
          <feDropShadow dx="0" dy="0" stdDeviation="2.6" flood-color="rgba(102,163,255,.12)"/>
        </filter>
      </defs>`;
    const base = (main, hi) => `<svg viewBox="0 0 24 24" fill="none" filter="${f}">${main}${hi}</svg>`;
    if(kind==="iron"){
      return base(
        `${defs(`<stop offset="0" stop-color="#f2f6ff"/><stop offset=".35" stop-color="#a9b9d6"/><stop offset=".72" stop-color="#5e7499"/><stop offset="1" stop-color="#2a3550"/>`)}
         <path d="M8 4l-4 7 6 9h7l3-7-6-9H8Z" stroke="${g}" stroke-width="2.2" stroke-linejoin="round"/>`,
        `<path d="M8.6 6.2l6.5-.1" stroke="rgba(255,255,255,.55)" stroke-width="1.4" stroke-linecap="round"/>
         <path d="M9 10l2 3M13 9l2 4" stroke="rgba(255,255,255,.50)" stroke-width="2" stroke-linecap="round"/>`
      );
    }
    if(kind==="nickel"){
      return base(
        `${defs(`<stop offset="0" stop-color="#f6fbff"/><stop offset=".38" stop-color="#c7d7ff"/><stop offset=".75" stop-color="#6b88c2"/><stop offset="1" stop-color="#2f3f64"/>`)}
         <path d="M7 5h10l3 7-5 7H9l-5-7 3-7Z" stroke="${g}" stroke-width="2.2" stroke-linejoin="round"/>
         <path d="M9.1 9.2h.01M15 9.2h.01" stroke="rgba(255,255,255,.65)" stroke-width="3.2" stroke-linecap="round"/>`,
        `<path d="M9 13h6" stroke="rgba(255,255,255,.55)" stroke-width="2.1" stroke-linecap="round"/>
         <path d="M8.2 6.8l7.6.1" stroke="rgba(255,255,255,.45)" stroke-width="1.3" stroke-linecap="round"/>`
      );
    }
    if(kind==="cobalt"){
      return base(
        `${defs(`<stop offset="0" stop-color="#e9fbff"/><stop offset=".35" stop-color="#73f3ff"/><stop offset=".7" stop-color="#2bb5ff"/><stop offset="1" stop-color="#3c3a8b"/>`)}
         <path d="M12 3l7 9-7 9-7-9 7-9Z" stroke="${g}" stroke-width="2.2" stroke-linejoin="round"/>
         <path d="M12 7v10" stroke="rgba(255,255,255,.62)" stroke-width="2" stroke-linecap="round"/>`,
        `<path d="M9.5 10.5h5" stroke="rgba(255,255,255,.45)" stroke-width="2" stroke-linecap="round"/>
         <path d="M10 6.7l4 .3" stroke="rgba(255,255,255,.35)" stroke-width="1.2" stroke-linecap="round"/>`
      );
    }
    if(kind==="gold"){
      return base(
        `${defs(`<stop offset="0" stop-color="#fff7d6"/><stop offset=".35" stop-color="#ffd27a"/><stop offset=".7" stop-color="#ff9f1a"/><stop offset="1" stop-color="#7a3a00"/>`)}
         <path d="M7 6l-3 6 4 7h9l3-6-5-7H7Z" stroke="${g}" stroke-width="2.2" stroke-linejoin="round"/>`,
        `<path d="M16.5 6.5l.7 1.9 1.8.7-1.8.7-.7 1.9-.7-1.9-1.8-.7 1.8-.7.7-1.9Z" fill="rgba(255,255,255,.70)"/>
         <path d="M8.4 7.3l6.6.1" stroke="rgba(255,255,255,.42)" stroke-width="1.3" stroke-linecap="round"/>`
      );
    }
    if(kind==="platinum"){
      return base(
        `${defs(`<stop offset="0" stop-color="#f2eeff"/><stop offset=".35" stop-color="#c1b2ff"/><stop offset=".72" stop-color="#7c5cff"/><stop offset="1" stop-color="#2b1a66"/>`)}
         <path d="M12 3l6 4v10l-6 4-6-4V7l6-4Z" stroke="${g}" stroke-width="2.2" stroke-linejoin="round"/>
         <path d="M12 7l4 3-4 3-4-3 4-3Z" stroke="rgba(255,255,255,.55)" stroke-width="2" stroke-linejoin="round"/>`,
        `<path d="M9.2 6.6l5.6.2" stroke="rgba(255,255,255,.40)" stroke-width="1.2" stroke-linecap="round"/>`
      );
    }
    if(kind==="pyrite"){
      return base(
        `${defs(`<stop offset="0" stop-color="#fff0d0"/><stop offset=".30" stop-color="#ffaa50"/><stop offset=".65" stop-color="#e05a10"/><stop offset="1" stop-color="#5a1a04"/>`)}
         <path d="M6 5l-2 7 5 8h7l4-7-5-8H6Z" stroke="${g}" stroke-width="2.2" stroke-linejoin="round"/>
         <path d="M9 9l1.5 2.5M13 8l2 3" stroke="rgba(255,255,255,.55)" stroke-width="1.8" stroke-linecap="round"/>`,
        `<path d="M8.5 6.5l7 .2" stroke="rgba(255,200,80,.50)" stroke-width="1.3" stroke-linecap="round"/>
         <path d="M16 7l.6 1.6 1.6.6-1.6.6-.6 1.6-.6-1.6-1.6-.6 1.6-.6.6-1.6Z" fill="rgba(255,220,100,.72)"/>`
      );
    }
    if(kind==="obsidian"){
      return base(
        `${defs(`<stop offset="0" stop-color="#ffd0a0"/><stop offset=".28" stop-color="#ff6030"/><stop offset=".62" stop-color="#a02010"/><stop offset="1" stop-color="#280600"/>`)}
         <path d="M12 3l5 5-2 5 2 5-5 3-5-3 2-5-2-5 5-5Z" stroke="${g}" stroke-width="2.2" stroke-linejoin="round"/>`,
        `<path d="M12 7v10" stroke="rgba(255,120,60,.55)" stroke-width="2" stroke-linecap="round"/>
         <path d="M9.5 9.5h5" stroke="rgba(255,200,80,.45)" stroke-width="1.6" stroke-linecap="round"/>
         <path d="M10 14h4" stroke="rgba(255,80,20,.55)" stroke-width="1.6" stroke-linecap="round"/>`
      );
    }
    if(kind==="voidShard"){
      return base(
        `${defs(`<stop offset="0" stop-color="#f5f0ff"/><stop offset=".30" stop-color="#c084fc"/><stop offset=".65" stop-color="#7c3aed"/><stop offset="1" stop-color="#2e1065"/>`)}
         <path d="M12 3l3 5 5 2-4 4 1 6-5-3-5 3 1-6-4-4 5-2 3-5Z" stroke="${g}" stroke-width="2.2" stroke-linejoin="round"/>`,
        `<path d="M12 7v10M9 10l3-3 3 3" stroke="rgba(255,255,255,.55)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>`
      );
    }
    if(kind==="darkMatter"){
      return base(
        `${defs(`<stop offset="0" stop-color="#fdf4ff"/><stop offset=".25" stop-color="#e879f9"/><stop offset=".60" stop-color="#9333ea"/><stop offset="1" stop-color="#1a0040"/>`)}
         <path d="M12 2l2 4 4 2-3 3 1 5-4-2-4 2 1-5-3-3 4-2 2-4Z" stroke="${g}" stroke-width="2.2" stroke-linejoin="round"/>
         <circle cx="12" cy="12" r="2.5" stroke="rgba(255,255,255,.65)" stroke-width="1.5"/>`,
        `<path d="M5 5l2 2M17 5l-2 2M5 19l2-2M17 19l-2-2" stroke="rgba(255,255,255,.45)" stroke-width="1.5" stroke-linecap="round"/>
         <path d="M15 7l1 1 1-1" fill="rgba(255,255,255,.70)"/>`
      );
    }
    /* coin icon for labels */
    if(kind==="coin"){
      return `<svg viewBox="0 0 24 24" fill="none">
        <path d="M12 3c4.4 0 8 2.2 8 5s-3.6 5-8 5-8-2.2-8-5 3.6-5 8-5Z" stroke="rgba(255,255,255,.9)" stroke-width="2"/>
        <path d="M4 8v8c0 2.8 3.6 5 8 5s8-2.2 8-5V8" stroke="rgba(43,212,255,.9)" stroke-width="2" stroke-linecap="round"/>
      </svg>`;
    }
    return `<svg viewBox="0 0 24 24" fill="none"><path d="M12 4l8 8-8 8-8-8 8-8Z" stroke="rgba(255,255,255,.8)" stroke-width="2"/></svg>`;
  }
  function oreIconHTML(id, size=16){
    const uid = (++ORE_ICON_UID);
    const svg = oreSvgFactory(id, uid);
    return `<span class="ico" style="width:${size}px;height:${size}px">${svg}</span>`;
  }
  function miniIconWrap(svg, size=20){
    return `<span class="miniIcon" style="width:${size}px;height:${size}px">${svg}</span>`;
  }

  const ORES = [
    { id:"iron",     name:"Iron",      value: 8,   rarity: 0.55,  unlockMR: 1,  color:"rgba(255,204,102,.92)", planet:"iron" },
    { id:"nickel",   name:"Nickel",    value: 14,   rarity: 0.28,  unlockMR: 2,  color:"rgba(210,230,255,.90)", planet:"iron" },
    { id:"cobalt",   name:"Cobalt",    value: 25,  rarity: 0.13,  unlockMR: 4,  color:"rgba(43,212,255,.92)",  planet:"iron" },
    { id:"gold",     name:"Gold",      value: 55,  rarity: 0.035, unlockMR: 6,  color:"rgba(255,204,102,.98)", planet:"iron" },
    { id:"platinum", name:"Platinum",  value: 110,  rarity: 0.005, unlockMR: 8,  color:"rgba(124,92,255,.92)",  planet:"iron" },
    { id:"pyrite",   name:"Pyrolusite",value: 140,  rarity: 0.30,  unlockMR: 10, color:"rgba(255,140,60,.95)",  planet:"vulcan" },
    { id:"obsidian", name:"Obsidian",  value: 380, rarity: 0.06,  unlockMR: 10, color:"rgba(255,80,30,.95)",   planet:"vulcan" },
    { id:"voidShard",   name:"Void Shard",   value: 600, rarity: 0.22,  unlockMR: 15, color:"rgba(167,139,250,.95)", planet:"void" },
    { id:"darkMatter",  name:"Dark Matter",  value: 2000, rarity: 0.04,  unlockMR: 15, color:"rgba(216,180,254,.98)", planet:"void" },
  ];

  const PLANETS = {
    iron: {
      id:"iron", name:"Iron Belt",
      laserMult:1, creditMult:1, xpMult:1,
      prestigeBaseCost: 500000,
    },
    vulcan: {
      id:"vulcan", name:"Vulcan Core",
      unlockMR: 10, unlockCredits: 50000,
      laserMult:1, creditMult:2.5, xpMult:1.5,
      prestigeBaseCost: 2000000,
    },
    void: {
      id:"void", name:"Void Expanse",
      unlockMR: 15, unlockCredits: 150000,
      laserMult:1, creditMult:5, xpMult:2,
      prestigeBaseCost: 8000000,
      voidSurgeChance: 0.08,
    }
  };

  const STELLAR_DUST_PER_PRESTIGE = 10;

  const PRESTIGE_UPGRADES = [
    // âš¡ Power
    { id:"p1", cat:"power",  name:"Stellar Forge",     desc:"+15% laser credits globally",    cost:3,  effect:{ laserCreditMult:0.15 } },
    { id:"p2", cat:"power",  name:"Ion Drill",          desc:"+20% ore drop rate globally",    cost:5,  effect:{ allDropChance:0.20 } },
    { id:"p3", cat:"power",  name:"Plasma Edge",        desc:"+25% crit damage multiplier",    cost:8,  effect:{ critMult:0.25 } },
    { id:"p4", cat:"power",  name:"Quantum Pick",       desc:"+30% laser credits globally",    cost:12, effect:{ laserCreditMult:0.30 } },
    { id:"p5", cat:"power",  name:"Neutron Core",       desc:"+40% ore drop rate globally",    cost:20, effect:{ allDropChance:0.40 } },
    { id:"p6", cat:"power",  name:"Singularity Drill",  desc:"+50% all mining income",         cost:35, effect:{ globalCreditMult:0.50 } },
    // ðŸŒŒ Cosmic
    { id:"c1", cat:"cosmic", name:"Void Market",        desc:"+20% credits from all sales",    cost:4,  effect:{ sellMult:0.20 } },
    { id:"c2", cat:"cosmic", name:"Dark Economy",       desc:"+25% drone credit yield",        cost:6,  effect:{ droneCreditMult:0.25 } },
    { id:"c3", cat:"cosmic", name:"Nebula Trade",       desc:"+30% credits from all sources",  cost:10, effect:{ globalCreditMult:0.30 } },
    { id:"c4", cat:"cosmic", name:"Stellar Commerce",   desc:"+50 cargo capacity",             cost:15, effect:{ cargoCap:50 } },
    { id:"c5", cat:"cosmic", name:"Galactic Exchange",  desc:"+40% drone credit yield",        cost:25, effect:{ droneCreditMult:0.40 } },
    { id:"c6", cat:"cosmic", name:"Universal Trade",    desc:"+75% all credit gains",          cost:40, effect:{ globalCreditMult:0.75 } },
    // ðŸ”® Arcane
    { id:"a1", cat:"arcane", name:"Astral Sense",       desc:"+25% rare ore drop chance",      cost:5,  effect:{ rareDropMult:0.25 } },
    { id:"a2", cat:"arcane", name:"Void Pulse",         desc:"+25% drone orbit speed",         cost:7,  effect:{ dronePulseMult:0.25 } },
    { id:"a3", cat:"arcane", name:"Cosmic Memory",      desc:"+50% offline income",            cost:10, effect:{ offlineMult:0.50 } },
    { id:"a4", cat:"arcane", name:"Dark Resonance",     desc:"+40% mining XP gain",            cost:16, effect:{ xpMult:0.40 } },
    { id:"a5", cat:"arcane", name:"Nebula Sight",       desc:"+50% rare ore drop chance",      cost:28, effect:{ rareDropMult:0.50 } },
    { id:"a6", cat:"arcane", name:"Stellar Ascension",  desc:"+2\u00d7 all Stellar Dust earned",    cost:45, effect:{ dustMult:1.0 } },
  ];

  const PRESTIGE_CATS = {
    power:  { label:"âš¡ Power",  color:"rgba(43,212,255," },
    cosmic: { label:"ðŸŒŒ Cosmic", color:"rgba(124,92,255," },
    arcane: { label:"ðŸ”® Arcane", color:"rgba(255,100,200," },
  };

  const MR_MILESTONES = {
    2:  "Unlock: Nickel ore.",
    4:  "Unlock: Cobalt ore.",
    6:  "Unlock: Gold ore + Trade Terminal.",
    8:  "Unlock: Platinum ore.",
    10: "Unlock: Vulcan Core + Pyrolusite & Obsidian ore. +Cargo Capacity."
  };

  function miningNeedFor(rank){
    // Soft early, exponential wall post MR10, brutal post MR20
    const r = rank - 1;
    if(rank <= 5)  return Math.floor(120 + r * 60);
    if(rank <= 10) return Math.floor(500 + r * 180 + Math.pow(r, 1.6) * 30);
    if(rank <= 20) return Math.floor(2000 + r * 800 + Math.pow(r, 2.0) * 55);
    if(rank <= 30) return Math.floor(8000 + r * 3200 + Math.pow(r, 2.3) * 120);
    return Math.floor(30000 + r * 12000 + Math.pow(r, 2.6) * 300);
  }

  function defaultOreSettings(){
    const s = {};
    for(const o of ORES){
      s[o.id] = { locked:false, keep:0, autoSellMode:"off" };
    }
    return s;
  }

  function defaultPlanetState(planetId){
    return {
      laserLvl: 0,
      dronesLvl: 0,
      droneAI: 0,
      laserPower: 1,
      rps: 0,
      costLaser:    planetId === "void" ? 1200  : planetId === "vulcan" ? 350  : 80,
      costDrones:   planetId === "void" ? 4500  : planetId === "vulcan" ? 1200 : 320,
      costDroneAI:  planetId === "void" ? 8000  : planetId === "vulcan" ? 2500 : 700,
      prospectLvl:  0,
      costProspect: planetId === "void" ? 5500  : planetId === "vulcan" ? 1800 : 500,
    };
  }

  /* ===== Drone cosmetics (ONLY drones) ===== */
  const DRONE_SKINS = [
    { id:"default", name:"Default Drone", css:"", cost:0, desc:"Standard hull + classic glow." },
    { id:"carbon",  name:"Stealth Carbon", css:"skin-carbon", cost:260, desc:"Dark carbon body + green bio-LEDs." },
    { id:"neon",    name:"Neon Pulse", css:"skin-neon", cost:420, desc:"Cyan/violet glow + extra punchy beam." },
    { id:"solar",   name:"Solar Alloy", css:"skin-solar", cost:680, desc:"Gold alloy + warm thruster flame." },
  ];

  function defaultState(){
    const cargo = {}, sellPlan = {};
    for(const o of ORES){ cargo[o.id]=0; sellPlan[o.id]=0; }

    return {
      credits: 60,

      minerRank: 1,
      miningXP: 0,
      miningNeed: miningNeedFor(1),
      perksUnlocked: { capacityBoost:false, rareBoost:false },

      planets: {
        iron:   defaultPlanetState("iron"),
        vulcan: defaultPlanetState("vulcan"),
      },

      laserPower: 1,
      rps: 0,

      cargoTier: 1,
      cargoCap: 120,
      cargo,
      sellPlan,

      oreSettings: defaultOreSettings(),
      autoSellOnFull: true,

      boostUntil: 0,

      lastSeen: now(),
      lastOfflineSummary: "",

      trades: { seed:0, nextReroll:0, offers:[] },

      recentUnlocks: [],
      shopTab: "core",

      currentPlanet: "iron",

      // Daily quests
      quests: { date:"", list:[] },

      // Skill tree: owned node ids
      skills: [],

      // Prestige
      stellarDust: 0,
      prestigeUpgrades: [],        // owned prestige upgrade ids
      prestigeCount: { iron:0, vulcan:0, void:0 },  // how many times each planet was prestiged

      cosmetics: {
        droneSkin: "default",
        owned: { default:true, carbon:false, neon:false, solar:false }
      }
    };
  }

  function readSaveAny(){
    const rawNew = localStorage.getItem(KEY_NEW);
    if(rawNew) return rawNew;
    for(const k of OLD_KEYS){
      const raw = localStorage.getItem(k);
      if(raw) return raw;
    }
    return null;
  }

  function load(){
    try{
      const raw = readSaveAny();
      if(!raw){
        const s = defaultState();
        applyStats(s);
        return s;
      }

      const base = defaultState();
      const parsed = JSON.parse(raw);
      const s = { ...base, ...parsed };

      s.minerRank  = s.minerRank  ?? 1;
      s.miningXP   = s.miningXP   ?? 0;
      s.miningNeed = s.miningNeed ?? miningNeedFor(s.minerRank);

      s.cargo    = { ...base.cargo,    ...(s.cargo||{}) };
      s.sellPlan = { ...base.sellPlan, ...(s.sellPlan||{}) };
      s.perksUnlocked = { ...base.perksUnlocked, ...(s.perksUnlocked||{}) };
      s.trades   = s.trades || base.trades;

      /* ---- migrate flat old save into per-planet structure ---- */
      s.planets = s.planets || {};
      for(const pid of ["iron","vulcan"]){
        const def = defaultPlanetState(pid);
        s.planets[pid] = { ...def, ...(s.planets[pid]||{}) };
      }
      if(!parsed.planets && parsed.laserLvl !== undefined){
        s.planets.iron.laserLvl    = parsed.laserLvl    ?? 0;
        s.planets.iron.dronesLvl   = parsed.dronesLvl   ?? 0;
        s.planets.iron.droneAI     = parsed.droneAI     ?? 0;
        s.planets.iron.costLaser   = parsed.costLaser   ?? 25;
        s.planets.iron.costDrones  = parsed.costDrones  ?? 85;
        s.planets.iron.costDroneAI = parsed.costDroneAI ?? 140;
        s.planets.iron.prospectLvl = parsed.prospectLvl ?? 0;
        s.planets.iron.costProspect= parsed.costProspect?? 95;
      }

      // migrate quests & skills
      s.quests = s.quests || { date:"", list:[] };
      s.skills = Array.isArray(s.skills) ? s.skills : [];
      // migrate prestige
      s.stellarDust = s.stellarDust || 0;
      s.prestigeUpgrades = Array.isArray(s.prestigeUpgrades) ? s.prestigeUpgrades : [];
      s.prestigeCount = s.prestigeCount || { iron:0, vulcan:0, void:0 };
      if(s.prestigeCount.void === undefined) s.prestigeCount.void = 0;

      const fresh = defaultOreSettings();
      const old = s.oreSettings || {};
      s.oreSettings = {};
      for(const o of ORES){
        const prev = old[o.id] || {};
        const migrated = { ...fresh[o.id], ...prev };
        if(typeof migrated.autoSell === "boolean" && migrated.autoSellMode === "off"){
          migrated.autoSellMode = migrated.autoSell ? "overflow" : "off";
        }
        delete migrated.autoSell;
        s.oreSettings[o.id] = migrated;
      }

      s.recentUnlocks = Array.isArray(s.recentUnlocks) ? s.recentUnlocks : [];
      s.recentUnlocks = s.recentUnlocks.filter(x => x && x.id && x.ts).slice(-10);

      s.planets.iron.dronesLvl   = Math.max(0, Math.min(24, Math.floor(s.planets.iron.dronesLvl||0)));
      s.planets.iron.droneAI     = Math.max(0, Math.min(50, Math.floor(s.planets.iron.droneAI||0)));
      s.planets.vulcan.dronesLvl = Math.max(0, Math.min(24, Math.floor(s.planets.vulcan.dronesLvl||0)));
      s.planets.vulcan.droneAI   = Math.max(0, Math.min(50, Math.floor(s.planets.vulcan.droneAI||0)));
      // Balance migration: reset upgrade costs if they're from old low-cost version
      if(s.planets.iron && s.planets.iron.costLaser < 80)
        s.planets.iron = { ...defaultPlanetState("iron"), laserLvl:s.planets.iron.laserLvl||0, dronesLvl:s.planets.iron.dronesLvl||0, droneAI:s.planets.iron.droneAI||0, prospectLvl:s.planets.iron.prospectLvl||0 };
      if(s.planets.vulcan && s.planets.vulcan.costLaser < 350)
        s.planets.vulcan = { ...defaultPlanetState("vulcan"), laserLvl:s.planets.vulcan.laserLvl||0, dronesLvl:s.planets.vulcan.dronesLvl||0, droneAI:s.planets.vulcan.droneAI||0, prospectLvl:s.planets.vulcan.prospectLvl||0 };
      if(!s.planets.void){ s.planets.void = defaultPlanetState('void'); }
      s.planets.void.dronesLvl = Math.max(0, Math.min(24, Math.floor(s.planets.void.dronesLvl||0)));
      s.planets.void.droneAI   = Math.max(0, Math.min(50, Math.floor(s.planets.void.droneAI||0)));

      if(s.trades && Array.isArray(s.trades.offers)){
        s.trades.offers = s.trades.offers.map(of => of ? ({ used:false, ...of }) : of);
      }

      s.cosmetics = s.cosmetics || base.cosmetics;
      if(!s.cosmetics.owned) s.cosmetics.owned = { ...base.cosmetics.owned };
      if(!s.cosmetics.droneSkin) s.cosmetics.droneSkin = "default";
      for(const k of Object.keys(base.cosmetics.owned)){
        s.cosmetics.owned[k] = !!s.cosmetics.owned[k];
      }
      if(!s.cosmetics.owned.default) s.cosmetics.owned.default = true;
      if(!s.cosmetics.owned[s.cosmetics.droneSkin]) s.cosmetics.droneSkin = "default";

      s.currentPlanet = s.currentPlanet || "iron";
      if(!PLANETS[s.currentPlanet]) s.currentPlanet = "iron";
      if(s.currentPlanet !== "iron" && s.minerRank < PLANETS[s.currentPlanet].unlockMR) s.currentPlanet = "iron";

      applyStats(s);
      return s;
    }catch(e){
      console.error("Load error:", e);
      const s = defaultState();
      applyStats(s);
      return s;
    }
  }
  function save(){ localStorage.setItem(KEY_NEW, JSON.stringify(state)); }

  function applyPlanetVisuals(){
    const p = state.currentPlanet;
    const isVulcan = p === "vulcan";

    clickArea.classList.toggle("planet-vulcan", isVulcan);
    asteroid.classList.toggle("planet-vulcan", isVulcan);
    clickArea.classList.toggle("planet-void", p === "void");
    asteroid.classList.toggle("planet-void", p === "void");
    const ring = asteroidWrap.querySelector(".ring");
    if(ring) ring.classList.toggle("planet-vulcan", isVulcan);

    const btnIron   = el("btnPlanetIron");
    const btnVulcan = el("btnPlanetVulcan");
    const btnVoid   = el("btnPlanetVoid");
    const vulcanDef = PLANETS.vulcan;
    const voidDef   = PLANETS.void;
    const vulcanRankLocked = state.minerRank < (vulcanDef.unlockMR||10);
    const voidRankLocked   = state.minerRank < (voidDef.unlockMR||15);
    const vulcanBought = !!(state.planetsBought?.vulcan);
    const voidBought   = !!(state.planetsBought?.void);

    const ironDrones   = state.planets?.iron?.dronesLvl   || 0;
    const vulcanDrones = state.planets?.vulcan?.dronesLvl || 0;
    const voidDrones   = state.planets?.void?.dronesLvl   || 0;

    btnIron.innerHTML   = `<span class="planetDot iron"></span>Iron Belt${ironDrones>0 ? ` <span style="color:var(--good);font-size:11px;">(${ironDrones}ðŸ›¸)</span>` : ""}`;
    btnVulcan.innerHTML = `<span class="planetDot vulcan"></span>Vulcan Core${vulcanDrones>0 ? ` <span style="color:#ffb060;font-size:11px;">(${vulcanDrones}ðŸ›¸)</span>` : ""}`;
    if(btnVoid) btnVoid.innerHTML = `<span class="planetDot void"></span>Void Expanse${voidDrones>0 ? ` <span style="color:#c084fc;font-size:11px;">(${voidDrones}ðŸ›¸)</span>` : ""}`;

    const isVoid = p === "void";
    btnIron.classList.toggle("active-iron", !isVulcan && !isVoid);
    btnVulcan.classList.toggle("active-vulcan", isVulcan);
    if(btnVoid) btnVoid.classList.toggle("active-void", isVoid);
    btnVulcan.disabled = vulcanRankLocked && !vulcanBought;
    btnVulcan.title = vulcanRankLocked ? `Requires MR ${vulcanDef.unlockMR}` : vulcanBought ? "Switch to Vulcan Core" : `Colonize for ${fmt(vulcanDef.unlockCredits)}c`;
    if(btnVoid){ btnVoid.disabled = voidRankLocked && !voidBought; btnVoid.title = voidRankLocked ? `Requires MR ${voidDef.unlockMR}` : voidBought ? "Switch to Void Expanse" : `Colonize for ${fmt(voidDef.unlockCredits)}c`; }
  }

  function switchPlanet(planetId){
    const planet = PLANETS[planetId];
    if(!planet) return;
    if(planet.unlockMR && state.minerRank < planet.unlockMR){
      toast(`Requires Miner Rank ${planet.unlockMR}`);
      return;
    }
    if(planet.unlockCredits && !state.planetsBought?.[planetId]){
      if(state.credits < planet.unlockCredits){
        toast(`Requires ${fmt(planet.unlockCredits)} credits to unlock`);
        return;
      }
      // purchase
      state.credits -= planet.unlockCredits;
      state.planetsBought = state.planetsBought || {};
      state.planetsBought[planetId] = true;
      toast(`${planet.name} unlocked for ${fmt(planet.unlockCredits)}c!`);
      spawnParticles(20);
    }
    state.currentPlanet = planetId;
    applyPlanetVisuals();
    applyStats(state);
    syncSpawnedDrones();
    setCargoDirtyAll();
    renderCargoPanelsIfDirty();
    buildTab(state.shopTab);
    save();
    toast(`Warped to ${planet.name}!`);
    spawnParticles(16);
  }

  function fmt(n){
    n = Number(n)||0;
    if (n < 1000) return String(Math.floor(n));
    if (n < 1e6) return (n/1000).toFixed(1).replace(".0","") + "k";
    return (n/1e6).toFixed(2).replace(".00","") + "m";
  }
  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
  function boostMult(){ return now() < state.boostUntil ? 2 : 1; }
  function mmss(ms){
    const s = Math.max(0, Math.floor(ms/1000));
    const m = Math.floor(s/60);
    const r = s % 60;
    return `${m}:${String(r).padStart(2,"0")}`;
  }

  function totalCargoUnits(){ return Object.values(state.cargo).reduce((a,b)=>a+b,0); }

  /* ---- Active / specific planet sub-state accessor ---- */
  function P(planetId){ return state.planets[planetId || state.currentPlanet]; }

  function currentPlanetDef(){ return PLANETS[state.currentPlanet] || PLANETS.iron; }
  function planetCreditMult(planetId){ return PLANETS[planetId || state.currentPlanet]?.creditMult || 1; }
  function planetXpMult(){ return currentPlanetDef().xpMult || 1; }

  function oreUnlocked(id){
    const o = ORES.find(x=>x.id===id);
    if(!o) return false;
    if(state.minerRank < o.unlockMR) return false;
    // Vulcan ores only available on Vulcan planet
    if(o.planet && o.planet !== "iron" && state.currentPlanet !== o.planet) return false;
    return true;
  }
  function oreValue(id){ const o = ORES.find(x=>x.id===id); return o ? o.value : 0; }

  function dronePulsesPerSecondFor(p){
    const base = 0.22;
    const ai = (p.droneAI||0);
    return Math.min(1.05, base + ai*0.05);
  }
  function droneCreditsPerPulseFor(p, planetId){
    const base = Math.max(1, Math.floor((p.laserPower||1) * 0.65));
    const ai = Math.floor((p.droneAI||0) / 3);
    const mult = PLANETS[planetId]?.creditMult || 1;
    return Math.round((base + ai) * mult);
  }

  function applyStatsPlanet(s, pid){
    const p = s.planets[pid];
    if(!p) return;
    p.laserPower = 1 + (p.laserLvl||0);
    const speed = dronePulsesPerSecondFor(p);
    const cpp   = droneCreditsPerPulseFor(p, pid);
    p.rps = Math.round(((p.dronesLvl||0) * speed * cpp) * 10)/10;
  }

  function applyStats(s){
    s.planets = s.planets || {};
    for(const pid of Object.keys(PLANETS)) applyStatsPlanet(s, pid);
    const ap = s.planets[s.currentPlanet];
    if(ap){ s.laserPower = ap.laserPower; s.rps = ap.rps; }
    const base = 120 + (s.cargoTier-1)*50;
    const perk = s.perksUnlocked?.capacityBoost ? 30 : 0;
    const skill = skillBonusFlat("cargoCap", s);
    s.cargoCap = base + perk + skill;
  }

  const el = (id)=>document.getElementById(id);
  const creditsEl = el("credits");
  const rpsEl = el("rps");
  const laserPowerEl = el("laserPower");
  const minerRankEl = el("minerRank");
  const xpNowEl = el("xpNow");
  const xpNeedEl = el("xpNeed");
  const xpBarEl = el("xpBar");
  const rankPerkTextEl = el("rankPerkText");
  const nextUnlockTextEl = el("nextUnlockText");
  const upgradesListEl = el("upgradesList");
  const tabCore = el("tabCore");
  const tabCargo = el("tabCargo");
  const tabCos = el("tabCos");
  const offlineTextEl = el("offlineText");
  const toggleOfflineBtn = el("toggleOffline");
  const clickArea = el("clickArea");
  const stage = el("stage");
  const droneLayer = el("droneLayer");
  const asteroidWrap = el("asteroidWrap");
  const asteroid = el("asteroid");
  const cracks = el("cracks");
  const laser1 = el("laser1");
  const laser2 = el("laser2");

  const codexBackdrop = el("codexBackdrop");
  const codexGrid = el("codexGrid");
  const codexSub = el("codexSub");
  const closeCodexBtn = el("closeCodex");

  const toastEl = el("toast");
  function toast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    setTimeout(()=>toastEl.classList.remove("show"), 1200);
  }

  function spawnPop(text, special=false, xPct=null, yPct=null, iconHTML=null){
    const p = document.createElement("div");
    p.className = "pop";
    p.style.left = (xPct ?? (35 + Math.random()*30)) + "%";
    p.style.top  = (yPct ?? (45 + Math.random()*20)) + "%";
    p.style.fontSize = special ? "18px" : "16px";
    p.style.color = special ? "#ffcc66" : "#ffffff";
    if(iconHTML){ p.innerHTML = `${iconHTML}<span>${text}</span>`; }
    else p.textContent = text;
    clickArea.appendChild(p);
    setTimeout(()=>p.remove(), 1000);
  }

  function spawnDronePopAt(x, y, text, kind="credit", iconHTML=""){
    const p = document.createElement("div");
    p.className = `dronePop ${kind}`;
    p.style.left = `${x}px`;
    p.style.top  = `${y}px`;
    p.style.setProperty("--dx", `${(Math.random()*24 - 12).toFixed(1)}px`);
    p.style.setProperty("--dy", `${(-14 - Math.random()*10).toFixed(1)}px`);
    p.innerHTML = `${iconHTML}${text}`;
    stage.appendChild(p);
    setTimeout(()=>p.remove(), 1150);
  }
  function spawnDronePop(droneEl, text, kind="credit", iconHTML=""){
    const stageRect = stage.getBoundingClientRect();
    const dRect = droneEl.getBoundingClientRect();
    const x = (dRect.left - stageRect.left) + dRect.width/2;
    const y = (dRect.top  - stageRect.top ) + dRect.height/2 - 16;
    spawnDronePopAt(x, y, text, kind, iconHTML);
  }

  function spawnParticles(count=12, atX=null, atY=null){
    const rect = stage.getBoundingClientRect();
    const ox = atX ?? rect.width/2, oy = atY ?? rect.height/2;
    for(let i=0;i<count;i++){
      const p = document.createElement("div");
      p.className = "particle";
      const r = Math.random();
      const col = r<0.55 ? "rgba(43,212,255,.9)" : (r<0.85 ? "rgba(255,255,255,.85)" : "rgba(255,204,102,.95)");
      p.style.background = col;
      const ang = Math.random()*Math.PI*2;
      const dist = 16 + Math.random()*48;
      p.style.setProperty("--dx", (Math.cos(ang)*dist).toFixed(1)+"px");
      p.style.setProperty("--dy", (Math.sin(ang)*dist).toFixed(1)+"px");
      p.style.left = (ox + (Math.random()*6-3)) + "px";
      p.style.top  = (oy + (Math.random()*6-3)) + "px";
      stage.appendChild(p);
      setTimeout(()=>p.remove(), 650);
    }
  }

  function fireLaserFX(isCrit=false, clientX=null, clientY=null){
    const rect = clickArea.getBoundingClientRect();
    const cx = rect.left + rect.width/2;
    const cy = rect.top + rect.height/2;
    const targetX = (typeof clientX === "number") ? clientX : (cx + (Math.random()*60 - 30));
    const targetY = (typeof clientY === "number") ? clientY : (cy + (Math.random()*40 - 20));
    const angle = Math.atan2((targetY - cy), (targetX - cx)) * 180/Math.PI;

    const L = Math.random() < 0.5 ? laser1 : laser2;
    L.style.left = (22 + Math.random()*8) + "%";
    L.style.top  = (42 + Math.random()*16) + "%";
    L.style.transform = `rotate(${angle}deg)`;
    L.classList.remove("fire");
    void L.offsetWidth;
    L.classList.add("fire");

    asteroid.style.transform = "scale(.992)";
    setTimeout(()=> asteroid.style.transform = "", 70);

    if (isCrit) {
      asteroidWrap.classList.remove("shake");
      void asteroidWrap.offsetWidth;
      asteroidWrap.classList.add("shake");
      cracks.style.filter = "drop-shadow(0 0 18px rgba(255,204,102,.16))";
      asteroid.style.filter = "brightness(1.08) saturate(1.14)";
      spawnParticles(18);
      setTimeout(() => { asteroid.style.filter = ""; cracks.style.filter = ""; }, 220);
    }
  }

  function spawnImpactGlow(x, y){
    const g = document.createElement("div");
    g.className = "impactGlow";
    g.style.left = `${x - 23}px`;
    g.style.top  = `${y - 23}px`;
    stage.appendChild(g);
    setTimeout(()=>g.remove(), 360);
  }
  function spawnOreShard(xFrom, yFrom, xTo, yTo, rare=false){
    const s = document.createElement("div");
    s.className = "oreShard" + (rare ? " rare" : "");
    s.style.left = `${xFrom}px`;
    s.style.top  = `${yFrom}px`;
    s.style.setProperty("--dx", `${(xTo - xFrom)}px`);
    s.style.setProperty("--dy", `${(yTo - yFrom)}px`);
    stage.appendChild(s);
    setTimeout(()=>s.remove(), 500);
  }

  function droneBeamGradientForSkin(skinId){
    if(skinId === "carbon"){
      return `linear-gradient(90deg,
        rgba(50,213,131,0),
        rgba(50,213,131,.95),
        rgba(255,255,255,.85),
        rgba(50,213,131,.55),
        rgba(50,213,131,0)
      )`;
    }
    if(skinId === "solar"){
      return `linear-gradient(90deg,
        rgba(255,204,102,0),
        rgba(255,204,102,.95),
        rgba(255,255,255,.90),
        rgba(255,159,26,.55),
        rgba(255,204,102,0)
      )`;
    }
    if(skinId === "neon"){
      return `linear-gradient(90deg,
        rgba(43,212,255,0),
        rgba(43,212,255,.95),
        rgba(255,255,255,.85),
        rgba(124,92,255,.60),
        rgba(43,212,255,0)
      )`;
    }
    return `linear-gradient(90deg,
      rgba(43,212,255,0),
      rgba(43,212,255,.95),
      rgba(255,255,255,.85),
      rgba(124,92,255,.55),
      rgba(43,212,255,0)
    )`;
  }

  function fireDroneBeam(x1,y1,x2,y2, skinId){
    const dx = x2 - x1;
    const dy = y2 - y1;
    const dist = Math.max(10, Math.hypot(dx, dy));
    const angle = Math.atan2(dy, dx) * 180/Math.PI;

    const beam = document.createElement("div");
    beam.className = "droneBeam fire";
    beam.style.left = `${x1}px`;
    beam.style.top  = `${y1}px`;
    beam.style.width = `${dist}px`;
    beam.style.transform = `rotate(${angle}deg)`;
    beam.style.background = droneBeamGradientForSkin(skinId);
    stage.appendChild(beam);
    setTimeout(()=>beam.remove(), 320);
  }

  function animateDroneMining(droneEl, isRare=false){
    if(!droneEl) return;
    const skinId = droneEl.dataset.skin || "default";

    const stageRect = stage.getBoundingClientRect();
    const dRect = droneEl.getBoundingClientRect();
    const aRect = asteroid.getBoundingClientRect();

    const xD = (dRect.left - stageRect.left) + dRect.width/2;
    const yD = (dRect.top  - stageRect.top ) + dRect.height/2;
    const xA = (aRect.left - stageRect.left) + aRect.width/2;
    const yA = (aRect.top  - stageRect.top ) + aRect.height/2;

    droneEl.classList.add("aim");
    setTimeout(()=>{
      droneEl.classList.remove("aim");
      droneEl.classList.add("fire");

      fireDroneBeam(xD,yD,xA,yA, skinId);
      spawnImpactGlow(xA,yA);
      spawnParticles(12, xA, yA);
      spawnOreShard(xA,yA, xD,yD, isRare);

      asteroidWrap.classList.remove("shake");
      void asteroidWrap.offsetWidth;
      asteroidWrap.classList.add("shake");
      setTimeout(()=>asteroidWrap.classList.remove("shake"), 240);

      setTimeout(()=>droneEl.classList.remove("fire"), 210);
    }, 90);
  }

  function playDroneSpawnFX(droneEl){
    if(!droneEl) return;
    const stageRect = stage.getBoundingClientRect();
    const dRect = droneEl.getBoundingClientRect();
    const x = (dRect.left - stageRect.left) + dRect.width/2;
    const y = (dRect.top  - stageRect.top ) + dRect.height/2;

    const ring = document.createElement("div");
    ring.className = "spawnRingFX";
    ring.style.left = (x - 8) + "px";
    ring.style.top  = (y - 8) + "px";
    stage.appendChild(ring);

    for(let i=0;i<12;i++){
      const sp = document.createElement("div");
      sp.className = "spawnSpark";
      const ang = Math.random()*Math.PI*2;
      const dist = 24 + Math.random()*46;
      sp.style.setProperty("--dx", (Math.cos(ang)*dist).toFixed(1)+"px");
      sp.style.setProperty("--dy", (Math.sin(ang)*dist).toFixed(1)+"px");
      sp.style.left = (x + (Math.random()*4-2)) + "px";
      sp.style.top  = (y + (Math.random()*4-2)) + "px";
      stage.appendChild(sp);
      setTimeout(()=>sp.remove(), 600);
    }

    spawnDronePopAt(x, y-14, "DRONE DEPLOYED", "credit", `<span class="ico">${ICONS.drones}</span>`);
    setTimeout(()=>ring.remove(), 650);
  }

  function currentRankBonusText(){
    const m = MR_MILESTONES[state.minerRank] || "Mine to earn XP. Rare finds give bigger XP bursts.";
    const perks = [];
    if(state.perksUnlocked.capacityBoost) perks.push("+Capacity");
    if(state.perksUnlocked.rareBoost) perks.push("+Rare Finds");
    return (perks.length ? `Active: ${perks.join(" Â· ")} â€” ` : "Bonus: ") + m;
  }

  function addMiningXP(x){
    state.miningXP += x;
    while(state.miningXP >= state.miningNeed){
      state.miningXP -= state.miningNeed;
      state.minerRank += 1;
      state.miningNeed = miningNeedFor(state.minerRank);

      toast(`Miner Rank Up! (MR ${state.minerRank})`);
      spawnPop(`MR ${state.minerRank}!`, true, 50, 45, miniIconWrap(ICONS.prospect, 20));
      spawnParticles(14);
      lbSilentSync();

      // Refresh roadmap if it's open
      if(roadmapBackdrop && roadmapBackdrop.classList.contains("show")) renderRoadmap();

      if(state.minerRank === 10){
        state.perksUnlocked.capacityBoost = true;
        applyStats(state);
        toast("Vulcan Core unlocked! Switch planets in the Zone bar.");
        spawnPop("VULCAN CORE UNLOCKED!", true, 50, 38, miniIconWrap(ICONS.prospect, 20));
        spawnParticles(20);
      }

      const newly = ORES.filter(o => o.unlockMR === state.minerRank);
      for(const o of newly){
        state.recentUnlocks.push({ id:o.id, ts: now() });
        state.recentUnlocks = state.recentUnlocks.slice(-12);

        toast(`New Ore Discovered: ${o.name}`);
        spawnPop(`NEW ORE: ${o.name}`, true, 50, 60, oreIconHTML(o.id, 20));
        spawnParticles(16);
        setCargoDirtyAll();
      }

      if(state.minerRank === 6){
        toast("Trade Terminal Online");
        spawnPop("TRADE TERMINAL ONLINE", true, 50, 68, miniIconWrap(ICONS.trade, 20));
      }
    }
  }

  function nextUnlockText(){
    const nextOre = ORES.filter(o => state.minerRank < o.unlockMR).sort((a,b)=>a.unlockMR-b.unlockMR)[0];
    const parts = [];
    if(nextOre) parts.push(`MR ${nextOre.unlockMR}: ${nextOre.name} ore`);
    if(state.minerRank < 6) parts.push(`MR 6: Trade Terminal`);
    if(state.minerRank < 10) parts.push(`MR 10: Vulcan Core`);
    if(parts.length === 0) return "Next unlock: Maxed (for now).";
    return `Next unlock: ${parts[0]}${parts.length>1 ? ` Â· then ${parts[1]}` : ""}`;
  }

  function rareBoostMult(){
    const perk = state.perksUnlocked.rareBoost ? 1.25 : 1;
    const upgrade = 1 + (P().prospectLvl * 0.06);
    const skill = 1 + skillBonus("rareDropMult");
    return perk * upgrade * skill;
  }

  function dronePulsesPerSecond(){ return dronePulsesPerSecondFor(P()) * (1 + skillBonus("dronePulseMult")); }
  function droneCreditsPerPulse(){ return Math.round(droneCreditsPerPulseFor(P(), state.currentPlanet) * (1 + skillBonus("droneCreditMult"))); }

  // applyStats is called during load() before `state` exists â€” use standalone versions
  function tryCargoDrop(extraChance=0){
    const baseChance = (0.22 + extraChance) * rareBoostMult();
    if(Math.random() > baseChance) return null;

    const candidates = ORES.filter(o=>oreUnlocked(o.id));
    let total = 0;
    for(const o of candidates) total += o.rarity;

    let roll = Math.random() * total;
    for(const o of candidates){
      roll -= o.rarity;
      if(roll <= 0) return o;
    }
    return candidates[0] || null;
  }

  function freeSpace(){ return Math.max(0, state.cargoCap - totalCargoUnits()); }

  function autoSellToMakeRoom(neededUnits){
    const order = [...ORES].sort((a,b)=>a.value-b.value);
    let creditsGained = 0;
    let freed = 0;

    for(const o of order){
      if(freed >= neededUnits) break;
      if(!oreUnlocked(o.id)) continue;

      const set = state.oreSettings[o.id] || { locked:false, keep:0, autoSellMode:"off" };
      if(set.locked) continue;
      if(set.autoSellMode !== "overflow") continue;

      const have = state.cargo[o.id] || 0;
      const keep = Math.max(0, Math.floor(set.keep||0));
      const sellable = Math.max(0, have - keep);
      if(sellable <= 0) continue;

      const sell = Math.min(sellable, neededUnits - freed);
      if(sell > 0){
        state.cargo[o.id] -= sell;
        freed += sell;
        creditsGained += sell * o.value;
      }
    }
    if(creditsGained > 0){ state.credits += creditsGained; }
    return {freed, creditsGained};
  }

  function addCargo(oreId, amount){
    amount = Math.floor(amount);
    if(amount <= 0) return 0;

    let took = 0;
    for(let i=0;i<amount;i++){
      if(freeSpace() <= 0){
        if(state.autoSellOnFull){
          const res = autoSellToMakeRoom(1);
          if(res.freed <= 0) break;
          setCargoDirtyAll();
        }else break;
      }
      state.cargo[oreId] += 1;
      took += 1;
    }
    if(took>0) setCargoDirtyAll();
    return took;
  }

  function addOreWithMode(oreId, amount){
    amount = Math.floor(amount);
    if(amount <= 0) return 0;
    if(!oreUnlocked(oreId)) return 0;

    const set = state.oreSettings[oreId] || { locked:false, keep:0, autoSellMode:"off" };

    if(set.locked){
      return addCargo(oreId, amount);
    }

    if(set.autoSellMode === "drop"){
      const value = oreValue(oreId) * amount;
      state.credits += value;
      setCargoDirtyAll();
      return amount;
    }

    return addCargo(oreId, amount);
  }

  function autoSellOverflowSweep(){
    let total = 0;
    for(const o of ORES){
      if(!oreUnlocked(o.id)) continue;
      const set = state.oreSettings[o.id];
      if(!set || set.locked) continue;
      if(set.autoSellMode !== "overflow") continue;

      const have = state.cargo[o.id] || 0;
      const keep = Math.floor(set.keep || 0);
      const sell = Math.max(0, have - keep);
      if(sell>0){
        state.cargo[o.id] -= sell;
        total += sell * o.value;
      }
    }
    if(total>0){
      state.credits += total;
      setCargoDirtyAll();
    }
    return total;
  }

  function addCredits(amount){
    const gain = Math.round(amount * boostMult() * (1 + skillBonus("globalCreditMult")));
    state.credits += gain;
    questProgressUpdate("earn", gain);
    return gain;
  }


  function doShot(clientX, clientY){
    questProgressUpdate("shots", 1);

    const crit = Math.random() < (0.05 * (1 + skillBonus("critMult")));
    const baseRegolith = crit ? P().laserPower*4 : P().laserPower;
    const regolith = Math.round(baseRegolith * planetCreditMult() * (1 + skillBonus("laserCreditMult")) * (1 + skillBonus("globalCreditMult")));

    fireLaserFX(crit, clientX, clientY);
    const gained = addCredits(regolith);
    spawnPop(`+${fmt(gained)}`, crit, 50, 52, miniIconWrap(ICONS.coin, 20));

    addMiningXP((crit ? 40 : 8) * planetXpMult() * (1 + skillBonus("xpMult")));

    const dropBonus = skillBonus("clickDropChance") + skillBonus("allDropChance");
    // Void Surge â€” only on void planet
    if(state.currentPlanet === "void"){
      const surgeChance = (PLANETS.void.voidSurgeChance||0.08) * (1 + skillBonus("rareDropMult")*0.5);
      if(Math.random() < surgeChance){
        const surgeGain = addCredits(regolith * 9); // 10x total (already got 1x above)
        spawnPop(`VOID SURGE! +${fmt(surgeGain)}`, true, 50, 38, null);
        asteroid.classList.remove("void-surge");
        void asteroid.offsetWidth;
        asteroid.classList.add("void-surge");
        setTimeout(()=>asteroid.classList.remove("void-surge"), 600);
        spawnParticles(28);
      }
    }

    const drop = tryCargoDrop(dropBonus);
    if(drop){
      const took = addOreWithMode(drop.id, 1);
      if(took){
        questProgressUpdate("mine_ore", 1, drop.id);
        const mode = state.oreSettings[drop.id]?.autoSellMode || "off";
        const ico = oreIconHTML(drop.id, 20);
        if(mode === "drop") spawnPop(`+${fmt(oreValue(drop.id))}c`, true, 50, 60, ico);
        else spawnPop(`+1 ${drop.name}`, true, 50, 60, ico);
        addMiningXP(10 * planetXpMult() * (1 + skillBonus("xpMult")));
      }
    }
    updateHUD();
  }

  /* ===== Drones render + charge loop ===== */
  let droneEls = [];
  let droneChargeFills = [];
  let droneCharge = [];
  let droneCooldown = [];
  let droneSpecs = [];
  // Per-planet background charge/cooldown state
  const bgDroneCharge   = {};  // { iron: [...], vulcan: [...] }
  const bgDroneCooldown = {};

  function seededRand(seed){
    const x = Math.sin(seed) * 10000;
    return x - Math.floor(x);
  }
  function ensureDroneSpecs(count){
    while(droneSpecs.length < count){
      const i = droneSpecs.length;
      const r1 = seededRand(101 + i*17);
      const r2 = seededRand(203 + i*23);
      const r3 = seededRand(307 + i*29);
      const start = Math.floor(r1 * 360);
      const dur = (7.2 + r2*6.8).toFixed(2);
      const dir = r3 < 0.5 ? "normal" : "reverse";
      const radius = Math.floor(78 + r2*18);
      droneSpecs.push({ start, dur, dir, radius });
    }
  }

  function currentDroneSkin(){
    return state.cosmetics?.droneSkin || "default";
  }

  function syncSpawnedDrones(){
    const n = Math.max(0, Math.floor(P().dronesLvl||0));
    ensureDroneSpecs(n);

    const skinId = currentDroneSkin();
    const skin = DRONE_SKINS.find(s=>s.id===skinId) || DRONE_SKINS[0];
    const cssClass = skin.css || "";

    droneLayer.innerHTML = "";
    for(let i=0;i<n;i++){
      const spec = droneSpecs[i];

      const orbit = document.createElement("div");
      orbit.className = "droneOrbit";
      orbit.style.setProperty("--start", spec.start + "deg");
      orbit.style.setProperty("--dur", spec.dur + "s");
      orbit.style.setProperty("--dir", spec.dir);

      const d = document.createElement("div");
      d.className = "drone" + (cssClass ? (" " + cssClass) : "");
      d.dataset.idx = String(i);
      d.dataset.skin = skinId;
      d.style.setProperty("--radius", spec.radius + "px");

      d.innerHTML = `
        <div class="droneInner">
          <div class="blastRing"></div>
          <div class="muzzle"></div>
          <div class="thruster"></div>
          <div class="chargeTrack"><div class="chargeFill"></div></div>
        </div>
      `;

      orbit.appendChild(d);
      droneLayer.appendChild(orbit);
    }

    droneEls = Array.from(droneLayer.querySelectorAll(".drone"));
    droneChargeFills = droneEls.map(d => d.querySelector(".chargeFill"));
    droneCharge = droneEls.map(()=>0);
    droneCooldown = droneEls.map(()=>0);

    updateDroneChargeUI();
  }

  function updateDroneChargeUI(){
    for(let i=0;i<droneChargeFills.length;i++){
      const fill = droneChargeFills[i];
      if(!fill) continue;
      const pct = clamp(droneCharge[i], 0, 1) * 100;
      fill.style.width = pct.toFixed(0) + "%";
    }
  }

  function stepDroneCharges(dt){
    // Tick ALL planets in background
    for(const pid of Object.keys(PLANETS)){
      const pp = state.planets[pid];
      if(!pp || pp.dronesLvl <= 0) continue;

      const isActive = pid === state.currentPlanet;
      const pulses = dronePulsesPerSecondFor(pp) * boostMult();
      const n = Math.floor(pp.dronesLvl);

      // Maintain per-planet charge/cooldown arrays
      if(!bgDroneCharge[pid])    bgDroneCharge[pid]    = Array(n).fill(0);
      if(!bgDroneCooldown[pid])  bgDroneCooldown[pid]  = Array(n).fill(0);
      while(bgDroneCharge[pid].length < n)   { bgDroneCharge[pid].push(0); bgDroneCooldown[pid].push(0); }

      const charges   = bgDroneCharge[pid];
      const cooldowns = bgDroneCooldown[pid];

      for(let i=0; i<n; i++){
        cooldowns[i] = Math.max(0, cooldowns[i] - dt);
        const jitter = 0.88 + Math.random()*0.24;
        charges[i] += pulses * dt * jitter;

        if(charges[i] >= 1 && cooldowns[i] <= 0){
          charges[i] -= 1;
          cooldowns[i] = 0.14;

          const droneEl = isActive ? droneEls[i] : null;
          if(droneEl) animateDroneMining(droneEl, false);

          const credit = droneCreditsPerPulseFor(pp, pid);
          const gained = addCredits(credit);

          if(isActive && droneEl){
            spawnDronePop(droneEl, `+${fmt(gained)}c`, "credit", `<span class="ico">${ICONS.coin}</span>`);
          }

          addMiningXP((0.65 + pp.droneAI*0.06) * planetXpMult());

          const dropChance = 0.09 * rareBoostMult();
          if(Math.random() < dropChance){
            const savedPlanet = state.currentPlanet;
            if(!isActive) state.currentPlanet = pid;
            const d = tryCargoDrop(skillBonus("allDropChance"));
            if(!isActive) state.currentPlanet = savedPlanet;

            if(d){
              const mode = state.oreSettings[d.id]?.autoSellMode || "off";
              const took = addOreWithMode(d.id, 1);
              if(took){
                if(isActive) questProgressUpdate("mine_ore", 1, d.id);
                if(isActive && droneEl){
                  const icon = oreIconHTML(d.id, 14);
                  if(mode === "drop") spawnDronePop(droneEl, `+${fmt(oreValue(d.id))}c Â· ${d.name}`, "rare", icon);
                  else spawnDronePop(droneEl, `+1 ${d.name}`, (d.id==="platinum"||d.id==="gold"||d.id==="obsidian") ? "rare" : "ore", icon);
                  animateDroneMining(droneEl, true);
                }
                addMiningXP(2.5 * (1 + skillBonus("xpMult")));
              }
            }
          }
        }
      }

      // Sync charge UI only for active planet
      if(isActive){
        for(let i=0;i<droneChargeFills.length;i++){
          const fill = droneChargeFills[i];
          if(!fill) continue;
          fill.style.width = (clamp(charges[i]||0, 0, 1)*100).toFixed(0) + "%";
        }
      }
    }
  }

  /* ===== Skill Tree ===== */

  const SKILL_TREE = {
    mining: {
      label:"â› Mining", branch:"mining",
      nodes:[
        { id:"m1", name:"Sharp Edge",       desc:"+10% laser credits per shot",         cost:{ credits:150 },                effect:{ laserCreditMult:0.10 } },
        { id:"m2", name:"Deep Scan I",      desc:"+15% ore drop chance on clicks",      cost:{ credits:400, iron:20 },       effect:{ clickDropChance:0.15 } },
        { id:"m3", name:"Crystal Focus",    desc:"+20% crit chance multiplier",         cost:{ credits:900, nickel:15 },     effect:{ critMult:0.20 } },
        { id:"m4", name:"Deep Scan II",     desc:"+25% ore drop chance (all sources)",  cost:{ credits:2200, cobalt:10 },    effect:{ allDropChance:0.25 } },
        { id:"m5", name:"Resonance Core",   desc:"+40% mining XP gain globally",        cost:{ credits:5000, gold:5 },       effect:{ xpMult:0.40 } },
      ]
    },
    economy: {
      label:"ðŸ’° Economy", branch:"economy",
      nodes:[
        { id:"e1", name:"Bulk Trader",      desc:"+10% credits from all sales",         cost:{ credits:200 },                effect:{ sellMult:0.10 } },
        { id:"e2", name:"Cargo Liner I",    desc:"+20 cargo capacity",                  cost:{ credits:500, iron:30 },       effect:{ cargoCap:20 } },
        { id:"e3", name:"Market Insight",   desc:"+15% drone credit yield",             cost:{ credits:1200, nickel:20 },    effect:{ droneCreditMult:0.15 } },
        { id:"e4", name:"Cargo Liner II",   desc:"+40 cargo capacity",                  cost:{ credits:3000, cobalt:15 },    effect:{ cargoCap:40 } },
        { id:"e5", name:"Compound Interest",desc:"+25% all credit gains",               cost:{ credits:7000, platinum:3 },   effect:{ globalCreditMult:0.25 } },
      ]
    },
    exploration: {
      label:"ðŸš€ Exploration", branch:"exploration",
      nodes:[
        { id:"x1", name:"Warp Prep",        desc:"+10% offline income",                 cost:{ credits:180 },                effect:{ offlineMult:0.10 } },
        { id:"x2", name:"Drone Overclock",  desc:"+15% drone pulse speed globally",     cost:{ credits:450, iron:25 },       effect:{ dronePulseMult:0.15 } },
        { id:"x3", name:"Rare Prospector",  desc:"+20% rare drop rate globally",        cost:{ credits:1100, cobalt:8 },     effect:{ rareDropMult:0.20 } },
        { id:"x4", name:"Orbital Survey",   desc:"+30% drone pulse speed globally",     cost:{ credits:2800, gold:8 },       effect:{ dronePulseMult:0.30 } },
        { id:"x5", name:"Void Cartographer",desc:"Unlock: 50% discount on next planet", cost:{ credits:6000, platinum:5 },   effect:{ planetDiscount:0.50 } },
      ]
    }
  };

  function skillOwned(id, s){ return (s || state).skills.includes(id); }
  function skillNodeUnlocked(branchId, nodeIdx){
    if(nodeIdx === 0) return true;
    const branch = SKILL_TREE[branchId];
    return skillOwned(branch.nodes[nodeIdx-1].id);
  }

  function skillBonus(effectKey, s){
    const src = s || state;
    let total = 0;
    for(const branchId of Object.keys(SKILL_TREE)){
      for(const node of SKILL_TREE[branchId].nodes){
        if(src.skills.includes(node.id) && node.effect[effectKey] !== undefined){
          total += node.effect[effectKey];
        }
      }
    }
    // Add prestige bonuses (always use global state â€” prestige upgrades never reset)
    for(const u of PRESTIGE_UPGRADES){
      if((src.prestigeUpgrades||[]).includes(u.id) && u.effect[effectKey] !== undefined){
        total += u.effect[effectKey];
      }
    }
    return total;
  }
  function skillBonusFlat(effectKey, s){ return skillBonus(effectKey, s); }

  function canAffordSkill(node){
    if((state.credits || 0) < (node.cost.credits || 0)) return false;
    for(const [ore, amt] of Object.entries(node.cost)){
      if(ore === "credits") continue;
      if((state.cargo[ore]||0) < amt) return false;
    }
    return true;
  }

  function buySkill(branchId, nodeIdx){
    const branch = SKILL_TREE[branchId];
    const node = branch.nodes[nodeIdx];
    if(!node) return;
    if(skillOwned(node.id)) return toast("Already owned.");
    if(!skillNodeUnlocked(branchId, nodeIdx)) return toast("Unlock previous skill first.");
    if(!canAffordSkill(node)) return toast("Not enough resources.");

    state.credits -= (node.cost.credits||0);
    for(const [ore, amt] of Object.entries(node.cost)){
      if(ore === "credits") continue;
      state.cargo[ore] = Math.max(0, (state.cargo[ore]||0) - amt);
    }
    state.skills.push(node.id);
    applyStats(state);
    toast(`Skill unlocked: ${node.name}`);
    renderSkillTree();
    updateHUD();
    save();
  }

  function renderSkillTree(){
    const el2 = el("skillTreeEl");
    if(!el2) return;
    el2.innerHTML = "";

    const owned = state.skills.length;
    const total = Object.values(SKILL_TREE).reduce((a,b)=>a+b.nodes.length,0);
    el("skillSubLabel").textContent = `${owned}/${total} skills owned Â· Global bonuses stack across all planets`;

    for(const [branchId, branch] of Object.entries(SKILL_TREE)){
      const col = document.createElement("div");
      col.className = `skillBranch ${branch.branch}`;

      col.innerHTML = `<div class="skillBranchHeader">${branch.label}</div>`;

      branch.nodes.forEach((node, idx) => {
        const owned2 = skillOwned(node.id);
        const unlocked = skillNodeUnlocked(branchId, idx);
        const affordable = unlocked && !owned2 && canAffordSkill(node);

        if(idx > 0){
          const conn = document.createElement("div");
          conn.className = "skillConnector";
          col.appendChild(conn);
        }

        const costChips = Object.entries(node.cost).map(([k,v]) => {
          const have = k === "credits" ? state.credits : (state.cargo[k]||0);
          const met = have >= v;
          const label = k === "credits" ? `${fmt(v)}c` : `${v} ${k}`;
          return `<span class="skillCostChip ${met?"met":""}">${label}</span>`;
        }).join("");

        const nodeEl = document.createElement("div");
        nodeEl.className = `skillNode${owned2?" owned":""}${!unlocked?" locked-node":""}${affordable?" affordable":""}`;
        nodeEl.innerHTML = `
          ${owned2 ? `<div class="skillOwnedBadge">âœ“ Owned</div>` : ""}
          <div class="skillNodeName">${escapeHtml(node.name)}</div>
          <div class="skillNodeDesc">${escapeHtml(node.desc)}</div>
          ${!owned2 ? `<div class="skillNodeCost">${costChips}</div>` : ""}
        `;
        if(!owned2 && unlocked){
          nodeEl.addEventListener("click", ()=>buySkill(branchId, idx));
        }
        col.appendChild(nodeEl);
      });

      el2.appendChild(col);
    }
  }

  /* ===== Prestige System ===== */

  function prestigeUpgradeOwned(id){ return (state.prestigeUpgrades||[]).includes(id); }

  function prestigeBonus(effectKey){
    let total = 0;
    for(const u of PRESTIGE_UPGRADES){
      if(prestigeUpgradeOwned(u.id) && u.effect[effectKey] !== undefined)
        total += u.effect[effectKey];
    }
    return total;
  }

  function prestigeCostFor(planetId){
    const base  = PLANETS[planetId]?.prestigeBaseCost || 50000;
    const count = (state.prestigeCount?.[planetId] || 0);
    return base * (count + 1);
  }

  function dustEarnedFor(planetId){
    const count = state.prestigeCount?.[planetId] || 0;
    const base  = STELLAR_DUST_PER_PRESTIGE + count * 2;
    const mult  = 1 + prestigeBonus("dustMult");
    return Math.floor(base * mult);
  }

  function doPlanetPrestige(planetId){
    const cost = prestigeCostFor(planetId);
    const dust = dustEarnedFor(planetId);
    if(state.credits < cost) return toast(`Need ${fmt(cost)}c to prestige.`);

    state.credits -= cost;
    state.stellarDust = (state.stellarDust || 0) + dust;
    state.prestigeCount = state.prestigeCount || {};
    state.prestigeCount[planetId] = (state.prestigeCount[planetId] || 0) + 1;

    // Reset only this planet's upgrades
    state.planets[planetId] = defaultPlanetState(planetId);

    applyStats(state);
    syncSpawnedDrones();
    buildTab(state.shopTab);
    updateHUD();
    save();

    toast(`âœ¨ ${PLANETS[planetId].name} prestiged! +${dust} Stellar Dust`);
    spawnPop(`+${dust} âœ¨ Stellar Dust`, true, 50, 40, null);
    spawnParticles(24);
    if(el("prestigeBackdrop").classList.contains("show")) renderPrestigeModal();
  }

  function buyPrestigeUpgrade(id){
    const upg = PRESTIGE_UPGRADES.find(u=>u.id===id);
    if(!upg || prestigeUpgradeOwned(id)) return;
    if((state.stellarDust||0) < upg.cost) return toast(`Need ${upg.cost} âœ¨ Stellar Dust.`);
    state.stellarDust -= upg.cost;
    state.prestigeUpgrades = state.prestigeUpgrades || [];
    state.prestigeUpgrades.push(id);
    applyStats(state);
    updateHUD();
    save();
    toast(`âœ¨ ${upg.name} unlocked!`);
    renderPrestigeModal();
  }

  function renderPrestigeModal(){
    const body = el("prestigeBody");
    if(!body) return;
    const dust  = state.stellarDust || 0;
    const owned = (state.prestigeUpgrades||[]).length;
    el("prestigeSubLabel").textContent = `âœ¨ ${fmt(dust)} Stellar Dust Â· ${owned}/${PRESTIGE_UPGRADES.length} upgrades`;

    let html = `<div style="display:flex;flex-direction:column;gap:10px;margin-bottom:18px;">`;
    for(const [pid, planet] of Object.entries(PLANETS)){
      if(!planet.prestigeBaseCost) continue;
      const cost   = prestigeCostFor(pid);
      const dust2  = dustEarnedFor(pid);
      const count  = state.prestigeCount?.[pid] || 0;
      const afford = state.credits >= cost;
      html += `
        <div style="padding:12px 14px;border-radius:16px;border:1px solid rgba(255,255,255,.09);
          background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(0,0,0,.16));
          display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
          <div style="flex:1;min-width:0;">
            <div style="font-weight:900;font-size:13px;">${planet.name}
              ${count>0?`<span class="chip good" style="font-size:10px;margin-left:4px;">${count}Ã— Prestiged</span>`:""}
            </div>
            <div class="muted" style="font-size:11px;margin-top:3px;">Resets all planet upgrades &amp; earns Stellar Dust</div>
            <div style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap;">
              <span class="chip warn">Cost: ${fmt(cost)}c</span>
              <span class="chip" style="border-color:rgba(180,130,255,.28);background:rgba(150,100,255,.10);color:rgba(220,190,255,.95);">+${dust2} âœ¨</span>
            </div>
          </div>
          <button class="btn ${afford?"warn":"secondary"}" data-prestige="${pid}"
            style="padding:10px 18px;flex-shrink:0;" ${afford?"":"disabled"}>âœ¨ Prestige</button>
        </div>`;
    }
    html += `</div>`;

    for(const [catId, cat] of Object.entries(PRESTIGE_CATS)){
      const upgrades = PRESTIGE_UPGRADES.filter(u=>u.cat===catId);
      html += `
        <div style="margin-bottom:14px;">
          <div style="font-weight:900;font-size:12px;padding:6px 10px;border-radius:10px;margin-bottom:8px;
            background:${cat.color}.10);border:1px solid ${cat.color}.20);">${cat.label}</div>
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;">`;
      for(const upg of upgrades){
        const own2    = prestigeUpgradeOwned(upg.id);
        const afford2 = !own2 && (state.stellarDust||0) >= upg.cost;
        html += `
          <div class="skillNode${own2?" owned":""}${afford2?" affordable":""}"
            style="cursor:${own2?"default":"pointer"};position:relative;"
            ${own2?"":"data-buy-prestige=\""+upg.id+"\""}> 
            ${own2?`<div class="skillOwnedBadge">âœ“ Owned</div>`:""}
            <div class="skillNodeName">${escapeHtml(upg.name)}</div>
            <div class="skillNodeDesc">${escapeHtml(upg.desc)}</div>
            ${!own2?`<div class="skillNodeCost">
              <span class="skillCostChip ${afford2?"met":""}">âœ¨ ${upg.cost}</span>
            </div>`:""}
          </div>`;
      }
      html += `</div></div>`;
    }

    body.innerHTML = html;

    body.querySelectorAll("[data-prestige]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        if(confirm(`Prestige ${PLANETS[btn.dataset.prestige].name}?\n\nAll upgrades on this planet reset.\nYou keep: MR, Skill Tree, other planets, Stellar Dust upgrades.`))
          doPlanetPrestige(btn.dataset.prestige);
      });
    });
    body.querySelectorAll("[data-buy-prestige]").forEach(node=>{
      node.addEventListener("click", ()=>buyPrestigeUpgrade(node.dataset.buyPrestige));
    });
  }

  function openPrestige(){
    renderPrestigeModal();
    el("prestigeBackdrop").classList.add("show");
  }
  function closePrestige(){ el("prestigeBackdrop").classList.remove("show"); }

  /* ===== Daily Quests ===== */

  function todayDateStr(){
    const d = new Date();
    return `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;
  }

  function generateQuests(){
    const planet = state.currentPlanet;
    const mr = state.minerRank;
    const pool = [];

    // Shot-based quests
    pool.push({ id:"shots_easy",   diff:"easy",   type:"shots",   target:30,  desc:"Fire 30 laser shots",           reward:{ credits:80,  xp:15 } });
    pool.push({ id:"shots_med",    diff:"medium",  type:"shots",   target:80,  desc:"Fire 80 laser shots",           reward:{ credits:200, xp:35 } });
    pool.push({ id:"shots_hard",   diff:"hard",    type:"shots",   target:200, desc:"Fire 200 laser shots",          reward:{ credits:500, xp:80 } });

    // Credit earn quests â€” scale with mr
    const base = Math.max(100, mr * 60);
    pool.push({ id:"earn_easy",    diff:"easy",   type:"earn",    target:base,    desc:`Earn ${fmt(base)} credits`,           reward:{ credits:100, xp:20 } });
    pool.push({ id:"earn_med",     diff:"medium",  type:"earn",    target:base*3,  desc:`Earn ${fmt(base*3)} credits`,         reward:{ credits:280, xp:50 } });
    pool.push({ id:"earn_hard",    diff:"hard",    type:"earn",    target:base*8,  desc:`Earn ${fmt(base*8)} credits`,         reward:{ credits:700, xp:100 } });

    // Ore quests â€” based on available ores
    const available = ORES.filter(o => state.minerRank >= o.unlockMR && o.planet === (planet === "vulcan" ? "vulcan" : "iron") || (o.planet === "iron" && state.minerRank >= o.unlockMR));
    if(available.length >= 1){
      const ore = available[Math.floor(Math.random()*available.length)];
      pool.push({ id:`ore_easy_${ore.id}`,  diff:"easy",   type:"mine_ore", oreId:ore.id, target:5,  desc:`Mine 5 ${ore.name}`,  reward:{ credits:120, xp:25 } });
      pool.push({ id:`ore_med_${ore.id}`,   diff:"medium",  type:"mine_ore", oreId:ore.id, target:12, desc:`Mine 12 ${ore.name}`, reward:{ credits:320, xp:60 } });
      pool.push({ id:`ore_hard_${ore.id}`,  diff:"hard",    type:"mine_ore", oreId:ore.id, target:25, desc:`Mine 25 ${ore.name}`, reward:{ credits:800, xp:120 } });
    }

    // Planet-specific bonus quest
    if(planet === "vulcan" && mr >= 10){
      pool.push({ id:"vulcan_special", diff:"hard", type:"earn", target:2000, desc:"Earn 2.000 credits on Vulcan Core", reward:{ credits:1200, xp:150 }, planet:"vulcan" });
    }

    // Pick one of each difficulty
    const pick = (diff) => {
      const candidates = pool.filter(q=>q.diff===diff);
      return candidates[Math.floor(Math.random()*candidates.length)];
    };

    return [
      { ...pick("easy"),   progress:0, claimed:false },
      { ...pick("medium"), progress:0, claimed:false },
      { ...pick("hard"),   progress:0, claimed:false },
    ].filter(Boolean);
  }

  function ensureQuests(){
    const today = todayDateStr();
    if(state.quests.date !== today || !state.quests.list.length){
      state.quests = { date:today, list:generateQuests() };
      save();
    }
  }

  function questProgressUpdate(type, amount, oreId=null){
    if(!state.quests?.list) return;
    let dirty = false;
    for(const q of state.quests.list){
      if(q.claimed) continue;
      if(q.type === type){
        if(type === "mine_ore" && q.oreId !== oreId) continue;
        q.progress = Math.min(q.target, (q.progress||0) + amount);
        dirty = true;
      }
    }
    if(dirty){
      renderQuestStrip();
      if(el("questBackdrop")?.classList.contains("show")) renderQuestModal();
    }
  }

  function claimQuest(idx){
    const q = state.quests.list[idx];
    if(!q || q.claimed) return;
    if((q.progress||0) < q.target) return toast("Quest not complete yet.");
    q.claimed = true;
    state.credits += q.reward.credits||0;
    addMiningXP((q.reward.xp||0) * (1 + skillBonus("xpMult")));
    toast(`Quest complete! +${fmt(q.reward.credits)}c +${q.reward.xp} XP`);
    spawnPop(`+${fmt(q.reward.credits)}c`, true, 50, 45, miniIconWrap(ICONS.coin, 20));
    spawnParticles(14);
    save();
    renderQuestStrip();
    if(el("questBackdrop")?.classList.contains("show")) renderQuestModal();
    updateHUD();
  }

  function renderQuestStrip(){
    const strip = el("questStrip");
    if(!strip) return;
    ensureQuests();
    strip.innerHTML = "";
    for(const q of state.quests.list){
      const done = (q.progress||0) >= q.target;
      const dotCls = q.claimed ? "locked" : done ? "done" : "active";
      const pct = Math.min(100, Math.round(((q.progress||0)/q.target)*100));
      const row = document.createElement("div");
      row.className = "questStrip";
      row.innerHTML = `
        <span class="questStripDot ${dotCls}"></span>
        <span style="flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(q.desc)}</span>
        <span style="font-size:11px;color:var(--muted);flex-shrink:0;">${q.claimed?"âœ“":done?"Claim":pct+"%"}</span>
      `;
      row.addEventListener("click", openQuests);
      strip.appendChild(row);
    }
  }

  function renderQuestModal(){
    const list = el("questList");
    if(!list) return;
    ensureQuests();

    const midnight = new Date(); midnight.setHours(24,0,0,0);
    const ms = midnight - Date.now();
    const hh = Math.floor(ms/3600000), mm = Math.floor((ms%3600000)/60000);
    el("questResetLabel").textContent = `Resets in ${hh}h ${mm}m`;

    list.innerHTML = "";
    state.quests.list.forEach((q, idx) => {
      const done = (q.progress||0) >= q.target;
      const pct = Math.min(100, ((q.progress||0)/q.target)*100);

      const card = document.createElement("div");
      card.className = `questCard${q.claimed?" claimed":done?" complete":""}`;
      card.innerHTML = `
        <div class="questTop">
          <div class="questLeft">
            <div class="questTitle">${escapeHtml(q.desc)}</div>
            <div class="questDesc">${q.claimed?"Completed âœ“":`${Math.floor(q.progress||0)} / ${q.target}`}</div>
          </div>
          <span class="questDiff ${q.diff}">${q.diff}</span>
        </div>
        <div class="questRewards">
          <span class="questReward">${miniIconWrap(ICONS.coin,12)} +${fmt(q.reward.credits)}c</span>
          <span class="questReward">+${q.reward.xp} XP</span>
        </div>
        ${!q.claimed ? `<div class="questProgressBar"><div class="questProgressFill" style="width:${pct.toFixed(1)}%"></div></div>
        <div class="questProgressLabel">${Math.floor(pct)}% complete</div>` : ""}
        ${done && !q.claimed ? `<button class="btn good" style="margin-top:10px;width:100%;padding:10px;" data-claim="${idx}">Claim Reward</button>` : ""}
      `;
      list.appendChild(card);
    });

    list.addEventListener("click", (e) => {
      const btn = e.target.closest("[data-claim]");
      if(btn) claimQuest(parseInt(btn.dataset.claim));
    }, { once:true });
  }

  const questBackdrop = el("questBackdrop");
  /* ===== Planet Overview ===== */

  // Extended planet display data (beyond the PLANETS game config)
  const PLANET_DISPLAY = {
    iron: {
      orb:"iron-orb", banner:"iron-banner",
      subtitle:"The starting zone â€” reliable yields, steady income.",
      ores: ORES.filter(o=>!o.planet || o.planet==="iron").map(o=>o.id),
      stats:[
        { label:"Credits Ã—1.0",  kind:"" },
        { label:"XP Ã—1.0",       kind:"" },
        { label:"Standard ores", kind:"" },
      ]
    },
    vulcan: {
      orb:"vulcan-orb", banner:"vulcan-banner",
      subtitle:"A volcanic world with molten veins and rare ore formations.",
      ores:["pyrolusite","obsidian"],
      stats:[
        { label:"Credits Ã—2.5",   kind:"good" },
        { label:"XP Ã—1.5",        kind:"good" },
        { label:"Exclusive ores",  kind:"ore" },
      ]
    },
    void: {
      orb:"void-orb", banner:"void-banner",
      subtitle:"A deep-space void rich in dark matter. Unstable but incredibly lucrative.",
      ores:["voidShard","darkMatter"],
      stats:[
        { label:"Credits Ã—5.0",    kind:"good" },
        { label:"XP Ã—2.0",         kind:"good" },
        { label:"Void Surge: 8%",  kind:"warn" },
        { label:"Exclusive ores",  kind:"ore" },
      ]
    },
    future: {
      orb:"future-orb", banner:"future-banner",
      subtitle:"Signal detected â€” location unknown. Further exploration required.",
      ores:[],
      stats:[
        { label:"???",  kind:"warn" },
        { label:"???",  kind:"warn" },
      ]
    }
  };

  function renderPlanetOverview(){
    const el2 = el("planetCardsEl");
    if(!el2) return;
    el2.innerHTML = "";

    const allPlanets = [
      { ...PLANETS.iron,   id:"iron",   future:false },
      { ...PLANETS.vulcan, id:"vulcan", future:false },
      { ...PLANETS.void,   id:"void",   future:false },
      { id:"future", name:"Unknown World", unlockMR:35, unlockCredits:null, future:true },
    ];

    const owned  = state.planetsBought || {};
    const mr     = state.minerRank;

    let unlocked=0, total=allPlanets.filter(p=>!p.future).length;
    for(const p of allPlanets){ if(p.id==="iron" || owned[p.id]) unlocked++; }
    el("planetsSubLabel").textContent = `${unlocked}/${total} planets colonized Â· MR ${mr}`;

    for(const planet of allPlanets){
      const disp   = PLANET_DISPLAY[planet.id] || PLANET_DISPLAY.future;
      const isCurrent  = state.currentPlanet === planet.id;
      const isBought   = planet.id === "iron" || !!owned[planet.id];
      const rankOK     = mr >= (planet.unlockMR || 1);
      const canAfford  = planet.unlockCredits ? state.credits >= planet.unlockCredits : true;
      const unlockable = !isBought && rankOK && !planet.future;

      // Card classes
      let cardCls = "planetCard";
      if(planet.id === "vulcan") cardCls += " vulcan-card";
      if(planet.future) cardCls += " future-card locked-card";
      else if(!isBought) cardCls += " locked-card";
      if(isCurrent) cardCls += " active-card";

      // Badge
      let badge = "";
      if(isCurrent)       badge = `<span class="planetBannerBadge current">â–¶ Active</span>`;
      else if(isBought)   badge = `<span class="planetBannerBadge owned">âœ“ Colonized</span>`;
      else if(planet.future) badge = `<span class="planetBannerBadge locked">Coming Soon</span>`;
      else if(unlockable) badge = `<span class="planetBannerBadge unlockable">Available</span>`;
      else                badge = `<span class="planetBannerBadge locked">Locked</span>`;

      // Stats chips
      const statsHtml = (disp.stats||[]).map(s=>
        `<span class="planetStat ${s.kind||""}">${escapeHtml(s.label)}</span>`
      ).join("");

      // Ores
      const oresHtml = disp.ores.length
        ? `<div class="planetOres">
            <span class="planetOreLabel">Ores:</span>
            ${disp.ores.map(id=>{
              const o = ORES.find(x=>x.id===id);
              return o ? `<span title="${o.name}">${oreIconHTML(id,16)}</span>` : "";
            }).join("")}
           </div>`
        : "";

      // Action area
      let actionHtml = "";
      if(planet.future){
        actionHtml = `<div class="planetBuyInfo">Requires MR ${planet.unlockMR}</div>`;
      } else if(isCurrent){
        actionHtml = `<div class="planetBuyInfo can-afford">Currently active</div>`;
      } else if(isBought){
        actionHtml = `<button class="btn good" data-warp="${planet.id}" style="padding:8px 16px;">Warp Here</button>`;
      } else if(!rankOK){
        actionHtml = `
          <div class="planetBuyInfo locked-mr">Requires MR ${planet.unlockMR}</div>
          <div class="planetBuyInfo">${fmt(planet.unlockCredits)}c to colonize</div>`;
      } else {
        // Rank OK, can potentially buy
        const affordCls = canAfford ? "can-afford" : "";
        actionHtml = `
          <button class="btn ${canAfford?"good":"secondary"}" data-buy="${planet.id}"
            style="padding:8px 16px;" ${canAfford?"":"disabled"}>
            Colonize
          </button>
          <div class="planetBuyInfo ${affordCls}">
            ${fmt(planet.unlockCredits)}c
            ${canAfford ? "âœ“" : `(have ${fmt(state.credits)}c)`}
          </div>`;
      }

      const orbActive = isCurrent ? " active-glow" : "";

      el2.insertAdjacentHTML("beforeend", `
        <div class="${cardCls}">
          <div class="planetCardBanner ${disp.banner}">
            <div class="planetOrb ${disp.orb}${orbActive}"></div>
            <div class="planetBannerInfo">
              <div class="planetBannerName">${escapeHtml(planet.name)}</div>
              <div class="planetBannerSub">${escapeHtml(disp.subtitle)}</div>
            </div>
            ${badge}
          </div>
          <div class="planetCardBody">
            <div>
              <div class="planetStats">${statsHtml}</div>
              ${oresHtml}
            </div>
            <div class="planetCardActions">${actionHtml}</div>
          </div>
        </div>
      `);
    }

    // Wire up buttons
    el2.querySelectorAll("[data-warp]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        switchPlanet(btn.dataset.warp);
        renderPlanetOverview();
      });
    });
    el2.querySelectorAll("[data-buy]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        switchPlanet(btn.dataset.buy);  // switchPlanet handles purchase logic
        renderPlanetOverview();
      });
    });
  }

  const planetsBackdrop = el("planetsBackdrop");
  function openPlanetOverview(){
    renderPlanetOverview();
    planetsBackdrop.classList.add("show");
  }
  function closePlanetOverview(){ planetsBackdrop.classList.remove("show"); }

  /* ===== Leaderboard (Supabase) ===== */

  const SB_URL = "https://gefdwzwrovsucpzyhndz.supabase.co";
  const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdlZmR3endyb3ZzdWNwenlobmR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2MjI3OTEsImV4cCI6MjA4NzE5ODc5MX0.ULOa8YDdHJNe--0WK3mi_jnzcwOiZJsJ5RFO5jCslDo";

  const sbHeaders = {
    "apikey": SB_KEY,
    "Authorization": `Bearer ${SB_KEY}`,
    "Content-Type": "application/json",
    "Prefer": "return=minimal"
  };

  async function lbFetch(){
    try {
      const res = await fetch(
        `${SB_URL}/rest/v1/leaderboard?select=username,miner_rank,credits,score&order=score.desc&limit=25`,
        { headers: sbHeaders }
      );
      if(!res.ok) throw new Error(await res.text());
      return await res.json();
    } catch(e) {
      console.error("LB fetch error:", e);
      return null;
    }
  }

  async function lbUpsert(username, pin){
    const mr       = state.minerRank;
    const credits  = Math.floor(state.credits);
    const prestigeTotal = Object.values(state.prestigeCount||{}).reduce((a,b)=>a+b,0);
    const score    = prestigeTotal * 10000000 + mr * 100000 + credits;
    const pin_hash = await hashPin(pin);
    try {
      const resInsert = await fetch(`${SB_URL}/rest/v1/leaderboard`, {
        method: "POST",
        headers: { ...sbHeaders, "Prefer": "resolution=ignore-duplicates,return=minimal" },
        body: JSON.stringify({ username, miner_rank: mr, credits, score, pin_hash, updated_at: new Date().toISOString() })
      });
      if(resInsert.status === 201 || resInsert.status === 200){
        return { ok:true, msg:"new" };
      }
      // Username exists â€” PATCH only if PIN matches
      const resUpdate = await fetch(
        `${SB_URL}/rest/v1/leaderboard?username=eq.${encodeURIComponent(username)}&pin_hash=eq.${encodeURIComponent(pin_hash)}`,
        {
          method: "PATCH",
          headers: { ...sbHeaders, "Prefer": "return=representation" },
          body: JSON.stringify({ miner_rank: mr, credits, score, updated_at: new Date().toISOString() })
        }
      );
      if(!resUpdate.ok) throw new Error(await resUpdate.text());
      const updated = await resUpdate.json();
      if(!updated.length) return { ok:false, msg:"wrong_pin" };
      return { ok:true, msg:"updated" };
    } catch(e){
      console.error("LB upsert error:", e);
      return { ok:false, msg:"error" };
    }
  }

  async function hashPin(pin){
    const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(pin));
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
  }

  function lbRankIcon(i){
    if(i===0) return `<span class="lbRank gold">ðŸ¥‡</span>`;
    if(i===1) return `<span class="lbRank silver">ðŸ¥ˆ</span>`;
    if(i===2) return `<span class="lbRank bronze">ðŸ¥‰</span>`;
    return `<span class="lbRank">${i+1}</span>`;
  }

  function renderLbList(rows, myName){
    const el2 = el("lbList");
    if(!rows || rows.length === 0){
      el2.innerHTML = `<div class="muted" style="text-align:center;padding:20px;">Keine EintrÃ¤ge yet â€” sei der Erste!</div>`;
      return;
    }
    el("lbSubLabel").textContent = `Top ${rows.length} Miners Â· Live`;
    el2.innerHTML = rows.map((row, i) => {
      const isMe = myName && row.username.toLowerCase() === myName.toLowerCase();
      let rowCls = "lbRow";
      if(isMe) rowCls += " me";
      if(i===0) rowCls += " top1";
      else if(i===1) rowCls += " top2";
      else if(i===2) rowCls += " top3";
      return `
        <div class="${rowCls}">
          ${lbRankIcon(i)}
          <div class="lbName">${escapeHtml(row.username)}${isMe?" <span style=\'font-size:10px;color:var(--acc);\'>(you)</span>":""}</div>
          <div class="lbMR">MR ${row.miner_rank}</div>
          <div class="lbScore">${fmt(row.credits)}c</div>
        </div>`;
    }).join("");
  }

  async function openLeaderboard(){
    el("lbBackdrop").classList.add("show");
    el("lbList").innerHTML = `<div class="muted" style="text-align:center;padding:20px;">Loadingâ€¦</div>`;
    const savedUser = localStorage.getItem("spaceminer_username") || "";
    const savedPin  = localStorage.getItem("spaceminer_pin") || "";
    el("lbUsernameInput").value = savedUser;
    el("lbPinInput").value = savedPin ? "â€¢â€¢â€¢â€¢" : "";
    el("lbSubmitStatus").style.color = "var(--muted)";
    el("lbSubmitStatus").textContent = `Current score: MR ${state.minerRank} Â· ${fmt(state.credits)}c`;
    const rows = await lbFetch();
    if(rows === null){
      el("lbList").innerHTML = `<div class="muted" style="text-align:center;padding:20px;">âš ï¸ Could not load leaderboard.</div>`;
    } else {
      renderLbList(rows, savedUser);
    }
  }

  function closeLeaderboard(){ el("lbBackdrop").classList.remove("show"); }

  el("lbSubmitBtn").addEventListener("click", async () => {
    const username = el("lbUsernameInput").value.trim();
    const pinRaw   = el("lbPinInput").value.trim();
    const statusEl = el("lbSubmitStatus");
    if(!username){ statusEl.textContent="âš ï¸ Bitte Namen eingeben."; statusEl.style.color="var(--danger)"; return; }
    if(username.length < 2){ statusEl.textContent="âš ï¸ Name mind. 2 Zeichen."; statusEl.style.color="var(--danger)"; return; }
    const storedPin = localStorage.getItem("spaceminer_pin") || "";
    const pin = (pinRaw === "â€¢â€¢â€¢â€¢" && storedPin) ? storedPin : pinRaw;
    if(!pin || pin.length < 4){ statusEl.textContent="âš ï¸ PIN mind. 4 Zeichen."; statusEl.style.color="var(--danger)"; return; }
    el("lbSubmitBtn").disabled = true;
    el("lbSubmitBtn").textContent = "â€¦";
    statusEl.style.color = "var(--muted)";
    statusEl.textContent = "Submittingâ€¦";
    const result = await lbUpsert(username, pin);
    el("lbSubmitBtn").disabled = false;
    el("lbSubmitBtn").textContent = "Submit";
    if(result.ok){
      localStorage.setItem("spaceminer_username", username);
      localStorage.setItem("spaceminer_pin", pin);
      statusEl.textContent = result.msg==="new" ? `âœ“ Registriert! MR ${state.minerRank} Â· ${fmt(state.credits)}c` : `âœ“ Score updated! MR ${state.minerRank} Â· ${fmt(state.credits)}c`;
      statusEl.style.color = "var(--good)";
      const rows = await lbFetch();
      renderLbList(rows, username);
    } else if(result.msg==="wrong_pin"){
      statusEl.textContent = "âš ï¸ Falscher PIN fÃ¼r diesen Namen.";
      statusEl.style.color = "var(--danger)";
    } else {
      statusEl.textContent = "âš ï¸ Fehler â€” Verbindung prÃ¼fen.";
      statusEl.style.color = "var(--danger)";
    }
  });

  el("lbUsernameInput").addEventListener("keydown", (e)=>{ if(e.key==="Enter") el("lbPinInput").focus(); });
  el("lbPinInput").addEventListener("keydown", (e)=>{ if(e.key==="Enter") el("lbSubmitBtn").click(); });
  el("lbPinInput").addEventListener("focus", ()=>{ if(el("lbPinInput").value==="â€¢â€¢â€¢â€¢") el("lbPinInput").value=""; });

  el("openPrestigeBtn").addEventListener("click", openPrestige);
  el("closePrestige").addEventListener("click", closePrestige);
  el("prestigeBackdrop").addEventListener("click", (e)=>{ if(e.target===el("prestigeBackdrop")) closePrestige(); });

  el("openLeaderboardBtn").addEventListener("click", openLeaderboard);
  el("closeLb").addEventListener("click", closeLeaderboard);
  el("lbBackdrop").addEventListener("click", (e)=>{ if(e.target===el("lbBackdrop")) closeLeaderboard(); });

  async function lbSilentSync(){
    const username = localStorage.getItem("spaceminer_username");
    const pin      = localStorage.getItem("spaceminer_pin");
    if(!username || !pin) return;
    await lbUpsert(username, pin);
  }

  setInterval(lbSilentSync, 3 * 60 * 1000);
  document.addEventListener("visibilitychange", ()=>{ if(document.visibilityState==="hidden") lbSilentSync(); });
  function openQuests(){
    renderQuestModal();
    questBackdrop.classList.add("show");
  }
  function closeQuests(){ questBackdrop.classList.remove("show"); }

  /* ===== Trades ===== */
  function rng(seed){ let x = Math.sin(seed) * 10000; return x - Math.floor(x); }
  function itemValue(item){
    if(item.id === "credits") return item.amt;
    return item.amt * oreValue(item.id);
  }
  function randomUnlockedOre(seedOffset=0){
    const unlocked = ORES.filter(o=>oreUnlocked(o.id));
    if(unlocked.length === 0) return "iron";
    const idx = Math.floor(rng(state.trades.seed + seedOffset) * unlocked.length);
    return unlocked[idx].id;
  }
  function rerollTrades(){
    const sixHours = 6*60*60*1000;
    const base = Math.floor(now()/sixHours);
    state.trades.seed = base;
    state.trades.nextReroll = (base+1)*sixHours;

    const offers = [];
    const s = state.trades.seed;

    const baseMargin = 0.06 + rng(s+11)*0.10;
    const spicy = (rng(s+12) < 0.15) ? (0.10 + rng(s+13)*0.18) : 0;
    const margin = baseMargin + spicy;

    function makeOffer(give, get){
      const gv = itemValue(give);
      const target = Math.ceil(gv * (1 + margin));
      const unit = (get.id==="credits") ? 1 : oreValue(get.id);
      get.amt = Math.max(get.amt, Math.ceil(target / Math.max(1,unit)));
      const bonus = Math.round(((itemValue(get)/Math.max(1,itemValue(give))) - 1) * 100);
      return { give, get, bonus, used:false };
    }

    offers.push(makeOffer({id:randomUnlockedOre(1), amt:10 + Math.floor(rng(s+1)*22)},{id:randomUnlockedOre(2), amt:2 + Math.floor(rng(s+2)*10)}));
    offers.push(makeOffer({id:"credits", amt:160 + Math.floor(rng(s+3)*260)},{id:randomUnlockedOre(3), amt:8 + Math.floor(rng(s+4)*16)}));
    offers.push(makeOffer({id:randomUnlockedOre(5), amt:12 + Math.floor(rng(s+5)*18)},{id:"credits", amt:120 + Math.floor(rng(s+6)*220)}));

    state.trades.offers = offers;
  }
  function canPayTrade(give){ return give.id==="credits" ? state.credits >= give.amt : (state.cargo[give.id]||0) >= give.amt; }
  function payTrade(give){ if(give.id==="credits") state.credits -= give.amt; else state.cargo[give.id] -= give.amt; }
  function receiveTrade(get){ if(get.id==="credits") state.credits += get.amt; else addCargo(get.id, get.amt); }

  /* ===== Cargo crafting ===== */
  function currentRecipe(){
    const t = state.cargoTier;
    if(t === 1) return { name:"Cargo Bay Mk2", req:{ iron:30, nickel:10 }, effect:"+50 capacity", nextTier:2 };
    if(t === 2) return { name:"Cargo Bay Mk3", req:{ cobalt:20, nickel:18, gold:4 }, effect:"+50 capacity", nextTier:3 };
    if(t === 3) return { name:"Cargo Bay Mk4", req:{ gold:10, cobalt:30, platinum:2 }, effect:"+50 capacity", nextTier:4 };
    return { name:"Cargo Bay Max", req:null, effect:"Maxed", nextTier:t };
  }
  function hasRecipeReq(req){
    if(!req) return false;
    for(const [id,amt] of Object.entries(req)){
      if((state.cargo[id]||0) < amt) return false;
    }
    return true;
  }
  function craftCargo(){
    const r = currentRecipe();
    if(!r.req) return toast("Already maxed.");
    if(!hasRecipeReq(r.req)) return toast("Missing required ores.");
    for(const [id,amt] of Object.entries(r.req)){
      state.cargo[id] -= amt;
      if(state.cargo[id] < 0) state.cargo[id] = 0;
    }
    state.cargoTier = r.nextTier;
    applyStats(state);
    toast(`${r.name} crafted!`);
    setCargoDirtyAll();
  }

  function sellSelected(){
    let total = 0;
    for(const o of ORES){
      if(!oreUnlocked(o.id)) continue;
      const want = Math.floor(state.sellPlan[o.id]||0);
      const have = state.cargo[o.id]||0;
      const set = state.oreSettings[o.id] || {locked:false, keep:0};
      const keep = Math.floor(set.keep||0);

      const maxSell = Math.max(0, have - keep);
      const sell = clamp(want, 0, maxSell);

      if(sell>0){
        state.cargo[o.id] -= sell;
        total += sell * o.value;
      }
      state.sellPlan[o.id] = 0;
    }
    if(total<=0) return toast("Nothing sellable (check Keep reserve).");

    state.credits += total;

    toast(`Sold for +${fmt(total)} credits`);
    setCargoDirtyAll();
    updateHUD();
  }

  function setSelectionPercent(pct){
    pct = clamp(pct, 0, 1);
    for(const o of ORES){
      if(!oreUnlocked(o.id)) continue;
      const have = state.cargo[o.id]||0;
      const keep = Math.floor((state.oreSettings[o.id]?.keep)||0);
      const sellable = Math.max(0, have - keep);
      state.sellPlan[o.id] = Math.floor(sellable * pct);
    }
    setCargoDirty("cargo");
  }

  function simulateOffline(){
    const last = state.lastSeen || now();
    const dt = Math.max(0, (now() - last)/1000);
    state.lastSeen = now();
    if(dt < 10) return "";

    const capped = Math.min(dt, 12*3600);
    let totalCredits = 0;
    const gained = {};
    for(const o of ORES) gained[o.id]=0;

    for(const pid of Object.keys(PLANETS)){
      const pp = state.planets[pid];
      if(!pp) continue;
      const mult = PLANETS[pid]?.creditMult || 1;
      const planetCredits = (pp.rps || 0) * capped * boostMult();
      totalCredits += planetCredits;

      const drones = pp.dronesLvl || 0;
      const pulses = drones * dronePulsesPerSecondFor(pp) * capped;
      const dropCount = Math.floor(pulses * 0.09 * rareBoostMult());

      const savedPlanet = state.currentPlanet;
      state.currentPlanet = pid;
      for(let i=0;i<dropCount;i++){
        const d = tryCargoDrop();
        if(d){ const took = addOreWithMode(d.id, 1); if(took) gained[d.id]+=1; }
      }
      state.currentPlanet = savedPlanet;
    }

    addCredits(totalCredits);
    addMiningXP((capped/60) * 1.2);

    const cargoSummary = Object.entries(gained).filter(([_,v])=>v>0).map(([k,v])=>`${k}Ã—${v}`).join(", ");
    return `Offline: ${Math.floor(capped/60)}m â€” Credits +${fmt(totalCredits)}${cargoSummary?` â€” Loot ${cargoSummary}`:""}`;
  }

  const upgradeNodes = new Map();
  function escapeHtml(s){ return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
  function pingCard(id){
    const n = upgradeNodes.get(id);
    if(!n) return;
    n.card.classList.remove("purchased");
    void n.card.offsetWidth;
    n.card.classList.add("purchased");
    setTimeout(()=>n.card.classList.remove("purchased"), 600);
  }

  function buyLaser(){
    const p = P();
    if(state.credits < p.costLaser) return toast("Not enough credits.");
    state.credits -= p.costLaser;
    p.laserLvl += 1;
    p.costLaser = Math.floor(p.costLaser * 1.62 + 40);
    applyStats(state);
    toast("Laser upgraded.");
    pingCard("laser");
    updateUpgradeTexts();
    updateUpgradeAffordability();
    updateHUD();
  }

  function buyDrone(){
    const p = P();
    if(state.credits < p.costDrones) return toast("Not enough credits.");
    const oldCount = p.dronesLvl;

    state.credits -= p.costDrones;
    p.dronesLvl += 1;
    p.costDrones = Math.floor(p.costDrones * 1.58 + 120);

    applyStats(state);
    toast("Drone deployed.");
    pingCard("drones");

    syncSpawnedDrones();
    requestAnimationFrame(()=>{
      const newEl = droneEls[oldCount];
      if(newEl){
        newEl.classList.add("spawn");
        playDroneSpawnFX(newEl);
        setTimeout(()=>newEl.classList.remove("spawn"), 650);
      }
    });

    updateUpgradeTexts();
    updateUpgradeAffordability();
    updateHUD();
  }

  function buyDroneAI(){
    const p = P();
    if(state.credits < p.costDroneAI) return toast("Not enough credits.");
    state.credits -= p.costDroneAI;
    p.droneAI += 1;
    p.costDroneAI = Math.floor(p.costDroneAI * 1.65 + 200);
    applyStats(state);
    toast("Drone AI improved.");
    pingCard("droneAI");
    updateUpgradeTexts();
    updateUpgradeAffordability();
    updateHUD();
  }

  function buyProspect(){
    const p = P();
    if(state.credits < p.costProspect) return toast("Not enough credits.");
    state.credits -= p.costProspect;
    p.prospectLvl += 1;
    p.costProspect = Math.floor(p.costProspect * 1.68 + 150);
    toast("Prospecting upgraded.");
    pingCard("prospect");
    updateUpgradeTexts();
    updateUpgradeAffordability();
    updateHUD();
  }

  function overclock(){
    state.boostUntil = Math.max(state.boostUntil, now() + 5*60*1000);
    toast("Overclock active (2Ã—)!");
    updateHUD();
  }

  /* ===== Cosmetics: 3 Drone skins ===== */
  function buyOrEquipDroneSkin(skinId){
    const skin = DRONE_SKINS.find(s=>s.id===skinId);
    if(!skin) return;

    if(!state.cosmetics.owned[skinId]){
      if(state.credits < skin.cost) return toast("Not enough credits.");
      state.credits -= skin.cost;
      state.cosmetics.owned[skinId] = true;
      toast(`${skin.name} unlocked.`);
      pingCard(`skin_${skinId}`);
    }

    state.cosmetics.droneSkin = skinId;
    toast(`Equipped: ${skin.name}`);
    syncSpawnedDrones();          // <-- apply instantly
    updateUpgradeTexts();
    updateUpgradeAffordability();
    updateHUD();
    save();
  }

  const dirty = { cargo:true, recipe:true, trade:true, codex:true };
  function setCargoDirty(which){ dirty[which]=true; }
  function setCargoDirtyAll(){ dirty.cargo=true; dirty.recipe=true; dirty.trade=true; dirty.codex=true; }

  function modeLabel(m){
    if(m==="off") return "Off";
    if(m==="drop") return "Drop";
    if(m==="overflow") return "Overflow";
    return "Off";
  }
  function modeExplain(m){
    if(m==="drop") return "Sells instantly when gained (never stored).";
    if(m==="overflow") return "Keeps up to Keep, auto-sells extra in background.";
    return "Stores normally (no autosell).";
  }
  function modeButtonText(m){
    if(m==="drop") return "Mode: Drop Â· instant sell";
    if(m==="overflow") return "Mode: Overflow Â· auto-sell > Keep";
    return "Mode: Off Â· store";
  }
  function modeChipKind(m){
    if(m==="drop") return "good";
    if(m==="overflow") return "warn";
    return "";
  }
  function nextMode(m){
    if(m==="off") return "drop";
    if(m==="drop") return "overflow";
    return "off";
  }

  const UPGRADE_DEFS = [
    { id:"laser", tab:"core", name:"Laser Power", icon:ICONS.laser, desc:"More Regolith/shot (Credits). Scales perfectly with Overclock.",
      hideBuy:false,
      costText:()=>`${fmt(P().costLaser)} credits`,
      canBuy:()=>state.credits >= P().costLaser,
      chips:()=>[{text:`Level: ${P().laserLvl}`},{text:`+1 / shot`, kind:"good"}],
      current:()=>`Laser: ${P().laserPower}`,
      next:()=>`Next: Laser ${P().laserPower+1}`,
      buy:buyLaser
    },
    { id:"drones", tab:"core", name:"Deploy Mining Drone", icon:ICONS.drones,
      desc:"Spawns 1 Drone on this planet. Drones on other planets keep running independently.",
      hideBuy:false,
      costText:()=>`${fmt(P().costDrones)} credits`,
      canBuy:()=>state.credits >= P().costDrones,
      chips:()=>[
        {text:`Drones: ${P().dronesLvl}`, kind: P().dronesLvl>0 ? "good" : ""},
        {text:`Pulse/s: ${dronePulsesPerSecondFor(P()).toFixed(2)}`, kind:"warn"},
        {text:`Per pulse: ${droneCreditsPerPulseFor(P(), state.currentPlanet)}c`, kind:"good"}
      ],
      current:()=>`Regolith/s: ${(P().rps * boostMult()).toFixed(1)}`,
      next:()=>`Next: +${(dronePulsesPerSecondFor(P())*droneCreditsPerPulseFor(P(),state.currentPlanet)).toFixed(1)}/s`,
      buy:buyDrone
    },
    { id:"droneAI", tab:"core", name:"Drone AI Uplink", icon:ICONS.ai,
      desc:"Improves Drone speed + yield on this planet.",
      hideBuy:false,
      costText:()=>`${fmt(P().costDroneAI)} credits`,
      canBuy:()=>state.credits >= P().costDroneAI,
      chips:()=>[
        {text:`AI Level: ${P().droneAI}`},
        {text:`Pulse/s: ${dronePulsesPerSecondFor(P()).toFixed(2)}`, kind:"warn"},
        {text:`Per pulse: ${droneCreditsPerPulseFor(P(), state.currentPlanet)}c`, kind:"good"}
      ],
      current:()=>`More frequent drone cycles`,
      next:()=>`Next: faster + stronger`,
      buy:buyDroneAI
    },
    { id:"prospect", tab:"core", name:"Prospecting Array", icon:ICONS.prospect,
      desc:"Boosts rare drop rates (Clicks + Drones) on this planet.",
      hideBuy:false,
      costText:()=>`${fmt(P().costProspect)} credits`,
      canBuy:()=>state.credits >= P().costProspect,
      chips:()=>[
        {text:`Level: ${P().prospectLvl}`},
        {text:`Rare Ã—${rareBoostMult().toFixed(2)}`, kind:"good"}
      ],
      current:()=>`Boosts rare drops`,
      next:()=>`Next: +6% rare mult`,
      buy:buyProspect
    },

    { id:"cargoPanel", tab:"cargo", name:"Cargo Bay", icon:ICONS.cargo, desc:"Per-ore modes: Off Â· Drop (instant) Â· Overflow (auto-sell above Keep).",
      hideBuy:true, costText:()=>`â€”`, canBuy:()=>true,
      chips:()=>[
        {text:`Tier: Mk${state.cargoTier}`},
        {text:`Cap: ${state.cargoCap}`, kind:"warn"},
        {text: state.autoSellOnFull ? "Auto-sell on full: ON" : "Auto-sell on full: OFF", kind: state.autoSellOnFull ? "good" : "bad"}
      ],
      current:()=>`Stored: ${totalCargoUnits()}/${state.cargoCap}`,
      next:()=>`Set per-ore behavior`,
      buy:()=>{}
    },
    { id:"recipePanel", tab:"cargo", name:"Cargo Crafting", icon:ICONS.cargo, desc:"Capacity upgrades via ore recipes (stash mats with Keep).",
      hideBuy:true, costText:()=>`â€”`, canBuy:()=>true,
      chips:()=>[{text:`Recipe: ${currentRecipe().name}`}],
      current:()=>`Cap: ${state.cargoCap}`,
      next:()=>`Next: +50 cap`,
      buy:()=>{}
    },
    { id:"tradePanel", tab:"cargo", name:"Trade Terminal", icon:ICONS.trade, desc:"Rotates every 6 hours. Each offer is 1Ã— per rotation. Unlock MR 6.",
      hideBuy:true, costText:()=>`â€”`, canBuy:()=>true,
      chips:()=>[{text:`Unlock: MR 6`},{text:`1Ã— per offer / rotation`, kind:"warn"}],
      current:()=> state.minerRank>=6 ? `Online` : `Locked`,
      next:()=>`Refresh on rotation`,
      buy:()=>{}
    },

    /* Cosmetic tab: ONLY drone skins */
    ...DRONE_SKINS.filter(s=>s.id!=="default").map(skin => ({
      id:`skin_${skin.id}`,
      tab:"cos",
      name: skin.name,
      icon: ICONS.skin,
      desc: skin.desc + " (Drones only)",
      hideBuy:false,
      costText:()=> state.cosmetics.owned[skin.id] ? "Owned" : `${fmt(skin.cost)} credits`,
      canBuy:()=> state.cosmetics.owned[skin.id] ? true : (state.credits >= skin.cost),
      chips:()=>[
        {text: state.cosmetics.owned[skin.id] ? "Owned" : "Not owned", kind: state.cosmetics.owned[skin.id] ? "good" : "bad"},
        {text: (state.cosmetics.droneSkin===skin.id) ? "Equipped" : "â€”", kind: (state.cosmetics.droneSkin===skin.id) ? "good" : ""}
      ],
      current:()=> (state.cosmetics.droneSkin===skin.id) ? "Active drone look" : "Not equipped",
      next:()=> state.cosmetics.owned[skin.id] ? "Equip anytime" : "Unlock + equip",
      buy:()=>buyOrEquipDroneSkin(skin.id),
      buttonText:()=> state.cosmetics.owned[skin.id] ? ((state.cosmetics.droneSkin===skin.id) ? "Equipped" : "Equip") : "Buy"
    }))
  ];

  function buildTab(tab){
    upgradesListEl.innerHTML = "";
    upgradeNodes.clear();

    const list = UPGRADE_DEFS.filter(u => u.tab === tab);
    for(const u of list){
      const card = document.createElement("div");
      card.className = "uCard";
      card.dataset.upg = u.id;

      const chipsHtml = u.chips().map(ch=>{
        const cls = ch.kind ? `chip ${ch.kind}` : "chip";
        return `<span class="${cls}">${escapeHtml(ch.text)}</span>`;
      }).join("");

      card.innerHTML = `
        <div class="uPing"></div>
        <div class="uTop">
          <div class="uLeft">
            <div class="uIcon">${u.icon}</div>
            <div style="min-width:0">
              <div class="uName">${u.name}</div>
              <div class="uDesc">${u.desc}</div>
              <div class="uMeta">
                <span class="chips">${chipsHtml}</span>
                <span class="chip cur"><strong>${escapeHtml(u.current())}</strong></span>
                <span class="chip nxt">${escapeHtml(u.next())}</span>
              </div>
            </div>
          </div>
          <div class="uRight">
            <div class="uCost"><span>Cost</span> Â· <b class="cost">${escapeHtml(u.costText())}</b></div>
            <button class="btn uBuy">Buy</button>
          </div>
        </div>
      `;

      const btn = card.querySelector("button.uBuy");
      const costWrap = card.querySelector(".uCost");
      if(u.hideBuy){
        btn.style.display = "none";
        costWrap.style.display = "none";
      }else{
        btn.textContent = (typeof u.buttonText==="function") ? u.buttonText() : "Buy";
        btn.addEventListener("click", () => u.buy());
      }

      if(u.tab === "cargo"){
        const body = document.createElement("div");
        body.className = "body";
        card.appendChild(body);
      }

      upgradesListEl.appendChild(card);

      upgradeNodes.set(u.id, {
        card, btn,
        costEl: card.querySelector("b.cost"),
        curEl: card.querySelector(".chip.cur strong"),
        nextEl: card.querySelector(".chip.nxt"),
        chipsEl: card.querySelector(".chips"),
        bodyEl: card.querySelector(".body")
      });
    }

    updateUpgradeTexts();
    updateUpgradeAffordability();

    if(tab === "cargo"){
      mountCargoDelegationOnce();
      setCargoDirtyAll();
      renderCargoPanelsIfDirty(true);
    }
  }

  function updateUpgradeTexts(){
    const list = UPGRADE_DEFS.filter(u => u.tab === state.shopTab);
    for(const u of list){
      const n = upgradeNodes.get(u.id);
      if(!n) continue;
      if(!u.hideBuy) n.costEl.textContent = u.costText();
      n.curEl.textContent = u.current();
      n.nextEl.textContent = u.next();
      n.chipsEl.innerHTML = u.chips().map(ch=>{
        const cls = ch.kind ? `chip ${ch.kind}` : "chip";
        return `<span class="${cls}">${escapeHtml(ch.text)}</span>`;
      }).join("");

      if(!u.hideBuy){
        n.btn.textContent = (typeof u.buttonText==="function") ? u.buttonText() : "Buy";
      }
    }
  }

  function updateUpgradeAffordability(){
    const list = UPGRADE_DEFS.filter(u => u.tab === state.shopTab);
    for(const u of list){
      const n = upgradeNodes.get(u.id);
      if(!n) continue;
      if(u.hideBuy) continue;

      /* cosmetics: allow click even if owned (equip) */
      const aff = u.canBuy();
      n.card.classList.toggle("affordable", aff);
      n.btn.disabled = !aff;
      n.btn.classList.toggle("aff", aff);
    }
  }

  /* ===== Codex ===== */
  /* ===== Rank Roadmap ===== */

  // All milestones on the rank road
  const RANK_ROAD = [
    { rank:1,  title:"Mining Begins",       rewards:[], note:"Your journey starts on the Iron Belt." },
    { rank:2,  title:"Nickel Vein",         rewards:[{type:"ore", label:"Nickel ore unlocked", id:"nickel"}] },
    { rank:3,  title:"Signal Boost",        rewards:[{type:"perk", label:"+Drone AI Efficiency"}] },
    { rank:4,  title:"Cobalt Seam",         rewards:[{type:"ore", label:"Cobalt ore unlocked", id:"cobalt"}] },
    { rank:5,  title:"Cargo Protocols",     rewards:[{type:"perk", label:"Advanced cargo modes enabled"}] },
    { rank:6,  title:"Trade Terminal",      rewards:[{type:"trade", label:"Trade Terminal online"}, {type:"ore", label:"Gold ore unlocked", id:"gold"}] },
    { rank:7,  title:"Deep Scan",           rewards:[{type:"perk", label:"+Prospecting efficiency"}] },
    { rank:8,  title:"Platinum Core",       rewards:[{type:"ore", label:"Platinum ore unlocked", id:"platinum"}] },
    { rank:9,  title:"System Expansion",    rewards:[{type:"perk", label:"Offline haul extended to 12h"}] },
    { rank:10, title:"Vulcan Core",         rewards:[{type:"planet", label:"ðŸŒ‹ Vulcan Core unlocked", planet:"vulcan"}, {type:"perk", label:"+Cargo Capacity"}, {type:"ore", label:"Pyrolusite ore", id:"pyrite"}, {type:"ore", label:"Obsidian ore", id:"obsidian"}], major:true },
    { rank:11, title:"Lava Drones",         rewards:[{type:"perk", label:"Vulcan drone tier available"}] },
    { rank:12, title:"Magma Lens",          rewards:[{type:"perk", label:"+Laser power on Vulcan"}] },
    { rank:13, title:"Deep Orbit",          rewards:[{type:"perk", label:"Drone orbit radius expands"}] },
    { rank:14, title:"Void Signal",          rewards:[{type:"perk", label:"Deep-space signal detected"}, {type:"perk", label:"Overclock efficiency +10%"}] },
    { rank:15, title:"Void Expanse",         rewards:[{type:"planet", label:"ðŸŒŒ Void Expanse unlocked", planet:"void"}, {type:"ore", label:"Void Shard ore", id:"voidShard"}, {type:"ore", label:"Dark Matter ore", id:"darkMatter"}], major:true },
    { rank:16, title:"Void Resonance",       rewards:[{type:"perk", label:"Void Surge chance +3%"}, {type:"perk", label:"+10% Void credits"}] },
    { rank:17, title:"Dark Prospector",      rewards:[{type:"perk", label:"Rare drop rate +15% (all planets)"}] },
    { rank:18, title:"Stellar Cartographer", rewards:[{type:"perk", label:"Stellar Dust gain +20%"}, {type:"perk", label:"Prestige cost -5%"}] },
    { rank:19, title:"Event Horizon",        rewards:[{type:"perk", label:"Offline income extended to 24h"}] },
    { rank:20, title:"Singularity",          rewards:[{type:"perk", label:"All planet multipliers +10%"}, {type:"perk", label:"Drone AI speed +25%"}], major:true },
    { rank:21, title:"Quantum Tunneling",    rewards:[{type:"perk", label:"Laser pierces â€” double XP on crits"}] },
    { rank:22, title:"Dark Matter Cache",    rewards:[{type:"perk", label:"Dark Matter drop rate +50%"}, {type:"perk", label:"Cargo capacity +100"}] },
    { rank:23, title:"Warp Efficiency",      rewards:[{type:"perk", label:"Planet switching costs 0 credits"}] },
    { rank:24, title:"Neural Override",      rewards:[{type:"perk", label:"Drone AI tier cap raised"}, {type:"perk", label:"+20% drone yields"}] },
    { rank:25, title:"Void Master",          rewards:[{type:"perk", label:"All Void bonuses Ã—1.5"}, {type:"perk", label:"Prestige Dust Ã—1.2"}], major:true },
    { rank:26, title:"Chronoshard Mining",   rewards:[{type:"perk", label:"Time-based bonus: +1% per hour online"}] },
    { rank:27, title:"Exo-Rig Calibration",  rewards:[{type:"perk", label:"Laser power scales with MR (+2% per rank)"}] },
    { rank:28, title:"Spectral Analysis",    rewards:[{type:"perk", label:"All ore values +15%"}, {type:"perk", label:"Trade sell rate +10%"}] },
    { rank:29, title:"Graviton Drill",       rewards:[{type:"perk", label:"Every 5th laser shot free (no cooldown)"}] },
    { rank:30, title:"Ascendant Miner",      rewards:[{type:"perk", label:"All multipliers stack additively +20%"}, {type:"perk", label:"Stellar Dust cap removed"}], major:true },
    { rank:31, title:"Nebula Walker",        rewards:[{type:"perk", label:"Void Surge triggers on drones too"}] },
    { rank:32, title:"Antimatter Core",      rewards:[{type:"perk", label:"Dark Matter value +30%"}, {type:"perk", label:"Crit chance +5%"}] },
    { rank:33, title:"Deep Void Protocol",   rewards:[{type:"perk", label:"Offline haul quality matches online rate"}] },
    { rank:34, title:"Stellar Architect",    rewards:[{type:"perk", label:"Prestige resets leave 5% upgrade bonus"}, {type:"perk", label:"MR never resets on prestige"}] },
    { rank:35, title:"????? â€” Coming Soon",  rewards:[{type:"planet", label:"ðŸª Unknown World (TBD)", planet:"future"}], major:true },
  ];

  const roadmapBackdrop = el("roadmapBackdrop");
  const roadmapList     = el("roadmapList");
  const roadmapSub      = el("roadmapSub");
  const rmProgressLabel = el("rmProgressLabel");
  const rmProgressFill  = el("rmProgressFill");
  const rmProgressRight = el("rmProgressRight");
  const closeRoadmapBtn = el("closeRoadmap");

  function openRoadmap(){
    renderRoadmap();
    roadmapBackdrop.classList.add("show");
    // scroll to current rank item
    requestAnimationFrame(()=>{
      const cur = roadmapList.querySelector(".current");
      if(cur) cur.scrollIntoView({ behavior:"smooth", block:"center" });
    });
  }
  function closeRoadmap(){ roadmapBackdrop.classList.remove("show"); }

  function renderRoadmap(){
    const mr = state.minerRank;
    const total = RANK_ROAD.length;
    const done  = RANK_ROAD.filter(m => mr > m.rank).length;
    const pct   = Math.round((done / (total-1)) * 100);

    roadmapSub.textContent = `MR ${mr} Â· ${done} of ${total-1} milestones reached`;
    rmProgressLabel.textContent = `MR ${mr}`;
    rmProgressFill.style.width = pct + "%";
    rmProgressRight.textContent = pct + "% unlocked";

    roadmapList.innerHTML = "";

    for(const m of RANK_ROAD){
      const isDone    = mr > m.rank;
      const isCurrent = mr === m.rank;
      const isLocked  = mr < m.rank;
      const isMajor   = !!m.major;

      let cls = "rmItem";
      if(isMajor)   cls += " major";
      if(isDone)    cls += " done";
      if(isCurrent) cls += " current";
      if(isLocked)  cls += " locked";

      // status tag
      const statusTag = isDone
        ? `<span class="rmStatusTag done">âœ“ Done</span>`
        : isCurrent
          ? `<span class="rmStatusTag current">â–¶ Now</span>`
          : `<span class="rmStatusTag locked">MR ${m.rank}</span>`;

      // rewards chips
      const rewardChips = m.rewards.map(r => {
        let cls2 = "rmReward";
        let icon = "";
        let label = r.label;
        if(r.type === "ore"){
          cls2 += " ore";
          icon = r.id ? oreIconHTML(r.id, 14) : "";
          if(isDone || isCurrent) cls2 += " unlocked";
        } else if(r.type === "planet"){
          cls2 += " planet";
          if(r.planet !== "future" && (isDone || isCurrent)) cls2 += " unlocked";
        } else if(r.type === "perk"){
          cls2 += " perk";
          if(isDone || isCurrent) cls2 += " unlocked";
        } else if(r.type === "trade"){
          cls2 += " trade";
          if(isDone || isCurrent) cls2 += " unlocked";
        }
        return `<span class="${cls2}">${icon}${escapeHtml(label)}</span>`;
      }).join("");

      // XP progress bar inside current rank
      const xpBar = isCurrent ? `
        <div class="rmXpBar">
          <div class="rmXpFill" style="width:${Math.min(100,(state.miningXP/state.miningNeed)*100).toFixed(1)}%"></div>
        </div>
        <div class="muted" style="font-size:11px;margin-top:4px;">${Math.floor(state.miningXP)} / ${state.miningNeed} XP to MR ${mr+1}</div>
      ` : "";

      const noteHtml = m.note && !isDone
        ? `<div class="muted" style="font-size:11px;margin-top:6px;opacity:.75;">${escapeHtml(m.note)}</div>`
        : "";

      const html = `
        <div class="${cls}">
          <div class="rmDot"></div>
          <div class="rmHeader">
            <div class="rmLeft">
              <span class="rmRank">MR ${m.rank}</span>
              <span class="rmTitle">${escapeHtml(m.title)}</span>
            </div>
            ${statusTag}
          </div>
          ${rewardChips ? `<div class="rmRewards">${rewardChips}</div>` : ""}
          ${xpBar}
          ${noteHtml}
        </div>`;

      roadmapList.insertAdjacentHTML("beforeend", html);
    }
  }

  function openCodex(){
    dirty.codex = true;
    renderCodexIfDirty();
    codexBackdrop.classList.add("show");
  }
  function closeCodex(){ codexBackdrop.classList.remove("show"); }
  function rarityLabel(r){
    if(r >= 0.40) return { t:"Common", cls:"good" };
    if(r >= 0.18) return { t:"Uncommon", cls:"warn" };
    if(r >= 0.06) return { t:"Rare", cls:"warn" };
    return { t:"Exotic", cls:"bad" };
  }
  function renderCodexIfDirty(){
    if(!dirty.codex) return;
    dirty.codex = false;

    codexSub.textContent = `Miner Rank MR ${state.minerRank} Â· Unlocks are rank-based`;
    const items = ORES.slice().sort((a,b)=>a.unlockMR-b.unlockMR).map(o=>{
      const unlocked = oreUnlocked(o.id);
      const r = rarityLabel(o.rarity);
      const icon = `<div class="codexIcon">${oreIconHTML(o.id, 22)}</div>`;
      const right = [
        `<span class="chip ${unlocked ? "good":"bad"}">${unlocked ? "Unlocked" : `MR ${o.unlockMR}`}</span>`,
        `<span class="chip"><strong>${o.value}c</strong> value</span>`,
        `<span class="chip ${r.cls}">${r.t}</span>`
      ].join("");
      return `
        <div class="codexItem">
          <div class="codexLeft">
            ${icon}
            <div>
              <div class="codexName">${o.name}</div>
              <div class="codexMeta">Drop weight: ${o.rarity}</div>
            </div>
          </div>
          <div class="codexRight">${right}</div>
        </div>
      `;
    }).join("");

    codexGrid.innerHTML = items;
  }

  /* ===== Cargo UI rendering ===== */
  function isRecentlyUnlocked(oreId){
    const cutoff = now() - 20000;
    state.recentUnlocks = state.recentUnlocks.filter(x => x.ts >= cutoff);
    return state.recentUnlocks.some(x => x.id === oreId);
  }

  function cargoPanelHTML(){
    const used = totalCargoUnits();
    const cap = state.cargoCap;
    const pct = cap ? Math.min(100, used/cap*100) : 0;
    const onFullCls = state.autoSellOnFull ? "toggle on" : "toggle off";

    const rows = ORES
      .filter(o => oreUnlocked(o.id))
      .map(o => {
        const have = Math.floor(state.cargo[o.id]||0);
        const plan = Math.floor(state.sellPlan[o.id]||0);
        const set = state.oreSettings[o.id] || {locked:false, keep:0, autoSellMode:"off"};
        const keep = Math.floor(set.keep||0);
        const sellable = Math.max(0, have - keep);

        const lockCls = set.locked ? "miniBtn good" : "miniBtn";
        const kind = modeChipKind(set.autoSellMode);
        const modeCls = "miniBtn " + (kind||"");
        const title = modeExplain(set.autoSellMode);

        const badges = [];
        if(set.locked) badges.push(`<span class="badge good">Locked</span>`);
        if(keep > 0) badges.push(`<span class="badge warn">Keep</span>`);
        if(set.autoSellMode === "drop") badges.push(`<span class="badge good">Drop</span>`);
        if(set.autoSellMode === "overflow") badges.push(`<span class="badge warn">Overflow</span>`);

        const unlockCls = isRecentlyUnlocked(o.id) ? "cargoRow newUnlock" : "cargoRow";

        return `
          <div class="${unlockCls}" data-ore-row="${o.id}">
            <div>
              <div class="oreHead">
                <div class="oreIcon">${oreIconHTML(o.id, 22)}</div>
                <div style="min-width:0">
                  <div class="oreName">
                    ${o.name} <span style="opacity:.75">(${o.value}c)</span>
                    ${badges.join(" ")}
                  </div>
                  <div class="oreMeta">
                    Owned: <b>${have}</b> Â· Sellable: <b>${sellable}</b> Â· Keep: <b>${keep}</b>
                  </div>
                </div>
              </div>
            </div>

            <div>
              <div class="miniControls">
                <button class="${lockCls}" data-act="toggleLock" data-ore="${o.id}">${set.locked ? "Locked" : "Lock"}</button>

                <button class="${modeCls}" data-act="cycleMode" data-ore="${o.id}" title="${escapeHtml(title)}">
                  ${escapeHtml(modeButtonText(set.autoSellMode))}
                </button>

                <span class="chip">Keep</span>
                <input data-act="keepInput" data-ore="${o.id}" value="${keep}" inputmode="numeric"
                      style="width:62px;height:32px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.22);color:var(--txt);text-align:center;font-weight:950;" />
              </div>

              <div class="modeHint">
                <b>${escapeHtml(modeLabel(set.autoSellMode))}:</b> ${escapeHtml(modeExplain(set.autoSellMode))}
              </div>
            </div>

            <div style="text-align:right;">
              <div class="muted">Sell selection</div>
              <div class="stepper" data-ore="${o.id}">
                <button data-act="minus" data-ore="${o.id}">âˆ’</button>
                <input data-act="sellInput" data-ore="${o.id}" value="${plan}" inputmode="numeric" />
                <button data-act="plus" data-ore="${o.id}">+</button>
              </div>
              <div style="margin-top:6px;font-weight:950;">${fmt(plan*o.value)}c</div>
            </div>
          </div>
        `;
      }).join("");

    return `
      <div class="cargoTop">
        <div class="chip"><strong>Capacity:</strong> ${used}/${cap} (${Math.round(pct)}%)</div>
        <div class="row" style="gap:8px;">
          <button class="btn secondary" data-act="openCodex" style="padding:10px 12px;border-radius:14px;">Ore Codex</button>
          <div class="${onFullCls}" data-act="toggleAutoFull">
            Auto-sell on full: <b>${state.autoSellOnFull ? "ON" : "OFF"}</b>
          </div>
        </div>
      </div>

      <div style="margin-top:10px;">
        <div class="bar"><div style="width:${pct}%;"></div></div>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="btn good" data-act="sellSelected" style="flex:1;min-width:170px;">Sell Selected</button>
      </div>

      <div class="selectRow">
        <button class="btn secondary" data-act="sel25" style="flex:1;min-width:120px;">Select 25%</button>
        <button class="btn secondary" data-act="sel50" style="flex:1;min-width:120px;">Select 50%</button>
        <button class="btn secondary" data-act="sel100" style="flex:1;min-width:120px;">Select 100%</button>
      </div>

      <div class="muted" style="margin-top:10px;font-size:12px;">
        <b>Tip:</b> <span class="chip warn">Overflow</span> + <span class="chip">Keep</span> = autosell only overflow.
        <span class="chip good">Drop</span> = instant credits.
      </div>

      <div style="margin-top:10px;">
        ${rows || `<div class="muted">No cargo yet. Rare drops land here.</div>`}
      </div>
    `;
  }

  function recipePanelHTML(){
    const r = currentRecipe();
    if(!r.req) return `<div class="muted">Cargo Bay is maxed.</div>`;
    const parts = Object.entries(r.req).map(([id,amt])=>{
      const have = Math.floor(state.cargo[id]||0);
      return `${oreIconHTML(id, 16)} ${id} ${have}/${amt}`;
    }).join(" Â· ");
    const can = hasRecipeReq(r.req);
    return `
      <div class="chip"><strong>${r.name}</strong></div>
      <div class="muted" style="margin-top:6px;">Requires: ${parts}</div>
      <div class="muted" style="margin-top:6px;">Effect: ${r.effect}</div>
      <div class="row" style="margin-top:10px;">
        <button class="btn ${can?"good":"secondary"}" data-act="craftCargo" ${can?"":"disabled"} style="flex:1;">Craft</button>
      </div>
      <div class="muted" style="margin-top:8px;font-size:12px;">Use Keep reserves to stockpile crafting mats.</div>
    `;
  }

  let tradeTimerEl = null;

  function tradeItemLabel(it){
    if(it.id==="credits"){
      return `${oreIconHTML("coin", 16)} ${fmt(it.amt)} credits`;
    }
    return `${oreIconHTML(it.id, 16)} ${it.amt} ${it.id}`;
  }
  function tradePanelHTML(){
    if(state.minerRank < 6) return `<div class="muted">Locked. Unlock at Miner Rank MR 6.</div>`;
    if(!state.trades.offers || state.trades.offers.length===0) rerollTrades();

    const offerHtml = state.trades.offers.map((of, i) => {
      const used = !!of.used;
      const giveLabel = tradeItemLabel(of.give);
      const getLabel  = tradeItemLabel(of.get);
      const can = canPayTrade(of.give) && !used;
      const bonusTxt = `+${of.bonus}%`;

      return `
        <div class="trade">
          <div>
            <b>Offer ${i+1}</b>
            <div class="muted" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
              <span>${giveLabel}</span> <span>â†’</span> <span>${getLabel}</span>
              <span>Â·</span>
              <b style="color:rgba(50,213,131,.95)">${bonusTxt}</b>
              ${used ? `<span class="chip bad">USED</span>` : `<span class="chip warn">1Ã—</span>`}
            </div>
          </div>
          <button class="btn ${can?"good":"secondary"}" data-act="trade" data-trade="${i}" ${can?"":"disabled"} style="min-width:120px;">
            ${used ? "Used" : "Swap"}
          </button>
        </div>
      `;
    }).join("");

    return `
      <div class="muted">Each offer is usable once. Refreshes automatically on the next rotation.</div>
      <div style="margin-top:10px;">${offerHtml}</div>
      <div class="muted" style="margin-top:10px;font-size:12px;">Next rotation: <span id="tradeTimer">--:--</span></div>
    `;
  }
  function updateTradeTimerTextOnly(){
    if(state.shopTab !== "cargo") return;
    if(!tradeTimerEl) return;
    const ms = Math.max(0, state.trades.nextReroll - now());
    const mins = Math.floor(ms/60000);
    const secs = Math.floor((ms%60000)/1000);
    tradeTimerEl.textContent = `${mins}:${String(secs).padStart(2,"0")}`;
  }

  function renderCargoPanelsIfDirty(force=false){
    if(state.shopTab !== "cargo") return;

    const cargoNode = upgradeNodes.get("cargoPanel");
    const recipeNode = upgradeNodes.get("recipePanel");
    const tradeNode  = upgradeNodes.get("tradePanel");
    if(!cargoNode || !recipeNode || !tradeNode) return;

    if(force || dirty.cargo){ cargoNode.bodyEl.innerHTML = cargoPanelHTML(); dirty.cargo = false; }
    if(force || dirty.recipe){ recipeNode.bodyEl.innerHTML = recipePanelHTML(); dirty.recipe = false; }
    if(force || dirty.trade){
      tradeNode.bodyEl.innerHTML = tradePanelHTML();
      tradeTimerEl = tradeNode.bodyEl.querySelector("#tradeTimer");
      dirty.trade = false;
      updateTradeTimerTextOnly();
    }

    updateUpgradeTexts();
    updateHUD();
    updateUpgradeAffordability();
  }

  let cargoDelegationMounted = false;
  function mountCargoDelegationOnce(){
    if(cargoDelegationMounted) return;
    cargoDelegationMounted = true;

    upgradesListEl.addEventListener("click", (e) => {
      const t = e.target;
      if(!(t instanceof HTMLElement)) return;
      const act = t.getAttribute("data-act");
      if(!act) return;

      if(act === "openCodex"){ openCodex(); return; }
      if(act === "sellSelected"){ sellSelected(); return; }
      if(act === "sel25"){ setSelectionPercent(0.25); renderCargoPanelsIfDirty(); return; }
      if(act === "sel50"){ setSelectionPercent(0.5); renderCargoPanelsIfDirty(); return; }
      if(act === "sel100"){ setSelectionPercent(1); renderCargoPanelsIfDirty(); return; }

      if(act === "toggleAutoFull"){
        state.autoSellOnFull = !state.autoSellOnFull;
        setCargoDirty("cargo");
        renderCargoPanelsIfDirty();
        return;
      }

      if(act === "toggleLock"){
        const ore = t.getAttribute("data-ore");
        if(!ore) return;
        state.oreSettings[ore].locked = !state.oreSettings[ore].locked;
        setCargoDirty("cargo");
        renderCargoPanelsIfDirty();
        return;
      }

      if(act === "cycleMode"){
        const ore = t.getAttribute("data-ore");
        if(!ore) return;
        const cur = state.oreSettings[ore].autoSellMode || "off";
        const nxt = nextMode(cur);
        state.oreSettings[ore].autoSellMode = nxt;

        if(nxt === "overflow"){
          if(state.oreSettings[ore].keep === 0 && ore !== "iron" && ore !== "nickel"){
            state.oreSettings[ore].keep = 2;
          }
        }

        setCargoDirty("cargo");
        renderCargoPanelsIfDirty();
        return;
      }

      if(act === "minus" || act === "plus"){
        const ore = t.getAttribute("data-ore");
        if(!ore) return;
        const have = Math.floor(state.cargo[ore]||0);
        const keep = Math.floor(state.oreSettings[ore]?.keep||0);
        const maxSell = Math.max(0, have - keep);
        const cur = Math.floor(state.sellPlan[ore]||0);
        const next = act === "plus" ? cur+1 : cur-1;
        state.sellPlan[ore] = clamp(next, 0, maxSell);
        setCargoDirty("cargo");
        renderCargoPanelsIfDirty();
        return;
      }

      if(act === "craftCargo"){
        craftCargo();
        renderCargoPanelsIfDirty();
        return;
      }

      if(act === "trade"){
        const idx = parseInt(t.getAttribute("data-trade")||"-1",10);
        const offer = state.trades.offers[idx];
        if(!offer) return;
        if(state.minerRank < 6) return toast("Trade Terminal locked.");
        if(offer.used) return toast("Offer already used. Wait for next rotation.");
        if(!canPayTrade(offer.give)) return toast("Not enough resources.");

        payTrade(offer.give);
        receiveTrade(offer.get);
        offer.used = true;

        toast("Trade completed.");
        setCargoDirtyAll();
        renderCargoPanelsIfDirty();
        return;
      }
    });

    upgradesListEl.addEventListener("change", (e) => {
      const t = e.target;
      if(!(t instanceof HTMLElement)) return;

      const act = t.getAttribute("data-act");
      const ore = t.getAttribute("data-ore");

      if(act === "sellInput" && ore){
        const have = Math.floor(state.cargo[ore]||0);
        const keep = Math.floor(state.oreSettings[ore]?.keep||0);
        const maxSell = Math.max(0, have - keep);
        state.sellPlan[ore] = clamp(parseInt((t).value||"0",10)||0, 0, maxSell);
        setCargoDirty("cargo");
        renderCargoPanelsIfDirty();
        return;
      }

      if(act === "keepInput" && ore){
        const v = clamp(parseInt((t).value||"0",10)||0, 0, 999999);
        state.oreSettings[ore].keep = v;

        const have = Math.floor(state.cargo[ore]||0);
        const maxSell = Math.max(0, have - v);
        state.sellPlan[ore] = clamp(state.sellPlan[ore]||0, 0, maxSell);

        setCargoDirty("cargo");
        renderCargoPanelsIfDirty();
        return;
      }
    });
  }

  function updateHUD(){
    creditsEl.textContent = fmt(state.credits);
    const ap = P();
    rpsEl.textContent = ((ap.rps||0) * boostMult()).toFixed(1);
    laserPowerEl.textContent = ap.laserPower || 1;

    minerRankEl.textContent = state.minerRank;
    xpNowEl.textContent = Math.floor(state.miningXP);
    xpNeedEl.textContent = state.miningNeed;
    el("stellarDustHud").textContent = fmt(state.stellarDust || 0);
    xpBarEl.style.width = `${Math.min(100, (state.miningXP/state.miningNeed)*100)}%`;
    rankPerkTextEl.textContent = currentRankBonusText();
    nextUnlockTextEl.textContent = nextUnlockText();

    const active = now() < state.boostUntil;

    applyPlanetVisuals();
  }

  function setTab(tab){
    state.shopTab = tab;
    tabCore.classList.toggle("active",  tab==="core");
    tabCargo.classList.toggle("active", tab==="cargo");
    tabSkill.classList.toggle("active", tab==="skill");
    tabCos.classList.toggle("active",   tab==="cos");
    if(tab === "skill"){
      upgradesListEl.innerHTML = "";
      upgradeNodes.clear();
      renderSkillTree();
      // render skill tree inside the upgrades panel
      const wrapper = document.createElement("div");
      wrapper.id = "skillTreeEl";
      wrapper.style.cssText = "display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-top:10px;";
      upgradesListEl.appendChild(wrapper);
      renderSkillTree();
    } else {
      buildTab(tab);
    }
    updateHUD();
  }

  let lastTick = now();
  let lastSecond = -1;

  function tick(){
    const t = now();
    const dt = (t - lastTick)/1000;
    lastTick = t;

    try{
      if(state.trades && state.trades.nextReroll && t >= state.trades.nextReroll){
        rerollTrades();
        setCargoDirty("trade");
      }

      stepDroneCharges(dt);

      const sec = Math.floor(t/1000);
      if(sec !== lastSecond){
        lastSecond = sec;
        autoSellOverflowSweep();
        updateTradeTimerTextOnly();
        renderCargoPanelsIfDirty(false);
        applyStats(state);
        renderCodexIfDirty();
      }

      updateHUD();
      updateUpgradeAffordability();
      save();
    }catch(err){
      console.error("Tick error:", err);
    }

    requestAnimationFrame(tick);
  }

  // Prevent double-tap zoom on the click area via JS (belt-and-suspenders with CSS touch-action)
  clickArea.addEventListener("touchend", (e) => e.preventDefault(), { passive: false });
  clickArea.addEventListener("pointerdown", (e) => { e.preventDefault(); doShot(e.clientX, e.clientY); });
  el("openPlanetsBtn").addEventListener("click", openPlanetOverview);
  el("closePlanets").addEventListener("click", closePlanetOverview);
  el("planetsBackdrop").addEventListener("click", (e)=>{ if(e.target===el("planetsBackdrop")) closePlanetOverview(); });

  el("openQuestsBtn").addEventListener("click", openQuests);
  el("closeQuests").addEventListener("click", closeQuests);
  el("questBackdrop").addEventListener("click", (e)=>{ if(e.target===el("questBackdrop")) closeQuests(); });

  el("closeSkill").addEventListener("click", ()=>el("skillBackdrop").classList.remove("show"));
  el("skillBackdrop").addEventListener("click", (e)=>{ if(e.target===el("skillBackdrop")) el("skillBackdrop").classList.remove("show"); });
  el("btnPlanetIron").addEventListener("click", ()=>switchPlanet("iron"));
  el("btnPlanetVulcan").addEventListener("click", ()=>switchPlanet("vulcan"));
  if(el("btnPlanetVoid")) el("btnPlanetVoid").addEventListener("click", ()=>switchPlanet("void"));
  el("reset").addEventListener("click", ()=>{
    if(!confirm("Wirklich alles zurÃ¼cksetzen?")) return;
    state = defaultState();
    applyStats(state);
    save();
    // Push reset score (MR1, 0c) to leaderboard
    lbSilentSync();
    location.reload();
  });

  const tabSkill  = el("tabSkill");

  tabCore.addEventListener("click",  ()=>setTab("core"));
  tabCargo.addEventListener("click", ()=>setTab("cargo"));
  tabSkill.addEventListener("click", ()=>setTab("skill"));
  tabCos.addEventListener("click",   ()=>setTab("cos"));

  toggleOfflineBtn.addEventListener("click", ()=>{
    offlineTextEl.style.display = (offlineTextEl.style.display==="none" ? "block" : "none");
  });

  closeCodexBtn.addEventListener("click", closeCodex);
  codexBackdrop.addEventListener("click", (e)=>{ if(e.target === codexBackdrop) closeCodex(); });

  el("openRoadmapBtn").addEventListener("click", openRoadmap);
  closeRoadmapBtn.addEventListener("click", closeRoadmap);
  roadmapBackdrop.addEventListener("click", (e)=>{ if(e.target === roadmapBackdrop) closeRoadmap(); });

  window.addEventListener("keydown", (e)=>{
    if(e.key === "Escape"){
      if(codexBackdrop.classList.contains("show")) closeCodex();
      if(roadmapBackdrop.classList.contains("show")) closeRoadmap();
      if(questBackdrop.classList.contains("show")) closeQuests();
      if(planetsBackdrop.classList.contains("show")) closePlanetOverview();
      if(el("skillBackdrop").classList.contains("show")) el("skillBackdrop").classList.remove("show");
      if(el("lbBackdrop").classList.contains("show")) closeLeaderboard();
      if(el("prestigeBackdrop").classList.contains("show")) closePrestige();
    }
  });

  let state = load();
  applyStats(state);
  state.planetsBought = state.planetsBought || {};
  if(!state.skills) state.skills = [];
  if(!state.quests) state.quests = { date:"", list:[] };

  if(!state.trades || !state.trades.offers || state.trades.offers.length===0){
    state.trades = { seed:0, nextReroll:0, offers:[] };
    rerollTrades();
  } else {
    state.trades.offers = state.trades.offers.map(of => of ? ({ used:false, ...of }) : of);
  }

  ensureQuests();
  syncSpawnedDrones();
  applyPlanetVisuals();
  renderQuestStrip();

  const offSummary = simulateOffline();
  if(offSummary){
    state.lastOfflineSummary = offSummary;
    offlineTextEl.textContent = offSummary;
    offlineTextEl.style.display = "block";
  }else{
    offlineTextEl.textContent = state.lastOfflineSummary || "No offline haul yet.";
  }

  setTab(state.shopTab || "core");
  updateHUD();
  requestAnimationFrame(tick);

  /* ===== Audio Engine ===== */
  const Audio = (() => {
    let ctx = null;
    let masterGain = null;
    let musicGain = null;
    let sfxGain = null;
    let musicPlaying = false;
    let musicNodes = [];
    let musicScheduled = false;

    function getCtx() {
      if (!ctx) {
        ctx = new (window.AudioContext || window.webkitAudioContext)();
        masterGain = ctx.createGain();
        masterGain.gain.value = 0.55;
        masterGain.connect(ctx.destination);

        musicGain = ctx.createGain();
        musicGain.gain.value = 0.38;
        musicGain.connect(masterGain);

        sfxGain = ctx.createGain();
        sfxGain.gain.value = 0.7;
        sfxGain.connect(masterGain);
      }
      if (ctx.state === 'suspended') ctx.resume();
      return ctx;
    }

    // â”€â”€ Utility â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function osc(type, freq, startT, endT, gainVal, gainEnd, dest) {
      const ac = getCtx();
      const o = ac.createOscillator();
      const g = ac.createGain();
      o.type = type;
      o.frequency.setValueAtTime(freq, startT);
      g.gain.setValueAtTime(gainVal, startT);
      g.gain.exponentialRampToValueAtTime(Math.max(0.0001, gainEnd), endT);
      o.connect(g); g.connect(dest || sfxGain);
      o.start(startT); o.stop(endT);
      return { o, g };
    }

    function noise(startT, dur, gainVal, dest) {
      const ac = getCtx();
      const buf = ac.createBuffer(1, Math.floor(ac.sampleRate * dur), ac.sampleRate);
      const d = buf.getChannelData(0);
      for (let i = 0; i < d.length; i++) d[i] = Math.random() * 2 - 1;
      const src = ac.createBufferSource();
      src.buffer = buf;
      const g = ac.createGain();
      g.gain.setValueAtTime(gainVal, startT);
      g.gain.exponentialRampToValueAtTime(0.0001, startT + dur);
      src.connect(g); g.connect(dest || sfxGain);
      src.start(startT); src.stop(startT + dur);
    }

    // â”€â”€ SFX: UI Click â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function sfxClick() {
      const ac = getCtx();
      const t = ac.currentTime;
      osc('sine', 820, t, t + 0.06, 0.12, 0.001);
      osc('sine', 1100, t, t + 0.04, 0.06, 0.001);
    }

    // â”€â”€ Music Engine: generative ambient space â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Uses layered drones, slow filter sweeps, sparse chime melodies
    const DRONE_NOTES = [55, 82.4, 110, 146.8, 164.8]; // A1, E2, A2, D3, E3
    const CHIME_SCALE = [261.6, 293.7, 329.6, 392, 440, 523.3, 587.3, 659.3]; // C4 pentatonic+

    function startMusic() {
      if (musicScheduled) return;
      musicScheduled = true;
      const ac = getCtx();

      // Layer 1: deep drone pad (2 detuned saws)
      function makeDrone(freq, detune, gainVal) {
        const o = ac.createOscillator();
        const g = ac.createGain();
        const filter = ac.createBiquadFilter();
        o.type = 'sawtooth';
        o.frequency.value = freq;
        o.detune.value = detune;
        filter.type = 'lowpass';
        filter.frequency.value = 280;
        filter.Q.value = 1.2;
        g.gain.value = gainVal;
        o.connect(filter); filter.connect(g); g.connect(musicGain);
        o.start();
        // Slow LFO on filter freq
        const lfo = ac.createOscillator();
        const lfoG = ac.createGain();
        lfo.frequency.value = 0.07 + Math.random() * 0.04;
        lfoG.gain.value = 60;
        lfo.connect(lfoG); lfoG.connect(filter.frequency);
        lfo.start();
        musicNodes.push(o, lfo, g, lfoG, filter);
        return { o, g, filter };
      }

      makeDrone(55,   0,   0.18);
      makeDrone(55,  +8,   0.10);
      makeDrone(82.4, -5,  0.09);
      makeDrone(110,  +3,  0.06);

      // Layer 2: shimmer pad (high sine harmonics, very quiet)
      function makeShimmer(freq, gainVal) {
        const o = ac.createOscillator();
        const g = ac.createGain();
        const filter = ac.createBiquadFilter();
        o.type = 'sine';
        o.frequency.value = freq;
        filter.type = 'highpass';
        filter.frequency.value = 800;
        g.gain.value = 0;
        o.connect(filter); filter.connect(g); g.connect(musicGain);
        o.start();
        // slow fade in
        g.gain.setValueAtTime(0, ac.currentTime);
        g.gain.linearRampToValueAtTime(gainVal, ac.currentTime + 6);
        musicNodes.push(o, g, filter);
      }
      makeShimmer(440, 0.022);
      makeShimmer(659.3, 0.015);
      makeShimmer(880, 0.010);

      // Layer 3: sparse chime melody (schedules random notes every 3-8s)
      function scheduleChime() {
        if (!musicScheduled) return;
        const ac2 = getCtx();
        const t = ac2.currentTime + 0.05;
        const freq = CHIME_SCALE[Math.floor(Math.random() * CHIME_SCALE.length)];
        const mult = Math.random() < 0.3 ? 2 : 1; // occasional octave jump
        const f = freq * mult;
        const dur = 1.8 + Math.random() * 2.4;
        const gainPeak = 0.055 + Math.random() * 0.04;

        const o = ac2.createOscillator();
        const g = ac2.createGain();
        const rev = ac2.createDelay(0.6);
        const revG = ac2.createGain();
        rev.delayTime.value = 0.38;
        revG.gain.value = 0.28;

        o.type = 'sine';
        o.frequency.setValueAtTime(f, t);
        g.gain.setValueAtTime(0.001, t);
        g.gain.linearRampToValueAtTime(gainPeak, t + 0.04);
        g.gain.exponentialRampToValueAtTime(0.001, t + dur);

        o.connect(g);
        g.connect(musicGain);
        g.connect(rev); rev.connect(revG); revG.connect(musicGain);
        o.start(t); o.stop(t + dur + 0.1);

        const nextIn = 2800 + Math.random() * 5200;
        setTimeout(scheduleChime, nextIn);
      }
      setTimeout(scheduleChime, 1500 + Math.random() * 3000);

      // Layer 4: subtle sub-bass pulse (slow rhythm, ~0.12 Hz)
      function schedulePulse() {
        if (!musicScheduled) return;
        const ac2 = getCtx();
        const t = ac2.currentTime;
        const o = ac2.createOscillator();
        const g = ac2.createGain();
        o.type = 'sine';
        o.frequency.value = 36 + Math.random() * 10;
        g.gain.setValueAtTime(0.001, t);
        g.gain.linearRampToValueAtTime(0.14, t + 0.8);
        g.gain.exponentialRampToValueAtTime(0.001, t + 3.5);
        o.connect(g); g.connect(musicGain);
        o.start(t); o.stop(t + 4);
        setTimeout(schedulePulse, 7000 + Math.random() * 5000);
      }
      setTimeout(schedulePulse, 3000);

      musicPlaying = true;
      updateMusicBtn();
    }

    function stopMusic() {
      musicScheduled = false;
      musicPlaying = false;
      musicNodes.forEach(n => { try { n.stop ? n.stop() : n.disconnect(); } catch(e){} });
      musicNodes = [];
      updateMusicBtn();
    }

    function toggleMusic() {
      if (musicPlaying) {
        stopMusic();
      } else {
        startMusic();
      }
    }

    function updateMusicBtn() {
      const btn = document.getElementById('musicToggleBtn');
      if (!btn) return;
      if (musicPlaying) {
        btn.textContent = 'ðŸ”Š';
        btn.classList.add('playing');
        btn.title = 'Music: On';
      } else {
        btn.textContent = 'ðŸ”‡';
        btn.classList.remove('playing');
        btn.title = 'Music: Off';
      }
    }

    return { sfxClick, toggleMusic, startMusic, stopMusic, updateMusicBtn };
  })();

  // Wire up music button
  document.getElementById('musicToggleBtn').addEventListener('click', () => {
    Audio.toggleMusic();
  });

  // Wire UI click sounds to all buttons (delegated)
  document.addEventListener('pointerdown', (e) => {
    const btn = e.target.closest('button, .skillNode, .planetBtn, [data-prestige-pid], [data-prestige-upg], [data-buy], [data-warp]');
    if (btn && !e.target.closest('#clickArea')) {
      Audio.sfxClick();
    }
  }, { capture: true });

})();
</script>
</body>
</html>
